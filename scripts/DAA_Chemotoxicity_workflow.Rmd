---
title: "DAA_Benchmarking_CRC_ChemoToxicity_Report.Rmd"
author: "Elsa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    highlight: 'haddock'
    theme: paper
    df_print: paged
    number_sections: true
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

# Introduction

The microbiome, defined as the complex community of diverse
microorganisms that inhabit the human body, along with their area of
influence (including interactions, metabolites, and genetic material),
has recently gained significant attention due to its profound impact on
health and disease. As highlighted by Hou et al. (2022), the microbiota
composition is diverse and differs between different sites of the body
(e.g., the gastrointestinal system, skin, mouth, oral cavity,
respiratory system, or reproductive system). Among these, the gut
microbiome plays a crucial role in maintaining homeostasis. However, an
imbalance in the microbiota (dysbiosis or loss of homeostasis) can lead
to the development of gastrointestinal diseases, such as colorectal
cancer (CRC).

Consequently, a significant concern exists about the potential effects
of antibiotics and other medications on cancer therapy due to their
bidirectional impact on the microbiota composition. This is the goal of
this research, in which we are trying to understand if a potential
bacteria or bacterial cluster are present or absent in our two groups of
colorectal cancer, classified by chemotherapy treatment toxicity.

## Cohort characteristics

Between October 2017 and April 2021, we prospectively enrolled 36 adults
with histologically confirmed colorectal cancer at the University
Hospital Complex of A Coruña (Spain). One faecal sample targeting the
16S rRNA V3–V4 region was collected from each patient before the first
chemotherapy cycle; antibiotics and probiotics were prohibited for the
preceding four weeks. All patients started a doublet of oxaliplatin (OX)
plus 5-fluorouracil (5-FU, FOLFOX-like) and/or radiotherapy.

## Toxicity Variable Design

For this reason, our oncologist designed the toxicity variable following
the next criteria: Clinical metadata were extracted from the electronic
record and merged with the microbiome profiles. The primary outcome is a
dichotomous toxicity target variable: low ($n=11$) versus severe
($n=25$), defined by CTCAE v5.0 together with a $\ge 20\,\%$
chemotherapy dose reduction or suspension of any of 5-FU and/or OX.
Absence of systemic chemotherapy was the sole exclusion criterion,
yielding the present cohort of 36 patients. Detailed coding rules and
extended baseline characteristics are provided in Supplementary Table S1
of this paper research.

# Research Questions

RQ1: Would there be similarities among the DAA methods outputs applying
different microbiome data transformations?

RQ2: Would there be similarities among the DAA methods' outputs with and
without previous prevalence filtering criteria?

RQ3: Could it be possible to identify differential features in terms of
their abundance between two toxicity groups? (The groups of study
variables were defined under the criteria of oncologists).

<!-- *Legend*: [*] Conclusion · [!] Limitation · [R] Key Result · [M] Methodological Note · [>>] Future Work -->

# Libraries

<!-- ```{r libraries, include=TRUE, message=FALSE, echo=FALSE, warning=FALSE,  class.source = 'fold-show'} -->

```{r setup, include=FALSE}

library(knitr) # dynamic reporting in r
# knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=8)
# knitr::opts_knit$set(progress = TRUE, verbose = TRUE)
# knitr::opts_chunk$set(error = TRUE, message = TRUE, warning = TRUE)
# knitr::knit_hooks$set(before = function(options) {
#   cat(sprintf("\n--- INITIATING CHUNK: %s ---\n", options$label %||% "<sin_label>"))
# })
dir.create("figures_DAA", showWarnings = FALSE, recursive = TRUE)

knitr::opts_chunk$set(
  message = FALSE, warning = FALSE, 
  echo = FALSE, fig.width = 15, fig.height = 12,
  error = TRUE, message = TRUE, warning = TRUE,
  dev = "png",          # output device
  dpi = 150,            # resolution
  fig.path = "figures_DAA/",   # folder name
  fig.ext = "png",      # figure format
  fig.retina = 1        # set to 2 if you want figures with better resolution but less size and heavier
)

knitr::opts_knit$set(progress = TRUE, verbose = TRUE)

`%||%` <- function(x, y) if (is.null(x)) y else x
knitr::knit_hooks$set(before = function(options) {
  cat(sprintf("\n--- INITIATING CHUNK: %s ---\n", options$label %||% "<sin_label>"))
})

# Load necesssary packages
# To avoid packages messages start up Messages
suppressPackageStartupMessages({
library(kableExtra) # table manipulation
library(rmarkdown) # r markdown document conversion
library(markdown) # markdown rendering for r
library(readxl)  # read excel files
library(devtools) # tools to make developing r packages easier
library(xtable) # export table to latex or HTML
library(data.table) # expression of data.frame
library(reshape2)  
library(formatR)
library(qiime2R) # import qza files from QIIME2 output
## data manipulation
library(tidyr)
library(purrr)
library(plyr) # tools for splitting, applying and combining data
library(dplyr) # data manipulation
library(ggrepel)  
# library(tidyverse) # data manipulationlibrary(glue) # interpreted strings litterals
library(janitor) # simple tools for examining and cleaning dirty data
library(stringr)
library(gtools)
library(ggh4x)  
## data visualization
library(patchwork)
library(readr)
library(VennDiagram)
library(RColorBrewer)
library(egg)
library(ggalluvial)
library(reprtree) # visualization 
library(ggplot2) # visualization 
library(camcorder) # to save image to final using without changes
library(plotly) # visualization 
library(randomcoloR)
library(colorblindcheck) # R colors suitable for users with color vision deficiencies
library(ggvenn)
library(patchwork)
library(glue)
## microbiome specific libraries
suppressPackageStartupMessages({
  library(phyloseq)
  library(tidytree)
})
library(vegan) # alpha and beta diversity
library(microbiomeMarker) # ANCOM-BC, LEfSe, ALDEx2
library(microbiome)
library(ANCOMBC)
library(ALDEx2)
library(DESeq2)
library(LinDA)
library(GUniFrac) # ZicoSeq
library(pheatmap)
library(tidyr)
library(pheatmap)
library(tibble)
library(ggalluvial)
library(viridis)
library(ggraph)
library(igraph) # data visualization
library(scales)
library(ggtree)
library(ape)
library(tibble)
library(igraph)
library(ggraph)
library(tidygraph)
})


# Functions script
# In case of problem loading the script file:
# fun_path <- "/home/elsa/feature_data_mining/paper_comparacion_herramientas/DAA_functions.R"
# if (!file.exists(fun_path)) {
#   stop("functions_pipe.R not found at: ", normalizePath(fun_path, winslash = "/"))
# }

source("/home/elsa/feature_data_mining/paper_comparacion_herramientas/github/DAA_functions.R", local = knitr::knit_global(), echo = FALSE, print.eval = FALSE)
ls()


```

# Data


Importing the phyloseq object: 

```{r data, include=FALSE}


# physeq objects
BASE_DIR = "/home/elsa/feature_data_mining/paper_comparacion_herramientas/github"
metadata_file <- as.character(glue("{BASE_DIR}/non-ffpe_metadata_tox_2024.csv")) 

tree_file <- as.character(glue("{BASE_DIR}/data/tree.nwk"))

# RDS file
derep_ps <- readRDS("/home/elsa/feature_data_mining/paper_comparacion_herramientas/github/derep_ps_16SGlobalpaper.RDS")
derep_ps
# ps_fixed <- phyloseq(otu_table(derep_ps), tax_table(derep_ps), sample_data(metadata))



```

```{r derep_ps }
derep_ps
```


All decontaminat steps were done in the previous steps of the paper (NOTE(1)), so this ps object has no contaminant included.
As the derep_ps objects comes from another paper (NOTE (1)), the sample data contains some extra columns. 

**Loading and Cleaning Data**

Since some patients had replicated samples, we aggregated their measurements using the median.


```{r tox_severe_patients , include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
set.seed(123)

TREE = read_tree(tree_file)

metadata <- read.table(metadata_file, header = TRUE, sep = "\t") # toxicity information include inside derep_ps object
# colnames(metadata)
# from: https://github.com/joey711/phyloseq/issues/1066

# removing pacients without toxicity information
tox_ps <-  subset_samples(derep_ps, !is.na(TOX_SEVERA)) # subset_samples(physeq, !is.na(TOX_SEVERA))
# tox_ps

tox_ps_metadata <- sample_data(tox_ps) # extract the metadata to merge in the new physeq final object

# remove duplicates rows 
cleaned_metadata_tox <- tox_ps_metadata[!duplicated(tox_ps_metadata$subject), ]
# naming with subject column
sample_names(cleaned_metadata_tox) <- cleaned_metadata_tox$subject

# merging replicates: https://joey711.github.io/phyloseq/merge.html#merge_samples
print("**************************")
print("Merging replicates")
print("**************************")

tox_ps_merged <- merge_samples(x = tox_ps, "subject", fun = "median")
tox_ps_merged
print("**************************")

# update metadata
tox_ps_final <- phyloseq(otu_table(tox_ps_merged), tax_table(tox_ps_merged), cleaned_metadata_tox, TREE, verbose=FALSE)

# as factor
sample_data(tox_ps_final)$TOX_SEVERA <- factor(sample_data(tox_ps_final)$TOX_SEVERA)

# removing patient 112 for inconsistency

samples_to_keep <- sample_names(tox_ps_final) != "ccr112"
tox_ps_final <- prune_samples(samples_to_keep, tox_ps_final)


```

<!-- ### Factor columns -->

Transform relevant variables (toxicity variable and gender) into factors

```{r tox_ps_final_factors , include=FALSE, message=FALSE, warning=FALSE}
sample_data(tox_ps_final)$TOX_FACTOR <- ifelse(sample_data(tox_ps_final)$TOX_SEVERA == 0, "low", "sev")
# print(sample_data(tox_ps_final)$sex) #  "male", "female"
# combining tox with gender
sample_data(tox_ps_final)$tox_gender <- paste0(sample_data(tox_ps_final)$TOX_FACTOR, "_", sample_data(tox_ps_final)$sex)

```

# Pre-Analysis 

## Prevalence filter

The first step is to evaluate the number or retained taxa applying
different prevalent values (it should be present in more than 1 person).
For that, we should take in mind that we have a total of 36 patients.
Then, if we extract the 1'% of 100 individuals, and adjusted it to our
N, the prevalence would be associated to 3–4 individuals (3.6
individuals exactly). Trying different prevalence values:

-   With 0.01--1: 3022 taxa are retained, but are present in less than
    one person.
-   With 3.6 and 5: 1045 taxa are retained, and are also presented in
    3--4 individuals (prev=3.6) and in 1.8 individuals (prev=5).

```{r prevalence_filtering, , include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}

# Thresholds
thresholds <- c(0.01, 0.05, 0.1, 1, 3.6, 5, 10) / 100  

# -------------------------------------
# Prevalence filtering function
# -------------------------------------

filtering_prevalence <- function(tox_ps_final, threshold) {
    prevalence <- apply(otu_table(tox_ps_final), 2, function(x) sum(x > 0) / length(x))
  otus_to_keep <- prevalence >= threshold
  ps_filt <- prune_taxa(otus_to_keep, tox_ps_final)
  return(ps_filt)
}

# Applying the filtering for each threshold and evaluate the impact
results_prevalence_filt <- lapply(thresholds, function(threshold) {
  ps_filt <- filtering_prevalence(tox_ps_final, threshold)
  num_otus <- ntaxa(ps_filt)
  diversidad <- estimate_richness(ps_filt)
  list(threshold = threshold, num_otus = num_otus, diversidad = diversidad)
})

# Results evaluation
results_prevalence_filt


```

**Prevalence:5% (1045 taxa)**

After testing multiple prevalence thresholds, a 5% cutoff was chosen to maintain a meaningful number of taxa (1,045) while ensuring their presence in roughly two out of 36 patients.

```{r prev5percentage, include=FALSE,  message=FALSE, warning=FALSE} 

# physeq_filtered <- prune_taxa(taxa_to_keep, tox_ps_final) 
physeq_filtered <- phyloseq::filter_taxa(
tox_ps_final,
function(x) sum(x > 0) > (0.05*length(x)), TRUE) 

physeq_filtered # Almost 2 people

```


## Some metadata stats

**DataFrame summary related a selection of relevant variables**

The goal of this step is perform a pre-understanding of our data and the
relevant variables that could be use in further steps.

```{r relevant_variables_df_summary, include=FALSE,  message=FALSE, warning=FALSE}
# Viridis palette for colorblind individuals
my_palet <- viridis::viridis_pal(option = "D")(10)


# Calculating the total number of each type of symptom 

# datos <- sample_data(physeq)
data_vis <- as(sample_data(tox_ps_final), "data.frame")
data_vis <- data_vis %>%
  filter(QTP > 0 & !is.na(QTP))  %>%
  group_by(CODIGO.CRCBIOME, sex, age_group, simplified_location, QTP, has_affected_lymph_nodes, has_big_tumor, has_metastasis, RED_FP, RED_OXALI, TOX_SEVERA) %>%
  # group_by(biosample_name, QTP, RED_FP, RED_OXALI, EMESIS, DIARREA, EPP, NEUROTOX, NEUTROPENIA, TROMBOPENIA, TOX_SEVERA) %>%
  summarize(Total = n()) 

kable(data_vis) %>%
  kable_styling()

```

**Genus Level Glom Taxa (unfiltered ps)**
Glom taxa to Genus level using our phyloseq object (tox_ps_final)

```{r creating_toxps_genus ,  message=FALSE, warning=FALSE}

tox_ps_final_genus <- suppressWarnings(
  tax_glom(tox_ps_final, taxrank = "Genus")
)

```

**Plot: Toxicity associated to gender distribution**

NOTE: This code was adapted from Conde-Perez et al. (2024) paper,
referenced in NOTES section.

A quick by to our dataset, to see the distribution by sex and age range in
our two-toxicity classes. In the following plot the subject toxicity associated 
density based on sex and age can be seen per Toxicity variable (TOX_SEVERA):

```{r metadata_stats, message=FALSE, warning=FALSE}
# Get metadata for each patient
subject_metadata <- data.frame(sample_data(tox_ps_final)[,c("subject","age","sex","localization","simplified_location","age_group","sample.type", "TOX_SEVERA")])
rownames(subject_metadata) <- NULL
subject_metadata <- subject_metadata %>% dplyr::distinct()
subject_metadata$TOX_SEVERA <- factor(subject_metadata$TOX_SEVERA, levels = c(0,1), labels=c('Low_Tox', 'Severe_Tox'))


# Sex density
temp <- list(
  female_Lowtox=length(subset(subject_metadata, TOX_SEVERA=='Low_Tox' & sex=="female")$sex),
  male_Lowtox=length(subset(subject_metadata, TOX_SEVERA=='Low_Tox' & sex=="male")$sex),
  female_Sevtox=length(subset(subject_metadata, TOX_SEVERA=='Severe_Tox' & sex=="female")$sex),
  male_Sevtox=length(subset(subject_metadata, TOX_SEVERA=='Severe_Tox' & sex=="male")$sex)
)

p <- ggplot(subject_metadata, aes(x = age)) +
  geom_density(aes(color = sex, fill = sex),
               position = "identity", alpha = 0.3) +
  facet_wrap(~TOX_SEVERA) +
  scale_color_manual(values = c("#DDCC77FF", "#004488FF")) +
  scale_fill_manual(values = c("#DDCC77FF", "#004488FF")) +
  ggtitle(glue("Age distribution - (Low Tox: M={temp$male_Lowtox}, F={temp$female_Lowtox} | Severe Tox: M={temp$male_Sevtox}, F={temp$female_Sevtox})")) +
  theme_bw()
p

# c("Low_tox" = "#22A884FF", "Severe_tox" = "#440154FF")
# c("#00AFBB", "#E7B800")


```
This plot compares the age distribution by toxicity group and by sex. In 
the Low_Tox panel, the sample is markedly male-skewed (2 females vs 9
males). Ages in this group are mostly older: one of the two females
falls in the 50–60 range, whereas nearly all remaining observations lie
between 60 and 90 years. In the Severe_Tox panel, the sex ratio is more
balanced (11 females vs 14 males), and both sexes skew older, with most
individuals aged ≥70 years. These counts and age ranges refer to the
individuals shown in the plot.



# Sample Justification and Power Analysis

After reviewing various methodological options, we decided to perform a GPower 
analysis. The GPower results supported the relevance of our findings within 
the cohort, highlighting that the microbiome's significant differences observed 
in one of the two toxicity groups are likely due to the presence of strong
abundance shifts that are detectable even with a relatively small sample
size (36 patients).

Additional tools and R packages, such as micropower, were also
considered. However, micropower could not be applied in our case due to
its reliance on simulated data rather than empirical input.

NOTE: micropower is a specialized R package designed to estimate
statistical power and sample size in microbiome studies. It helps
researchers determine whether their cohort size is sufficient to detect
differences in the relative abundances of bacterial taxa.


# Results: *Differential Abundance Analysis – Ensemble Benchmarking*

As the next step, we performed a benchmarking of several differential
abundance analysis (DAA) methods to identify microbial taxa
significantly associated with one of the two study groups. Patients were
categorized based on the severity of chemotherapy-related toxicity, as
assessed by oncologists: those who experienced mild or manageable
toxicity were assigned to the low toxicity group, while those who
experienced severe toxicity and/or required dose reduction or
discontinuation of one of the two treatment regimens were assigned to
the severe toxicity group. More information is available in the paper.

Given the variability in statistical assumptions and performance across
DAA methods, we implemented an ensemble consensus approach to increase
robustness and reduce method-specific biases. This approach involved
comparing the outputs of multiple DAA methods and identifying
consistently detected taxa (i.e. those that appear as significantly
differential abundant across all methods). These overlapping results
were considered the most reliable candidates for biologically meaningful
group-specific microbial signatures.

The main objective of this ensemble strategy was to highlight consensus
taxa and assess the reproducibility of findings across different
analytical frameworks, thereby enhancing the overall validity of our
results.

**Methods and Strategy**

In this section, we apply a diverse set of differential abundance
analysis (DAA) methods, each based on different statistical assumptions,
data transformations, and normalization strategies. Despite their
methodological differences, all share a common goal: to identify taxa
that show significant differences in abundance based on a grouping
variable.

We evaluate each method under multiple conditions:

-   **With and without prevalence filtering**.
-   **With and without false discovery rate (FDR) control**, using the
    Benjamini–Hochberg (BH) correction.

A distinctive aspect of our study is the clinical definition of the
comparison groups. Unlike conventional case-control designs, our study
focuses on two groups of CRC patients defined by **chemotherapy-induced
toxicity**:

-   **Low toxicity group**: patients who experienced mild or manageable
    toxicity
-   **Severe toxicity group**: patients who experienced severe toxicity
    and/or required dose reduction or discontinuation of treatment

This grouping was based on clinical evaluations and treatment
modifications, and reflects a real-world, treatment-driven
classification. The grouping variable used for DAA is therefore both
clinically meaningful and directly relevant to the outcome of interest.

## *(1) Without previous prevalence filtering evaluating Genus and ASV levels*

In this unfiltered approach, we are using the non-filter by prevalence
phyloseq object named: tox_ps_final_genus. For biomarker discover
purpose in our clinical prediction, we aggregated to genus level.

<!-- ```{r tox_ps_final_genus,  message=FALSE, warning=FALSE} -->
<!-- tox_ps_final_genus <- suppressWarnings( -->
<!--   tax_glom(tox_ps_final, taxrank = "Genus") -->
<!-- ) -->

<!-- ``` -->

### ANCOM-BC (NO BH correction and prevalence=0)

We first applied the **ANCOM-BC** method (`ancombc` function) to
identify differentially abundant taxa between the two toxicity groups.
For this initial analysis, we used the following settings:

-   **No prevalence filtering** (`prv_cut = 0`)
-   **No multiple testing correction** (`p_adj_method = "none"`)
-   **qval set to 0.05** (`qval_cut = 0.05`)
-   **Significance threshold**: `alpha = 0.05`
-   **Covariates** included in the model: `target_variables`. Only used
    in the covariates section.

The analysis was performed at the `ancom_target` taxonomic level using
parallel processing with 8 cores (`n_cl = 8`).\
We used the argument `conserve = TRUE` to apply conservative variance
estimates.

NOTE: As we want to no aggregate due previous aggregation to genus
level, then ANCOM-BC target_level parameter should be set at "ASV". See
code for further details.

NOTE (2): The ancombc global function code was adapted from the paper:
16S, Conde-Pérez et al (2024). Reference in NOTE (1).




```{r ancombc_noprev_noBH, include=FALSE, class.source = 'fold-show', echo=FALSE, message=FALSE}

set.seed(123)

# Run on each level

proc_genus_ancombc <- NULL
proc_asv_ancombc <- NULL

target_variables = c("TOX_SEVERA")

# presettings: In this case, prevalence would be settled to 0. Go to DAA_functions
# pre-genus aggregation
proc_genus_ancombc_nPnB <- run_ancombc_nPnB(tox_ps_final,  "Genus", c("TOX_SEVERA"), prv_cut=0)
proc_asv_ancombc_nPnB <- run_ancombc_nPnB(tox_ps_final, "ASV", c("TOX_SEVERA"), prv_cut=0)



df_fig_nopre_noBH <- rbind(proc_genus_ancombc_nPnB, proc_asv_ancombc_nPnB)
df_fig_nopre_noBH$target_level <- factor(df_fig_nopre_noBH$target_level, levels = c("Genus","ASV"))
as.data.frame(df_fig_nopre_noBH)


```

```{r ancombc_noprev_nobh_pvals, include=FALSE,  message=FALSE, warning=FALSE}

ancombc_bh_pvals_nopr_noBH <-  as.data.frame(df_fig_nopre_noBH)$pval[as.data.frame(df_fig_nopre_noBH)$qval < 0.05]
# ancombc_bh_pvals_nopr_noBH


ancomb_nopr_noBH_features <- as.data.frame(df_fig_nopre_noBH)$taxon_id
ancomb_nopr_features_tox_noBH <- as.data.frame(df_fig_nopre_noBH)[, c("taxon_id", "orientation", "qval")]


```

<!-- Remove entries that are unclassified bacteria or incertae sedis and plot the results, which show an increased abundance of Parvimonas, Fusobacterium and Bacteroides fragilis in CRC faeces: -->

**ANCOM-BC No Prevalence-NoBH Plot**

```{r ancombc_visualization_noprev_noBH, fig.height=10}

set.seed(123)


# Remove  organisms
df_fig_nopre_noBH <- df_fig_nopre_noBH[!grepl("Incertae|uncultured", df_fig_nopre_noBH$taxon_id),]

# Plot
p <- NULL
p <- ggplot(data = subset(df_fig_nopre_noBH), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
  scale_alpha_manual(values=get_scale_alpha_values(df_fig_nopre_noBH$qval.txt)) +
  geom_bar(stat = "identity",
           position = position_dodge2(width = 0.9, preserve = "single")) +
  geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
                position = position_dodge2(width = 0.9, preserve = "single"),
                color = "gray36") +
  geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
            position = position_dodge2(width = 0.9, preserve = "single")) +
  # geom_vline(xintercept = (1:length(df_fig_nopre_noBH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
  geom_hline(yintercept = 0, alpha=0.5) +
  facet_wrap(~target_level, scale="free_y", ncol=1) +
  labs(x = NULL, y = "Log fold change", title = "") +
  scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
  # scale_fill_discrete(name = NULL) +
  # scale_color_discrete(name = NULL) +
  # scale_x_discrete(limits = unique(df_fig_nopre_noBH$taxon_id)) +
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
    axis.text.y=element_text(size=10),
    axis.title.y=element_text(size=10, face = "italic"),
    legend.text=element_text(size=8)
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_blank(),
    # panel.border = element_blank(),
    # panel.background = element_blank(),
    # axis.ticks.x=element_blank()
    # axis.line = element_line(colour = "black")
  )
p
# ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)
```

The results provide an initial, unadjusted list of candidate taxa
associated with toxicity status, to be compared with other DAA methods
in subsequent steps.

```{r}



res_ancom_noprev_noBH_df <- df_fig_nopre_noBH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level == "Genus") %>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "no",
    BH           = "no",
    herramienta  = "ANCOMBC"
  ) %>%
  filter(abs(logFC) > 1 & pvalue  < 0.1)  #< 0.05)

res_ancom_noprev_noBH_df



res_ancom_noprev_ASV_noBH_df <- df_fig_nopre_noBH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level == "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "no",
    BH           = "no",
    herramienta  = "ANCOMBC"
  ) %>%
  filter(abs(logFC) > 1 & pvalue  < 0.1)  #< 0.05)

res_ancom_noprev_ASV_noBH_df

```

### ANCOM-BC (BH correction and prevalence=0)

We then applied the **ANCOM-BC** method (`ancombc` function) to identify
differentially abundant taxa between the two toxicity groups, this time
incorporating false discovery rate (FDR) control via
**Benjamini–Hochberg (BH) correction**. The parameters used were:

-   **No prevalence filtering** (`prv_cut = 0`)
-   **FDR correction applied** (`p_adj_method = "BH"`)
-   **Significance threshold**: `alpha = 0.05`
-   **Covariates** included in the model: `target_variables`

The analysis was conducted at the `ancom_target` taxonomic level using 8
processing cores (`n_cl = 8`) and conservative variance estimation
(`conserve = TRUE`).

NOTE: As we want to no aggregate due previous aggregation to genus
level, then ANCOM-BC target_level parameter should be set at "ASV". See
code for further details. So, we also run the main function on each 
taxonomic level with a prevalence cut of 0:

```{r ancombc_noprev_BH, include=FALSE, class.source = 'fold-show', echo=FALSE, message=FALSE}

set.seed(123)

# Run on each level
proc_genus_ancombc <- NULL
proc_asv_ancombc <- NULL

proc_genus_ancombc_nPB <- run_ancombc_nPB(tox_ps_final,  "Genus", c("TOX_SEVERA"), prv_cut=0)
proc_asv_ancombc_nPB <- run_ancombc_nPB(tox_ps_final, "ASV", c("TOX_SEVERA"), prv_cut=0)



df_fig_nopre_BH <- rbind(proc_genus_ancombc_nPB, proc_asv_ancombc_nPB)
df_fig_nopre_BH$target_level <- factor(df_fig_nopre_BH$target_level, levels = c("Genus","ASV"))
as.data.frame(df_fig_nopre_BH)

```

```{r ancombc_noprev_BH_filter, include=FALSE,  message=FALSE, warning=FALSE}

set.seed(123)

ancombc_bh_pvals_nopr_BH <-  as.data.frame(df_fig_nopre_BH)$pval[as.data.frame(df_fig_nopre_BH)$qval < 0.05]
# ancombc_bh_pvals_nopr_BH


ancomb_nopr_BH_features <- as.data.frame(df_fig_nopre_BH)$taxon_id
ancomb_nopr_BH_features_tox <- as.data.frame(df_fig_nopre_BH)[, c("taxon_id", "orientation", "qval")]

```

<!-- Remove entries that are unclassified bacteria or incertae sedis and plot the results, which show an increased abundance of Parvimonas, Fusobacterium and Bacteroides fragilis in CRC faeces: -->

**ANCOM-BC No Prevalence-BH Plot**

```{r ancombc_visualization_BH, fig.height=10}

set.seed(123)

# Remove untrusted organisms
df_fig_nopre_BH <- df_fig_nopre_BH[!grepl("Incertae|uncultured", df_fig_nopre_BH$taxon_id),]

# Plot
p <- NULL
p <- ggplot(data = subset(df_fig_nopre_BH), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
  scale_alpha_manual(values=get_scale_alpha_values(df_fig_nopre_BH$qval.txt)) +
  geom_bar(stat = "identity",
           position = position_dodge2(width = 0.9, preserve = "single")) +
  geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
                position = position_dodge2(width = 0.9, preserve = "single"),
                color = "gray36") +
  geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
            position = position_dodge2(width = 0.9, preserve = "single")) +
  # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
  geom_hline(yintercept = 0, alpha=0.5) +
  facet_wrap(~target_level, scale="free_y", ncol=1) +
  labs(x = NULL, y = "Log fold change", title = "") +
  scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
  # scale_fill_discrete(name = NULL) +
  # scale_color_discrete(name = NULL) +
  # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) +
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
    axis.text.y=element_text(size=10),
    axis.title.y=element_text(size=10, face = "italic"),
    legend.text=element_text(size=8)
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_blank(),
    # panel.border = element_blank(),
    # panel.background = element_blank(),
    # axis.ticks.x=element_blank()
    # axis.line = element_line(colour = "black")
  )
p
# ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)
```

These results reflect a more stringent significance threshold compared
to the unadjusted analysis, allowing us to identify taxa that remain
robustly associated with toxicity group after correcting for multiple
comparisons.

```{r ancombc_noprev_BH_res_df}

set.seed(123)

res_ancom_noprev_BH_df <- df_fig_nopre_BH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level != "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "no",
    BH           = "yes",
    herramienta  = "ANCOMBC"
  ) %>%
  filter(abs(logFC) > 1 & pvalue < 0.1) # 0.05



res_ancom_noprev_ASV_BH_df <- df_fig_nopre_BH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level == "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "no",
    BH           = "yes",
    herramienta  = "ANCOMBC"
  ) %>%
  filter(abs(logFC) > 1 & pvalue < 0.1) # 0.05


```

### ALDEx2 (Official Package)

ALDEx2 (ANOVA-Like Differential Expression) is a method designed to
identify differences in feature abundance between groups in
compositional data, such as those generated by microbiome sequencing
(e.g., 16S rRNA or metagenomics). It works by generating multiple Monte
Carlo instances from a Dirichlet distribution to account for technical
variability, then applying a centered log-ratio (CLR) transformation to
the data.

Statistical tests (e.g., Welch’s t-test or Wilcoxon) are performed on
these transformed values to detect differential abundance. In our case,
as we only have two groups to evaluate, a t-test is performed. This
statistical approach returns a p-value (Welch) information (we.ep) and a
q-value or correction over p-value through BH (we.eBH). These p-values
and q-values come from the Monte Carlo estimation in CLR transformed
abundance values. Note\*

ALDEx2 also estimates effect size (log-fold change) and includes
adjusted p-values (e.g., via Benjamini-Hochberg correction) for multiple
testing. Its main strength lies in properly addressing the compositional
nature of relative abundance data, reducing the risk of false positives
compared to traditional methods.

Note\*: In case you have more than two groups to evaluate, then Wilcoxon
(kw) test should be tested.

```{r aldex2_noprev,  message=FALSE, warning=FALSE}

set.seed(9531)


counts <- as(otu_table(tox_ps_final_genus), "matrix")

# # samples must be columns
# if (taxa_are_rows(tox_ps_final)) {
#   counts <- t(counts)  # this doesn't work
# }

tox_conds <- as.character(sample_data(tox_ps_final_genus)$TOX_SEVERA)
names(tox_conds) <- colnames(t(counts))
identical(names(tox_conds), colnames(t(counts)))  # Debe dar TRUE

aldex_noprev_r <- aldex.clr(t(counts), conds= tox_conds, denom="all") #, test="t", effect=TRUE, denom="all")
aldex_noprev_result <- aldex.ttest(aldex_noprev_r, paired.test = FALSE, verbose =TRUE)
aldex_noprev_result_effect <- aldex.effect(aldex_noprev_r, CI=TRUE,verbose = TRUE)
#print(aldex_result)

# As ALDEx2 return the raw pvalues and BH adjusted pvalues, we are checking:
print("Filter alpha 0.05")
table(
  uncorrected = aldex_noprev_result$we.ep < 0.05,
  corrected = aldex_noprev_result$we.eBH < 0.05
)

# with 0.1
print("Filter alpha 0.1")
table(
  uncorrected = aldex_noprev_result$we.ep < 0.1,
  corrected = aldex_noprev_result$we.eBH < 0.1
)



```

**Plot: ALDEx2 No Prevalence-NoBH Plot**

```{r aldex_noprev_plot}


# transform to df and create feature column with rownames
df_clr <- as.data.frame(aldex_noprev_result) %>% tibble::rownames_to_column("feature")
df_eff <- as.data.frame(aldex_noprev_result_effect) %>% tibble::rownames_to_column("feature")

# columns join
aldex_noprev_final <- full_join(df_clr, df_eff, by = "feature")

# rename the rownames with the features
rownames(aldex_noprev_final) <- aldex_noprev_final$feature
aldex_noprev_final$feature <- NULL


df_plot <- aldex_noprev_final %>%
  dplyr::mutate(
    taxon_id = rownames(.),
    lfc = diff.btw,
    pval = we.ep,
    qval = we.eBH,
    pval_sig = pval < 0.05,
    qval_sig = qval < 0.05,
    qval.txt = ifelse(qval < 0.05, "*", ""),  #
    direction = ifelse(lfc > 0, "Sev", "Low"),
    orientation = ifelse(lfc > 0, 1, -1),
    se = 0  # ALDEx2 doesn't give this value, it can be set to 0 or calculate externally
  )


tax_df <- as.data.frame(tax_table(tox_ps_final_genus))
tax_df$taxon_id <- rownames(tax_df)

df_plot <- dplyr::left_join(df_plot, tax_df, by = "taxon_id")

# facet wrap by 'Genus':
df_plot$target_level <- df_plot$Genus


df_plot$qval.txt <- cut(df_plot$qval,
                        breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                        labels = c("***", "**", "*", "-"))

# must be a factor
df_plot$qval.txt <- factor(df_plot$qval.txt, levels = c("***", "**", "*", "-"))

df_pval_only <- df_plot %>% filter(pval_sig)
df_qval <- df_plot %>% filter(pval_sig & qval_sig)



plot_aldex_barplot(df_pval_only)  # Muestra candidatos con p < 0.05


if (nrow(df_qval) > 0) {
  plot_aldex_barplot(df_qval)
} else {
  message("⚠️ No features with p < 0.05 y q < 0.05. So, no plot would be generated.")
}       # Muestra confirmados con p < 0.05 y q < 0.05


```

Filtering using a pval of 0.1 to see the retained at 0.05 and 0.01
pvalues.

```{r aldex_noprev_res_df, message=FALSE, warning=FALSE}


# Genus vector to create bacteria_names 
bacteria_names <- tax_table(tox_ps_final_genus)[rownames(aldex_noprev_final), "Genus"]

# Checking NAs and rename with ASV IDs if NA appears
bacteria_names <- as.character(bacteria_names)
bacteria_names[is.na(bacteria_names)] <- rownames(aldex_noprev_final)[is.na(bacteria_names)]

df_aldex <- as.data.frame(aldex_noprev_final) %>%
  # rownames_to_column("feature") %>%
  dplyr::rename(
    logFC = diff.btw,
    pval = we.ep,
    qval = we.eBH
  )

df_aldex$bacteria <- bacteria_names # column bacteria to df

# Adding extra columns for visualization 
res_aldex2_noprev_noBH_df <- df_aldex %>%
  dplyr::mutate(
    bacteria = bacteria,
    enrich_group = ifelse(logFC < 0, "0", "1"),
    direction = ifelse(enrich_group == "1", "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == "1", 1, -1),
    qval.txt = cut(qval, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",
    herramienta = "ALDEX2"
  )  %>%
  filter(pval < 0.1)
  # filter(pval < 0.05)

head(res_aldex2_noprev_noBH_df)




```
In the case of ALDEx2, no features returned q values lower than 0.1 or 0.05 (filtering criteria).

### **ASV ALDEx2**

```{r aldex2_noprev_ASV,  message=FALSE, warning=FALSE}

set.seed(9531)

counts <- as(otu_table(tox_ps_final), "matrix")

# #be sure that the columns are in the format required by ALDEx2
# if (taxa_are_rows(tox_ps_final)) {
#   counts <- t(counts)  # this doesn't work
# }

tox_conds <- as.character(sample_data(tox_ps_final)$TOX_SEVERA)
names(tox_conds) <- colnames(t(counts))
identical(names(tox_conds), colnames(t(counts)))  # Must be TRUE

aldex_noprev_ASV_r <- aldex.clr(t(counts), conds= tox_conds, denom="all") #, test="t", effect=TRUE, denom="all")
aldex_noprev_ASV_result <- aldex.ttest(aldex_noprev_ASV_r, paired.test = FALSE, verbose =TRUE)
aldex_noprev_ASV_result_effect <- aldex.effect(aldex_noprev_ASV_r, CI=TRUE,verbose = TRUE)
#print(aldex_result)

# As ALDEx2 return the raw pvalues and BH adjusted pvalues, we are checking:
print("Filter alpha 0.05")
table(
  uncorrected = aldex_noprev_ASV_result$we.ep < 0.05,
  corrected = aldex_noprev_ASV_result$we.eBH < 0.05
)

print("Filter alpha 0.1")
table(
  uncorrected = aldex_noprev_ASV_result$we.ep < 0.1,
  corrected = aldex_noprev_ASV_result$we.eBH < 0.1
)



```

**Plot(ASV): ALDEx2 No Prevalence-NoBH**

```{r aldex_noprev_ASV_plot}

# transform to df and create feature column with rownames
df_clr <- as.data.frame(aldex_noprev_ASV_result) %>% tibble::rownames_to_column("feature")
df_eff <- as.data.frame(aldex_noprev_ASV_result_effect) %>% tibble::rownames_to_column("feature")

# columns join
aldex_noprev_ASV_final <- full_join(df_clr, df_eff, by = "feature")

# rename the rownames with the features
rownames(aldex_noprev_ASV_final) <- aldex_noprev_ASV_final$feature
aldex_noprev_ASV_final$feature <- NULL


df_plot <- aldex_noprev_ASV_final %>%
  dplyr::mutate(
    taxon_id = rownames(.),
    lfc = diff.btw,
    pval = we.ep,
    qval = we.eBH,
    pval_sig = pval < 0.05,
    qval_sig = qval < 0.05,
    qval.txt = ifelse(qval < 0.05, "*", ""),  # O 
    direction = ifelse(lfc > 0, "Sev", "Low"),
    orientation = ifelse(lfc > 0, 1, -1),
    se = 0  # ALDEx2 doesn't give this value, it can be set to 0 or calculate externally
  )


tax_df <- as.data.frame(tax_table(tox_ps_final))
tax_df$taxon_id <- rownames(tax_df)

df_plot <- dplyr::left_join(df_plot, tax_df, by = "taxon_id")

# facet wrap by 'Genus':
df_plot$target_level <- df_plot$Genus


df_plot$qval.txt <- cut(df_plot$qval,
                        breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                        labels = c("***", "**", "*", "-"))

# must be a factor
df_plot$qval.txt <- factor(df_plot$qval.txt, levels = c("***", "**", "*", "-"))



df_pval_only <- df_plot %>% filter(pval_sig)
df_qval <- df_plot %>% filter(pval_sig & qval_sig)



plot_aldex_barplot(df_pval_only)  # p < 0.05 candidates


if (nrow(df_qval) > 0) {
  plot_aldex_barplot(df_qval)
} else {
  message("⚠️ No features with p < 0.05 y q < 0.05. So, no plot would be generated.")
}      


```

Filtering using a pval of 0.1 to see the retained at 0.05 and 0.01
pvalues.

```{r aldex_noprev_ASV_df}

# Genus vector to create bacteria_names 
bacteria_names <- tax_table(tox_ps_final)[rownames(aldex_noprev_ASV_final), "Genus"]

# Checking NAs and rename with ASV IDs if NA appears
bacteria_names <- as.character(bacteria_names)
bacteria_names[is.na(bacteria_names)] <- rownames(aldex_noprev_ASV_final)[is.na(bacteria_names)]

df_aldex <- as.data.frame(aldex_noprev_ASV_final) %>%
  # rownames_to_column("feature") %>%
  dplyr::rename(
    logFC = diff.btw,
    pval = we.ep,
    qval = we.eBH
  )

df_aldex$bacteria <- bacteria_names # column bacteria to df

# Adding extra columns for visualization 
res_aldex2_noprev_ASV_noBH_df <- df_aldex %>%
  dplyr::mutate(
    bacteria = bacteria,
    enrich_group = ifelse(logFC < 0, "0", "1"),
    direction = ifelse(enrich_group == "1", "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == "1", 1, -1),
    qval.txt = cut(qval, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",
    herramienta = "ALDEX2"
  )  %>%
  filter(pval < 0.1)
  # filter(pval < 0.05)





```

### DESeq2 no BH and BH

In accordance with DESeq2 authors' recommendations, we applied a
pre-filtering step to remove features with very low counts, particularly
given our relatively small sample size (i.e., ≤ 10 samples in the
smallest group). This filtering helps reduce memory usage, improves
computational efficiency, and enhances the interpretability of
downstream analyses such as PCA and dispersion plots by removing
uninformative features.

We employed the Wald test for differential expression analysis, as our
experimental design involves a binary comparison (two conditions in the
`TOX_SEVERA` variable). The Likelihood Ratio Test (LRT) is more
appropriate for more complex models or multi-factor designs, and thus
was not used here.

Finally, we compared raw *p*-values with those adjusted using the
Benjamini–Hochberg (BH) method for False Discovery Rate (FDR) control.
This comparison allows us to assess the number of features filtered out
by the multiple testing correction process, and to better understand the
trade-off between sensitivity and specificity in identifying significant
genes or taxa.

```{r deseq2_noprev,  message=FALSE, warning=FALSE}

set.seed(1238)


dds = phyloseq_to_deseq2(tox_ps_final_genus, ~ TOX_SEVERA)
# manual filtering of no essential features
lowtox_group <- min(table(colData(dds)$TOX_SEVERA))
keep <- rowSums(counts(dds) >= 10) >= lowtox_group
diagdds <- dds[keep,]
diagdds <- estimateSizeFactors(diagdds, type = "poscounts") # to avoid zero log error
diagdds = DESeq(diagdds, test="Wald", fitType="parametric")

res = results(diagdds, cooksCutoff = FALSE)
alpha = 0.05
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(tox_ps_final_genus)[rownames(sigtab), ], "matrix"))
# head(sigtab)


tax_tbl <- tax_table(tox_ps_final_genus) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::select(taxon_id, Genus)


res_df <- as.data.frame(res) %>%
  tibble::rownames_to_column("taxon_id")


res_df <- res_df %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    bacteria = dplyr::if_else(!is.na(Genus) & Genus != "", Genus, taxon_id)
  )

# print(res_df)

# Volcano plot
plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")
# 

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2 <- sigtab %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.01, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
df_fig_deseq2$Genus <- factor(df_fig_deseq2$Genus, levels = df_fig_deseq2$Genus)
df_fig_deseq2$direct <- factor(df_fig_deseq2$direct, levels = c("Positive LFC", "Negative LFC"))

# Create the plot
fig_deseq2 <- df_fig_deseq2 %>%
  ggplot(aes(x = Genus, y = log2FoldChange, fill = direct)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for Genus in DESeq2 analysis") + 
  # scale_fill_discrete(name = NULL) +
  scale_fill_manual(values = c("Negative LFC" = "#22A884FF", "Positive LFC" = "#440154FF")) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, color = df_fig_deseq2$color)
  )

# Print the plot
print(fig_deseq2)

```

features with pvalue (raw) \< 0.05 and \< 0.1 to see the difference

```{r , include=FALSE}
# Optional: change threshold
# res_filtered <- res[which(res$log2FoldChange > 20), ]
# res_filtered <- res[which(res$pvalue < 0.05), ]
res_filtered <- res[which(res$pvalue < 0.1), ]
res_filtered$Genus <- tax_table(tox_ps_final_genus)[rownames(res_filtered), "Genus"]

# Taxa
taxa <- as.data.frame(tax_table(tox_ps_final_genus))
taxa_filtered <- taxa[rownames(res_filtered), ]

# LFC 
taxa_filtered$log2FoldChange <- res_filtered$log2FoldChange

# group by genus
taxa_filtered %>%
  group_by(Genus) %>%
  summarise(max_lfc = max(log2FoldChange), n=n()) %>%
  arrange(desc(max_lfc))

# otu table
otu <- as.data.frame(otu_table(tox_ps_final_genus))

# Target variable
group <- sample_data(tox_ps_final_genus)$TOX_SEVERA  
valid_taxa <- intersect(rownames(res_filtered), taxa_names(tox_ps_final_genus))
res_filtered_valid <- res_filtered[valid_taxa, ]
otu_filtered <- otu[valid_taxa, ]

# Genus
otu_filtered$Genus <- tax_table(tox_ps_final_genus)[valid_taxa, "Genus"]

otu_grouped <- otu_filtered %>%
  rename_with(~ make.names(.), .cols = where(is.numeric))  #  avoid strange names

otu_grouped <- otu_grouped %>%
  dplyr::mutate(mean_all = rowMeans(across(where(is.numeric)))) %>%
  arrange(desc(mean_all))

```

```{r deseq2_noprev_noBH_res_dfs}

# without BH and pvalue (raw) < 0.05
res_deseq2_noprev_noBH_df <- as.data.frame(res_filtered) %>%
  rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = tax_table(tox_ps_final_genus)[rownames(res_filtered), "Genus"],
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,          # not applying BH in here, so pval = qval
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",              # aquí marcamos que no se usó BH
    herramienta = "DESeq2"
  ) %>%
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  filter(pval < 0.05)


# with BH correction

res_deseq2_noprev_BH_df <- as.data.frame(res_filtered) %>%
  rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = tax_table(tox_ps_final_genus)[rownames(res_filtered), "Genus"],
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "yes",             # aquí marcamos que sí se usó BH
    herramienta = "DESeq2"
  ) %>%
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  filter(qval < 0.05)

# Head
head(res_deseq2_noprev_noBH_df)
head(res_deseq2_noprev_BH_df)



```

### **ASV**

```{r deseq2_noprev_ASV,  message=FALSE, warning=FALSE}

set.seed(1238)

dds_ASV = phyloseq_to_deseq2(tox_ps_final, ~ TOX_SEVERA)
# manual filtering of no essential features
lowtox_group <- min(table(colData(dds_ASV)$TOX_SEVERA))
keep <- rowSums(counts(dds_ASV) >= 10) >= lowtox_group
diagdds_ASV <- dds_ASV[keep,]
diagdds_ASV <- estimateSizeFactors(diagdds_ASV, type = "poscounts") # to avoid zero log error
diagdds_ASV = DESeq(diagdds_ASV, test="Wald", fitType="parametric")

res = results(diagdds_ASV, cooksCutoff = FALSE)
alpha = 0.05
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(tox_ps_final)[rownames(sigtab), ], "matrix"))
# head(sigtab)


tax_tbl <- tax_table(tox_ps_final) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::select(taxon_id, Genus)


res_df <- as.data.frame(res) %>%
  tibble::rownames_to_column("taxon_id")


res_df <- res_df %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    bacteria = dplyr::if_else(!is.na(Genus) & Genus != "", Genus, taxon_id)
  )

# print(res_df)

# Volcano plot
plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")
# 

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2 <- sigtab %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.01, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
df_fig_deseq2$Genus <- factor(df_fig_deseq2$Genus, levels = df_fig_deseq2$Genus)
df_fig_deseq2$direct <- factor(df_fig_deseq2$direct, levels = c("Positive LFC", "Negative LFC"))

# Create the plot
fig_deseq2 <- df_fig_deseq2 %>%
  ggplot(aes(x = Genus, y = log2FoldChange, fill = direct)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for Genus in DESeq2 analysis") + 
  # scale_fill_discrete(name = NULL) +
  scale_fill_manual(values = c("Negative LFC" = "#22A884FF", "Positive LFC" = "#440154FF")) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, color = df_fig_deseq2$color)
  )

# Print the plot
print(fig_deseq2)

```

features with pvalue (raw) \< 0.05 and \< 0.1 to see the difference

```{r , include=FALSE}
# Threshold
# res_filtered <- res[which(res$log2FoldChange > 20), ]
# res_filtered <- res[which(res$pvalue < 0.05), ]
res_filtered <- res[which(res$pvalue < 0.1), ]
res_filtered$Genus <- tax_table(tox_ps_final)[rownames(res_filtered), "Genus"]

# Taxa
taxa <- as.data.frame(tax_table(tox_ps_final))
taxa_filtered <- taxa[rownames(res_filtered), ]

taxa_filtered$log2FoldChange <- res_filtered$log2FoldChange

taxa_filtered %>%
  dplyr::group_by(Genus) %>%
  dplyr::summarise(max_lfc = max(log2FoldChange), n=n()) %>%
  dplyr::arrange(desc(max_lfc))


# OTU table
otu <- as.data.frame(otu_table(tox_ps_final))
group <- sample_data(physeq_filtered)$TOX_SEVERA  # target variable

valid_taxa <- intersect(rownames(res_filtered), taxa_names(tox_ps_final_genus))
res_filtered_valid <- res_filtered[valid_taxa, ]
otu_filtered <- otu[valid_taxa, ]  # filtering

# Genus
otu_filtered$Genus <- tax_table(tox_ps_final)[valid_taxa, "Genus"]
otu_grouped <- otu_filtered %>%
  rename_with(~ make.names(.), .cols = where(is.numeric))  # avoid error names

otu_grouped <- otu_grouped %>%
  dplyr::mutate(mean_all = rowMeans(across(where(is.numeric)))) %>%
  arrange(desc(mean_all))

```

```{r res_deseq2_noprev_ASV}


# without BH and pvalue (raw) < 0.05
res_deseq2_noprev_ASV_noBH_df <- as.data.frame(res_filtered) %>%
  rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = tax_table(tox_ps_final)[rownames(res_filtered), "Genus"],
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,          # usamos pval como qval porque NO aplicamos BH
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",              # aquí marcamos que no se usó BH
    herramienta = "DESeq2"
  ) %>%
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  filter(pval < 0.05)


# with BH correction

res_deseq2_noprev_ASV_BH_df <- as.data.frame(res_filtered) %>%
  rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = tax_table(tox_ps_final)[rownames(res_filtered), "Genus"],
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "yes",             # aquí marcamos que sí se usó BH
    herramienta = "DESeq2"
  ) %>%
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  filter(qval < 0.05)

# Head
head(res_deseq2_noprev_ASV_noBH_df)
head(res_deseq2_noprev_ASV_BH_df)



```

### LEfSe

LEfSe (Linear Discriminant Analysis Effect Size) is a statistical method
designed to identify features (e.g., taxa) that are both statistically
significant and biologically relevant across predefined groups. It
combines non-parametric Kruskal–Wallis and Wilcoxon rank-sum tests with
Linear Discriminant Analysis (LDA) to estimate the effect size of each
differentially abundant feature.

In this analysis, we applied LEfSe using both **CPM-transformed counts**
and **relative abundances**, as recommended in the literature. Since
LEfSe does not implement any multiple testing correction by default,
**Benjamini–Hochberg (BH) correction** was applied manually to the
resulting *p*-values to allow fair comparison with other differential
abundance analysis (DAA) methods.

#### (CPM) LEfSe groups previous sum of 1e-06

We applied the **LEfSe** method to identify differential abundant taxa
between the two toxicity groups, using CPM (counts per million)
normalized data. The parameters were settled to 0.05 in Kruskal-Wallis
and Wilcoxon tests.

The class variable used to define the groups was toxicity level (low vs.
severe). LEfSe was then applied to detect taxa that are not only
statistically significant, but also biologically consistent across the
groups, using a non-parametric approach followed by linear discriminant
analysis (LDA).

NOTE: To ensure numerical stability during the LEfSe analysis, a small
pseudocount (1e-06) was added to all abundance values prior to
normalization. This step is essential because LEfSe applies logarithmic
transformations during its processing pipeline (e.g., after CPM or
relative abundance normalization), and zero values can lead to undefined
or unstable results when log-transformed. The pseudocount is small
enough to have negligible impact on relative differences but prevents
errors and maintains consistency across features during differential
abundance testing and LDA effect size estimation.

```{r lefse_cpm_noprev_noBH,  message=FALSE, warning=FALSE}
set.seed(321)


tox_ps_final_lefse <- tox_ps_final
colnames(tax_table(tox_ps_final_lefse))[1] = "Kingdom"

#  Add pseudo-count 1e-06 in abundances
otu_table(tox_ps_final_lefse) <- otu_table(tox_ps_final_lefse) + 1e-06


tryCatch({

  # CPM
  mm_lefse_cpm_filt <- run_lefse(
    tox_ps_final_lefse,
    taxa_rank = "Genus",
    norm = "CPM",
    group = "TOX_SEVERA",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse_cpm_filt@marker_table) &&
      nrow(mm_lefse_cpm_filt@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_cpm_filt@marker_table)) {

    head(marker_table(mm_lefse_cpm_filt))

    if (length(marker_table(mm_lefse_cpm_filt)$feature) > 0) {

      # Abundances Plot
      p_abd <- plot_abundance(mm_lefse_cpm_filt, group = "TOX_SEVERA") +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(p_abd)

      # LDA BarPlot
      plot_error_bar <- plot_ef_bar(mm_lefse_cpm_filt) +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(plot_error_bar)

      # BH correction
      lefse_cpm_filt_features_prev_BH <- mm_lefse_cpm_filt@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_cpm_filt_features_prev_BH[["padj"]] <- p.adjust(lefse_cpm_filt_features_prev_BH[["pvalue"]], method = "BH", n = 6082)
      lefse_cpm_filt_features_prev_BH

      # NO BH CORRECTION
      res_lefse_cpm_noprev_noBH_df <-  lefse_cpm_noprevalence_pvalue_BH %>%
        as_tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
           prev = "no",
           BH = "no",
          herramienta = "LEfSe"
        )
      res_lefse_cpm_noprev_noBH_df
      
        # WITH BH CORRECTION
        res_lefse_cpm_noprev_BH_df <- lefse_cpm_noprevalence_pvalue_BH %>%
        as_tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          prev = "no",
          BH = "yes",
          herramienta = "LEfSe"
        )  %>%
        dplyr::filter(qval < 0.1)

      res_lefse_cpm_noprev_BH_df

    } else {
      message("⚠️ No biomarker features found while evaluating CPM normalization.")
      lefse_cpm_filt_features_prev_BH <- NULL
    }

  } else {
    message("⚠️ LEfSe output empty or without feature detected.")
    lefse_cpm_filt_features_prev_BH <- NULL
  }

}, error = function(e) {
  message("Error while running LEfSe with CPM normalization", conditionMessage(e))
  lefse_cpm_filt_features_prev_BH <- NULL
})





```

##### **ASV Level**

```{r lefse_cpm_ASV_noprev_noBH,  message=FALSE, warning=FALSE, fig.show='asis', dev='png'}
set.seed(321)

tox_ps_final_lefse <- tox_ps_final
colnames(tax_table(tox_ps_final_lefse))[1] = "Kingdom"

#  Add pseudo-count 1e-06 in abundances
otu_table(tox_ps_final_lefse) <- otu_table(tox_ps_final_lefse) + 1e-06


tryCatch({

  # CPM
  mm_lefse_cpm_filt <- run_lefse(
    tox_ps_final_lefse,
    taxa_rank = "none",
    norm = "CPM",
    group = "TOX_SEVERA",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse_cpm_filt@marker_table) &&
      nrow(mm_lefse_cpm_filt@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_cpm_filt@marker_table)) {

    head(marker_table(mm_lefse_cpm_filt))

    if (length(marker_table(mm_lefse_cpm_filt)$feature) > 0) {
      # Mapping from original ps (no renaming)
      tax_tbl <- tax_table(tox_ps_final_lefse) %>% as.data.frame() %>% 
        rownames_to_column("ASV") %>%
        dplyr::mutate(pretty = dplyr::case_when(
          !is.na(Species) & Species != "" ~ paste(Genus, Species),
          !is.na(Genus)   & Genus   != "" ~ Genus,
          # !is.na(Family)  & Family  != "" ~ Family,
          TRUE ~ ASV
        )) %>%
        dplyr::mutate(pretty = make.unique(pretty, sep = "_"))
      
      # Relabel the marker table
      lab_map <- setNames(tax_tbl$pretty, tax_tbl$ASV)
      
      p_abd <- plot_abundance(mm_lefse_cpm_filt, group = "TOX_SEVERA") +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      # rename features
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(p_abd)

      plot_error_bar <- plot_ef_bar(mm_lefse_cpm_filt) +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
     print(plot_error_bar)
  
    # BH correction
      lefse_cpm_noprevalence_pvalue_BH <- mm_lefse_cpm_filt@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_cpm_noprevalence_pvalue_BH[["padj"]] <- p.adjust(lefse_cpm_noprevalence_pvalue_BH[["pvalue"]], method = "BH", n = 6082)
      lefse_cpm_noprevalence_pvalue_BH

      # NO BH CORRECTION
      res_lefse_cpm_ASV_noprev_noBH_df <-  lefse_cpm_noprevalence_pvalue_BH %>%
        tibble::as_tibble() %>%
          dplyr::rename(
            bacteria = feature,
            logFC    = ef_lda,
            pval     = pvalue,
            qval     = padj
          ) %>%
          dplyr::mutate(
            original_feature = bacteria,  #  LEfSe feature name
            genus_raw = unname(lab_map[original_feature]),
            genus_raw = as.character(genus_raw),   #  char type (kept)
            genus     = clean_tax_label(genus_raw),
            feature  = original_feature,  # feature final = original_feature
            bacteria = genus,
        
            direction   = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
            orientation = ifelse(enrich_group == 1, 1, -1),
            qval.txt    = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                              labels = c("***", "**", "*", "-")),
            prev        = "no",
            BH          = "no",
            herramienta = "LEfSe"
          ) %>%
          filter(!is.na(genus) & genus != "")        
            
      
        # WITH BH CORRECTION
        res_lefse_cpm_ASV_noprev_BH_df <- lefse_cpm_noprevalence_pvalue_BH %>%
        as_tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature (ASV)
          bacteria  = genus,                # <- bacteria = genus (clean)
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          prev = "no",
          BH = "yes",
          herramienta = "LEfSe"
        )  %>%
        dplyr::filter(qval < 0.1)

      head(res_lefse_cpm_ASV_noprev_BH_df)

    } else {
      message()
      message("⚠️ No se encontraron marcadores diferenciales con LEfSe (norm=CPM).")
      lefse_cpm_filt_features_prev_BH <- NULL
    }

  } else {
    message("⚠️ Resultado de LEfSe vacío o sin columna 'feature' en marker_table.")
    message("")
    lefse_cpm_filt_features_prev_BH <- NULL
  }

}, error = function(e) {
  message("❌ Error al correr LEfSe con normalización CPM: ", conditionMessage(e))
  lefse_cpm_filt_features_prev_BH <- NULL
})





```



#### (RELAB) LEfSe groups previous sum of 1e-06

We also applied the **LEfSe** method to identify differential abundant
taxa between the two toxicity groups, using Relative Abundances
normalized data. The parameters were settled to 0.05 in Kruskal-Wallis
and Wilcoxon tests.

The class variable used to define the groups was toxicity level (low vs.
severe). LEfSe was then applied to detect taxa that are not only
statistically significant, but also biologically consistent across the
groups, using a non-parametric approach followed by linear discriminant
analysis (LDA).

NOTE: To ensure numerical stability during the LEfSe analysis, a small
pseudocount (1e-06) was added to all abundance values prior to
normalization. This step is essential because LEfSe applies logarithmic
transformations during its processing pipeline (e.g., after CPM or
relative abundance normalization), and zero values can lead to undefined
or unstable results when log-transformed. The pseudocount is small
enough to have negligible impact on relative differences but prevents
errors and maintains consistency across features during differential
abundance testing and LDA effect size estimation.

```{r lefse_ra_noprev_noBH,  message=FALSE, warning=FALSE}

set.seed(356)

tox_ps_final_lefse <- tox_ps_final#_genus

colnames(tax_table(tox_ps_final_lefse))[1] = "Kingdom"  # required by the library

otu_table(tox_ps_final_lefse) <- otu_table(tox_ps_final_lefse) + 1e-06



tryCatch({

  mm_lefse <- run_lefse(
    tox_ps_final_lefse,
    norm = "TSS",
    group = "TOX_SEVERA",
    taxa_rank = "Genus",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse@marker_table) &&
      nrow(mm_lefse@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse@marker_table)) {

    head(marker_table(mm_lefse))

    if (length(marker_table(mm_lefse)$feature) > 0) {

      p_abd <- plot_abundance(mm_lefse, group = "TOX_SEVERA") +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(p_abd)

      plot_error_bar <- plot_ef_bar(mm_lefse) +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(plot_error_bar)

      lefse_features_noprev_tox_BH <- mm_lefse@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_features_noprev_tox_BH[["padj"]] <- p.adjust(lefse_features_noprev_tox_BH[["pvalue"]], method = "BH", n = 6082)
      lefse_features_noprev_tox_BH
      
      # without BH correction
      res_lefse_ra_noprev_noBH_df <- lefse_features_noprev_tox_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "no",
         BH = "no",
          herramienta = "LEfSe"
        )
      
      head(res_lefse_ra_noprev_noBH_df)
      
      
      # with BH correction
      res_lefse_ra_noprev_BH_df <- lefse_features_noprev_tox_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "no",
         BH = "yes",
          herramienta = "LEfSe"
        )  %>%
        dplyr::filter(qval < 0.1)
      
      
      
      # only getting bacteria with padj < 0.05
      # res_lefse_ra_noprev_BH_df <- res_lefse_ra_noprev_BH_df %>%
      #   dplyr::filter(qval < 0.05)
      # head(res_lefse_ra_noprev_BH_df)
      # 
      head(res_lefse_ra_noprev_BH_df)
      


    } else {
      message("⚠️ No differential markers found with LEfSe (norm=TSS).")
      lefse_features_noprev_tox_BH <- NULL
    }

  } else {
    message("⚠️ LEfSe result is empty or marker_table is missing required columns.")
    lefse_features_noprev_tox_BH <- NULL
  }

}, error = function(e) {
  message("❌ Error running LEfSe with TSS normalization: ", conditionMessage(e))
  lefse_features_noprev_tox_BH <- NULL
})


```

##### **ASV Level**

```{r lefse_ra_ASV_noprev_noBH,  message=FALSE, warning=TRUE}

set.seed(356)

tox_ps_final_lefse <- tox_ps_final#_genus

colnames(tax_table(tox_ps_final_lefse))[1] = "Kingdom" # required by the library

otu_table(tox_ps_final_lefse) <- otu_table(tox_ps_final_lefse) + 1e-06 # test with 1



tryCatch({

  mm_lefse_ASV <- microbiomeMarker::run_lefse(
    tox_ps_final_lefse,
    norm = "TSS",
    group = "TOX_SEVERA",
    taxa_rank = "none",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse_ASV@marker_table) &&
      nrow(mm_lefse_ASV@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_ASV@marker_table)) {

    head(marker_table(mm_lefse_ASV))

    if (length(marker_table(mm_lefse_ASV)$feature) > 0) {
      # Mapping from original ps (no renaming)
      tax_tbl <- tax_table(tox_ps_final_lefse) %>% as.data.frame() %>% 
        rownames_to_column("ASV") %>%
        dplyr::mutate(pretty = dplyr::case_when(
          !is.na(Species) & Species != "" ~ paste(Genus, Species),
          !is.na(Genus)   & Genus   != "" ~ Genus,
          # !is.na(Family)  & Family  != "" ~ Family,
          TRUE ~ ASV
      )) %>%
      dplyr::mutate(pretty = make.unique(pretty, sep = "_"))
    
      # Relabel the marker table
      # mt_df <- microbiomeMarker::marker_table(mm_lefse) %>% 
      #   as.data.frame() %>% 
      #   left_join(tax_tbl, by = c("feature" = "ASV")) %>%
      #   mutate(
      #     feature_pretty = ifelse(!is.na(pretty), pretty, feature),
      #     padj = p.adjust(pvalue, method = "BH")
      # )
      
      # Determine which axis to relabel (y for horizontal bars, x if vertical).
      # plot_ef_bar usually uses y = feature (discrete). We can map labels:
      lab_map <- setNames(tax_tbl$pretty, tax_tbl$ASV)
      
      
      p_abd <- plot_abundance(mm_lefse_ASV, group = "TOX_SEVERA") +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      # renombrar eje de features (aquí asumo features en X; cambia a y si corresponde)
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(p_abd)

      plot_error_bar <- plot_ef_bar(mm_lefse_ASV) +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(plot_error_bar)

      lefse_features_noprev_ASV_tox_BH <- mm_lefse_ASV@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_features_noprev_ASV_tox_BH[["padj"]] <- p.adjust(lefse_features_noprev_ASV_tox_BH[["pvalue"]], method = "BH", n = 6082)
      lefse_features_noprev_ASV_tox_BH
      
      # without BH correction
      res_lefse_ra_ASV_noprev_noBH_df <- lefse_features_noprev_ASV_tox_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature final = (ASV/taxon)
          bacteria  = genus,                # <- bacteria = clean genus 
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "no",
         BH = "no",
          herramienta = "LEfSe"
        )

      head(res_lefse_ra_ASV_noprev_noBH_df)
      
      
      # with BH correction
      res_lefse_ra_ASV_noprev_BH_df <- lefse_features_noprev_ASV_tox_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature final = (ASV/taxon)
          bacteria  = genus,                # <- bacteria = clean genus           
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "no",
         BH = "yes",
          herramienta = "LEfSe"
        ) %>%
        dplyr::filter(qval < 0.1)
      
      
      # only getting bacteria with padj < 0.05
      # res_lefse_ra_ASV_noprev_BH_df <- res_lefse_ra_ASV_noprev_BH_df %>%
      #   dplyr::filter(qval < 0.05)
      head(res_lefse_ra_ASV_noprev_BH_df)


    } else {
      message("⚠️ No differential markers found with LEfSe (norm=TSS).")
      lefse_features_noprev_ASV_tox_BH <- NULL
    }

  } else {
    message("⚠️ LEfSe result is empty or marker_table is missing required columns.")
    lefse_features_noprev_ASV_tox_BH <- NULL
  }

}, error = function(e) {
  message("❌ Error running LEfSe with TSS normalization: ", conditionMessage(e))
  lefse_features_noprev_ASV_tox_BH <- NULL
})


```

### LINDA

LinDA (Linear Models for Differential Abundance) is a statistical method
designed to detect differentially abundant microbial taxa between
experimental groups in compositional microbiome data. It fits a linear
model for each taxon, adjusting for compositionality and potential
covariates (e.g., confounders like age or sex).

Output Structure:

LINDA returns a list of data frames, each corresponding to a tested
variable (TOX_SEVERA in our case). The reference group of the tested
variable is the FIRST one that appears when you launch the command
`levels(sample_data(tox_ps_final_genus)$TOX_SEVERA)`. Each row
represents a taxon and includes:

-   **log2FoldChange: The estimated effect size (positive values
    indicate higher abundance in the reference group, negative values in
    the compared group).**

-   **padj: Adjusted p-value using methods like Benjamini-Hochberg.**

-   **reject: Logical indicator (TRUE/FALSE) denoting whether the taxon
    is significantly differentially abundant (based on padj
    threshold).**

Additional fields: baseMean, standard error (lfcSE), test statistic, and
degrees of freedom.

Interpretation:

-   \*\*Significance: Taxa with reject == TRUE and low padj (typically
    \< 0.05) are considered significantly differentially abundant.

Direction of Change:

-   **log2FoldChange \> 0: More abundant in the reference group (low in
    our case).**

-   **log2FoldChange \< 0: More abundant in the comparison group.**

Magnitude: Larger absolute values of log2FoldChange suggest stronger
differential abundance.

Confounders: When present, LINDA provides separate outputs per
covariate, allowing assessment of each variable’s effect independently.

LINDA is particularly suited for microbiome data due to its
compositional adjustments and flexible handling of multiple covariates.
More information able in the official tutorial: tutorial
<https://github.com/zhouhj1994/LinDA>

```{r linda_noprev, include=FALSE,  message=FALSE, warning=FALSE}

set.seed(1924)


otu.tab <- as.data.frame(t(otu_table(tox_ps_final_genus)))#[, ind])
meta <- cbind.data.frame(tox = factor(sample_data(tox_ps_final_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final_genus)$sex),
                         Site = factor(sample_data(tox_ps_final_genus)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_genus_lefse)$sample.id)
                         tnm = factor(sample_data(tox_ps_final_genus)$tnm), 
                         age_group = factor(sample_data(tox_ps_final_genus)$age_group) 
                         )

# ind1 <- which(meta$tox == 'low')
# res.low <- linda(otu.tab[, ind1], meta[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta$tox == 'sev')
# res.sev <- linda(otu.tab[, ind2], meta[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low$output[[1]])[which(res.low$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev$output[[1]])[which(res.sev$output[[1]]$reject)]
linda.obj.tox <- linda(otu.tab, meta, formula = '~tox', alpha = 0.05,
                   prev.cut = 0, lib.cut = 1000, winsor.quan = 0.97)

# linda.plot(linda.obj.tox, c('toxy', 'Sexmale'), 
#            titles = c('tox: n v.s. y'), alpha = 0.1, lfc.cut = 1,
#            legend = TRUE, directory = NULL, width = 11, height = 8)

# See which terms you tested:
term.names.tox <- names(linda.obj.tox$output)
# print(term.names.tox)
# e.g.: [1] "SiteRight" "Sexmale"

# For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox <- lapply(term.names.tox, function(tnm) {
  df <- linda.obj.tox$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox) <- term.names.tox

# Look at them
sig.list.tox
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# Get **all** unique taxa that show up anywhere
all.sig.taxa.tox <- unique( unlist(sig.list.tox) )
# all.sig.taxa.tox

# taxa names
matched.tox <- match(all.sig.taxa.tox, rownames(tax_table(tox_ps_final_genus)))
sig_tax_df.tox <- tax_table(tox_ps_final_genus)[matched.tox, ]
# sig_tax_df.tox # "s__Bacteroides_vulgatus" en ambos asvs

#  Join all linda.obj.tox dfs into one
linda_df_tox <- imap_dfr(linda.obj.tox$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Columns: estimate, std.error, p.value, p.adj, reject, taxa, term
head(linda_df_tox)


```

```{r linda_noprev_plot_res}

# Data preparation
df_noBH <- linda.obj.tox$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(tox_ps_final_genus) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH <- df_fig_noBH %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    # symbol † to  p-only
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )

# Plot of LinDA with BH correction
linda_plot_genus_noprev_noBH <- linda_plot(df_fig_noBH)
linda_plot_genus_noprev_noBH


```

As LinDA shows a strict criteria, we are showing and retaining the
features that shows at least qval \< 0.1.

```{r linda_noprev_plot}


# Data preparation
df_fig <- linda.obj.tox$output$toxsev %>%        # data.frame
  tibble::rownames_to_column("taxon_id") %>%     # 
  filter(reject) %>%
  transmute(
    taxon_id = as.character(taxon_id),
    logFC        = log2FoldChange,
    se           = lfcSE,
    qval         = as.numeric(padj),
    direction    = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt     = dplyr::case_when(
      qval < 0.001 ~ "***",
      qval < 0.01  ~ "**",
      qval < 0.05  ~ "*",
      qval < 0.1   ~ "-",
      TRUE         ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  filter(abs(logFC) > 1 | qval < 0.1) %>%
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC)



# Defining Alpha breaks
df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))
# Genus as tag
tax_tbl <- tax_table(tox_ps_final_genus) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)
df_fig <- df_fig %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

# Plot of LinDA with BH correction
linda_plot_genus_noprev_BH <- linda_plot(df_fig)
linda_plot_genus_noprev_BH

```

```{r LinDA_taxa_noprev_ASV}

# Without BH
res_linda_noprev_noBH_df <- linda.obj.tox$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%  # move taxon ID to a column
  # filter(pvalue < 0.05) %>%                   # <-- use raw p-value only
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::transmute(
    feature      = taxon_id,
    bacteria     = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    logFC        = log2FoldChange,
    pval       = pvalue,
    padj         = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction    = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt     = ifelse(padj < 0.001, "***",
                          ifelse(padj < 0.01, "**",
                          ifelse(padj < 0.05, "*", ""))),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "Genus",
    prev         = "no",
    BH           = "no",                      # <-- Not using BH correction here
    herramienta  = "LINDA"
  ) %>%
  # optional: filter for effect size or any extra condition
  dplyr::filter(abs(logFC) > 1 & pval < 0.05) %>%
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC) #%>% 
  #dplyr::filter(pval < 0.05)  # filtro pvalue


res_linda_noprev_noBH_df

# With BH
res_linda_noprev_BH_df <- linda.obj.tox$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>% # 
  # dplyr::filter(reject) %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::transmute(
    feature =taxon_id,
    bacteria = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    # bacteria = taxon_id,
    logFC        = log2FoldChange,   # log2FoldChange
    pval = pvalue, 
    padj = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                     ifelse(padj < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "Genus",
        prev = "no",
         BH = "yes",
         herramienta = "LINDA"
  ) %>%
  # optional: filters
  dplyr::filter(abs(logFC) > 1 & padj < 0.1) %>%        
  # optional: 
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC)
 # another option
 # mutate(reject = padj < 0.1) %>%
 #  filter(reject, abs(logFC) > 1) %>%


res_linda_noprev_BH_df

```

#### **ASV Level**

```{r linda_noprev_ASV, include=FALSE,  message=FALSE, warning=FALSE}

set.seed(1924)




otu.tab <- as.data.frame(t(otu_table(tox_ps_final)))#[, ind])
meta <- cbind.data.frame(tox = factor(sample_data(tox_ps_final)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final)$sex),
                         Site = factor(sample_data(tox_ps_final)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final)$sample.id)
                         tnm = factor(sample_data(tox_ps_final)$tnm), 
                         age_group = factor(sample_data(tox_ps_final)$age_group) 
                         )

# ind1 <- which(meta$tox == 'low')
# res.low <- linda(otu.tab[, ind1], meta[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta$tox == 'sev')
# res.sev <- linda(otu.tab[, ind2], meta[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low$output[[1]])[which(res.low$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev$output[[1]])[which(res.sev$output[[1]]$reject)]
linda.obj.tox.ASV <- linda(otu.tab, meta, formula = '~tox', alpha = 0.05,
                   prev.cut = 0, lib.cut = 1000, winsor.quan = 0.97)

# linda.plot(linda.obj.tox, c('toxy', 'Sexmale'), 
#            titles = c('tox: n v.s. y'), alpha = 0.1, lfc.cut = 1,
#            legend = TRUE, directory = NULL, width = 11, height = 8)

#  See which terms you tested:
term.names.tox <- names(linda.obj.tox.ASV$output)
# print(term.names.tox)
# e.g.: [1] "SiteRight" "Sexmale"

# For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.ASV <- lapply(term.names.tox, function(tnm) {
  df <- linda.obj.tox$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.ASV) <- term.names.tox

# Look at them
# sig.list.tox
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# Get **all** unique taxa that show up anywhere
all.sig.taxa.tox.ASV <- unique( unlist(sig.list.tox.ASV) )
# all.sig.taxa.tox.ASV

# taxa names
matched.tox <- match(all.sig.taxa.tox.ASV, rownames(tax_table(tox_ps_final)))
sig_tax_df.tox.ASV <- tax_table(tox_ps_final)[matched.tox, ]
# sig_tax_df.tox.ASV # "s__Bacteroides_vulgatus" en ambos asvs


#  Join all linda.obj.tox dfs into one
linda_df_tox_ASV <- imap_dfr(linda.obj.tox$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Columns: estimate, std.error, p.value, p.adj, reject, taxa, term
head(linda_df_tox_ASV)


```

```{r linda_noprev_res_df_asv}

# Data preparation
df_noBH <- linda.obj.tox.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val 
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# taxonomy table with ASV + Genus
tax_tbl <- tax_table(tox_ps_final) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::select(taxon_id, Genus)

# join LinDA output (df_fig_noBH) with taxonomy
df_fig_noBH2 <- df_fig_noBH %>%
  # dplyr::rename(ASV = taxon_id) %>%              # match key
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id) # prefer genus name
  )


df_fig_noBH2 <- df_fig_noBH2 %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    # symbol † to  p-only
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )

# Plot of LinDA with BH correction
linda_plot_ASV_noprev_noBH <- linda_plot(df_fig_noBH2)
linda_plot_ASV_noprev_noBH


```

As LinDA shows a strict criteria, we are showing and retaining the
features that shows at least qval \< 0.1.

```{r}

# Data preparation
df_fig <- linda.obj.tox.ASV$output$toxsev %>%        # data.frame 
  tibble::rownames_to_column("taxon_id") %>%     # ASV to columna
  filter(reject) %>%
  transmute(
    taxon_id = as.character(taxon_id),
    logFC        = log2FoldChange,
    se           = lfcSE,
    qval         = as.numeric(padj),
    direction    = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt     = dplyr::case_when(
      qval < 0.001 ~ "***",
      qval < 0.01  ~ "**",
      qval < 0.05  ~ "*",
      qval < 0.1   ~ "-",
      TRUE         ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  filter(abs(logFC) > 1 | qval < 0.1) %>%
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC)



# Defining Alpha breaks
df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))
# Extract taxonomy table + attach rownames as "ASV"
# taxonomy table with ASV + Genus
tax_tbl <- tax_table(tox_ps_final) %>%
  as.data.frame() %>%
  # tibble::rownames_to_column("ASV") %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::select(taxon_id, Genus)

# join LinDA output (df_fig_noBH) with taxonomy
df_fig <- df_fig %>%
  # dplyr::rename(ASV = taxon_id) %>%              # match key
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id) # prefer genus name
  )


# Plot of LinDA with BH correction
linda_plot_ASV_noprev_BH <- linda_plot(df_fig)
linda_plot_ASV_noprev_BH


```

```{r LinDA_taxa_noprev_res_dfs}

# Without BH
res_linda_noprev_ASV_noBH_df <- linda.obj.tox.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%  # move taxon ID to a column
  # filter(pvalue < 0.05) %>%                   # <-- use raw p-value only
  # dplyr::left_join(tax_tbl, by = c("taxon_id" = "ASV")) %>%
  dplyr::left_join(tax_tbl, by = "taxon_id")  %>%
  dplyr::transmute(
    feature      = taxon_id,
    bacteria     = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    logFC        = log2FoldChange,
    pval       = pvalue,
    padj         = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction    = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt     = ifelse(padj < 0.001, "***",
                          ifelse(padj < 0.01, "**",
                          ifelse(padj < 0.05, "*", ""))),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "Genus",
    prev         = "no",
    BH           = "no",                      # <-- Not using BH correction here
    herramienta  = "LINDA"
  ) %>%
  # optional: filter for effect size or any extra condition. pval of 0.1 is to high
  dplyr::filter(abs(logFC) > 1 & pval < 0.05) %>%
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC) #%>% 
  #dplyr::filter(pval < 0.05)  # filtro pvalue


res_linda_noprev_noBH_df

# With BH
res_linda_noprev_ASV_BH_df <- linda.obj.tox.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>% # 
  dplyr::filter(reject) %>%
  dplyr::left_join(tax_tbl, by = c("taxon_id")) %>%
  dplyr::transmute(
    feature =taxon_id,
    bacteria = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    # bacteria = taxon_id,
    logFC        = log2FoldChange,   # log2FoldChange
    pval = pvalue, 
    padj = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                     ifelse(padj < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "Genus",
        prev = "no",
         BH = "yes",
         herramienta = "LINDA"
  ) %>%
  # additional step:  FDR or padj filter
  dplyr::filter(abs(logFC) > 1 & padj < 0.1) %>%       
  # additional: removing unnknown taxa
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC)


res_linda_noprev_ASV_BH_df

```

### ZicoSeq

ZicoSeq is a linear model– and permutation-based framework for
differential abundance analysis designed for zero-inflated,
compositional sequencing data. It accepts raw count or proportion data,
along with associated metadata (e.g., grouping and covariates), and is
particularly robust to common microbiome data challenges such as
sparsity, outliers, and variability in sampling depth.

The method begins by filtering low-abundance and low-prevalence
features. It then applies **winsorization** to limit the influence of
outliers, and—when using count data—may incorporate **Bayesian
smoothing** via a beta-mixture model to account for sampling variability
and zero inflation.

Normalization is conducted using a **reference-based iterative
procedure**, which identifies a stable set of features by excluding
highly variable taxa. Differential abundance is then assessed using a
**linear modeling approach** over multiple data transformations (e.g.,
log, square-root), enabling flexibility in capturing different types of
feature–group relationships.

Statistical significance is determined using a **permutation-based
omnibus test**, which preserves the correlation structure of the data.
ZicoSeq reports both raw and adjusted *p*-values (FDR, and optionally
FWER), along with effect size measures such as R² and signed test
statistics, supporting robust biomarker discovery in compositional
datasets.

```{r zicoseq_noprev,  message=FALSE, warning=FALSE}

set.seed(1794)

otu_tab_ZS <- as(otu_table(tox_ps_final_genus), "matrix") # otu_table(tox_ps_final_genus)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1

metadata_ZS <- cbind.data.frame(sampleid = (sample_data(tox_ps_final_genus)$biosample_name),
                         tox = factor(sample_data(tox_ps_final_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final_genus)$sex),
                         Age = factor(sample_data(tox_ps_final_genus)$age_group),
                         Site = factor(sample_data(tox_ps_final_genus)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_genus_lefse)$sample.id)
                         metastasis = factor(sample_data(tox_ps_final_genus)$has_metastasis),
                         row.names = rownames(sample_data(tox_ps_final_genus)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox', feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) 

ZicoSeq.plot(ZicoSeq.obj, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r zicoseq_taxa_noprev_res_dfs}
#  Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj$coef.list[[1]])), 
]

#  Extract raw and adjusted p-values
pvals <- ZicoSeq.obj$p.raw
names(pvals) <- rownames(ZicoSeq.obj$R2)

qvals <- ZicoSeq.obj$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj$R2)

#  Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(tox_ps_final_genus))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_noprev_NoBH <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L), 
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "no",
    BH           = "no",
    method       = "ZicoSeq"
  )  %>%
  filter(abs(logFC) > 1 & qval < 0.1)

res_zicoseq_noprev_NoBH

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_noprev_BH <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "no",
    BH           = "yes",
    method       = "ZicoSeq"
  )  %>%
  filter(abs(logFC) > 1 | qval < 0.1)

res_zicoseq_noprev_BH

### -------- Combine both results -------- ###
# res_zicoseq_prev <- bind_rows(res_zicoseq_prev_NoBH, res_zicoseq_prev_BH)

```

#### ZicoSeq Plot

In the case of ZicoSeq, R² values were used as proxies for effect sizes
(logFC) for the purpose of comparison across methods.

```{r,  message=FALSE, warning=FALSE}

# Plot 1: Without BH correction
p1 <- plot_logFC_bar(res_zicoseq_noprev_NoBH, "ZicoSeq (No BH correction)")

# Plot 2: With BH correction
p2 <- plot_logFC_bar(res_zicoseq_noprev_BH, "ZicoSeq (With BH correction)")

# Printing plots
print(p1)
print(p2)

```

#### **ASV**

```{r zicoseq_noprev_ASV,  message=FALSE, warning=FALSE}

set.seed(1794)


otu_tab_ZS <- as(otu_table(tox_ps_final), "matrix") # otu_table(tox_ps_final_genus)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1

metadata_ZS <- cbind.data.frame(sampleid = (sample_data(tox_ps_final)$biosample_name),
                         tox = factor(sample_data(tox_ps_final)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final)$sex),
                         Age = factor(sample_data(tox_ps_final)$age_group),
                         Site = factor(sample_data(tox_ps_final)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_genus_lefse)$sample.id)
                         metastasis = factor(sample_data(tox_ps_final)$has_metastasis),
                         row.names = rownames(sample_data(tox_ps_final)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj.ASV <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox', feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) 

ZicoSeq.plot(ZicoSeq.obj.ASV, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r zicoseq_taxa_noprev_ASV_res_dfs}
# Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj.ASV$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj.ASV$coef.list[[1]])), 
]

# Extract raw and adjusted p-values
pvals <- ZicoSeq.obj.ASV$p.raw
names(pvals) <- rownames(ZicoSeq.obj.ASV$R2)

qvals <- ZicoSeq.obj.ASV$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj.ASV$R2)

# Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(tox_ps_final))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_noprev_ASV_NoBH <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L), 
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "no",
    BH           = "no",
    method       = "ZicoSeq"
  )  %>%
  filter(abs(logFC) > 1) # & qval < 0.1)

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_noprev_ASV_BH <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "no",
    BH           = "yes",
    method       = "ZicoSeq"
  )  %>%
  filter(abs(logFC) > 1 | qval < 0.1)

### -------- Combine both results -------- ###
# res_zicoseq_prev <- bind_rows(res_zicoseq_prev_NoBH, res_zicoseq_prev_BH)

```

```{r plot zicoseq_noprevASV}

#  Plot 1: Without BH correction
p1 <- plot_logFC_bar(res_zicoseq_noprev_ASV_NoBH, "ZicoSeq (No BH correction)")

#  Plot 2: With BH correction
if(length(res_zicoseq_noprev_ASV_BH) == 0){
  print("No significant features were found.")
} else{
  p2 <- plot_logFC_bar(res_zicoseq_noprev_ASV_BH, "ZicoSeq (With BH correction)")
  print(p2)
}

# Plots
print(p1)


```

## *(2)  Filtering by prevalence directly in phyloseq object*

Here, we are using the phyloseq filtered by prevalence object, named
*physeq_filtered*. We also aggregated to genus level for biomarker
discover purpose and named it *physeq_filtered_genus*:

```{r physeq_filtered_genus, warning=FALSE, message=FALSE}
physeq_filtered_genus <- suppressWarnings(
  tax_glom(physeq_filtered, taxrank = "Genus")
)

```


### ANCOM-BC (Prevalence approach, NO BH correction)

NOTE: As we want to no aggregate due previous aggregation to genus
level, then ANCOM-BC target_level parameter should be set at "ASV". See
code for further details.

```{r running_ancombc_prev_noBH, include=FALSE, class.source = 'fold-show', echo=FALSE, message=FALSE}

set.seed(123)

# Run on each level
proc_genus_ancombc <- NULL
proc_asv_ancombc <- NULL

# Genus aggregation before tools
proc_genus_ancombc_PnB_prev <- run_ancombc_PnB_toolprev(physeq_filtered,  "Genus", c("TOX_SEVERA"), prv_cut=0)
proc_asv_ancombc_PnB_prev <- run_ancombc_PnB_toolprev(physeq_filtered,  "ASV", c("TOX_SEVERA"), prv_cut=0)


# Concatenate results
df_fig_preps_noBH <- rbind(proc_genus_ancombc_PnB_prev, proc_asv_ancombc_PnB_prev)
df_fig_preps_noBH$target_level <- factor(df_fig_preps_noBH$target_level, levels = c("Genus", "ASV"))
as.data.frame(df_fig_preps_noBH)


```

Filtering by qval
```{r ancombc_prev_noBH_filtering, include=FALSE}

ancombc_bh_pvals_pr_filt_noBH <-  as.data.frame(df_fig_preps_noBH)$pval[as.data.frame(df_fig_preps_noBH)$qval < 0.05]
# ancombc_bh_pvals_pr_filt_noBH


ancomb_pr_filt_features_noBH <- as.data.frame(df_fig_preps_noBH)$taxon_id
ancomb_pr_filt_features_tox_noBH <- as.data.frame(df_fig_preps_noBH)[, c("taxon_id", "orientation", "qval")]
ancomb_pr_filt_features_tox_noBH
```

#### ANCOM-BC Prevalence-NoBH Plot

```{r ancombc_visualization_prev_filt, fig.height=10}

set.seed(123)


# Remove untrusted organisms
df_fig_pre_noBH <- df_fig_preps_noBH[!grepl("Incertae|uncultured", df_fig_preps_noBH$taxon_id),]

# Plot
p <- NULL
p <- ggplot(data = subset(df_fig_preps_noBH), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
  scale_alpha_manual(values=get_scale_alpha_values(df_fig_pre_noBH$qval.txt)) +
  geom_bar(stat = "identity",
           position = position_dodge2(width = 0.9, preserve = "single")) +
  geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
                position = position_dodge2(width = 0.9, preserve = "single"),
                color = "gray36") +
  geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
            position = position_dodge2(width = 0.9, preserve = "single")) +
  # geom_vline(xintercept = (1:length(df_fig$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
  geom_hline(yintercept = 0, alpha=0.5) +
  facet_wrap(~target_level, scale="free_y", ncol=1) +
  labs(x = NULL, y = "Log fold change", title = "") +
  scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
  # scale_fill_discrete(name = NULL) +
  # scale_color_discrete(name = NULL) +
  # scale_x_discrete(limits = unique(df_fig$taxon_id)) +
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
    axis.text.y=element_text(size=10),
    axis.title.y=element_text(size=10, face = "italic"),
    legend.text=element_text(size=8)
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_blank(),
    # panel.border = element_blank(),
    # panel.background = element_blank(),
    # axis.ticks.x=element_blank()
    # axis.line = element_line(colour = "black")
  )
p
# ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)
```

Final ANCOM-BC df results:

```{r ancombc_prev_noBH_res_dfs}



res_ancom_prev_noBH_df <- df_fig_preps_noBH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level != "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "yes",
    BH           = "yes",
    herramienta  = "ANCOMBC"
  ) %>% 
  filter(abs(logFC) > 1 & pvalue < 0.1) # 0.05


res_ancom_prev_ASV_noBH_df <- df_fig_preps_noBH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level == "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "yes",
    BH           = "yes",
    herramienta  = "ANCOMBC"
  ) %>% 
  filter(abs(logFC) > 1 & pvalue < 0.1) # 0.05




```

### ANCOM-BC (Prevalence approach, BH correction)

ANCOM-BC package are used in differential abundance analysis.

Different target_level have been used.

Default p-value correction Holm changed by Benjamini-Hochberg.

NOTE: As we want to no aggregate due previous aggregation to genus
level, then ANCOM-BC target_level parameter should be set at "ASV". See
code for further details.


```{r running_ancombc_prev, include=FALSE, class.source = 'fold-show', echo=FALSE, message=FALSE}

set.seed(123)

# Run on each level
proc_genus_ancombc <- NULL
proc_asv_ancombc <- NULL

# Running ANCOM-BC
proc_genus_ancombc_PB <- run_ancombc_PB(physeq_filtered,  "Genus", c("TOX_SEVERA"), prv_cut=0)
proc_asv_ancombc_PB <- run_ancombc_PB(physeq_filtered,  "ASV", c("TOX_SEVERA"), prv_cut=0)


df_fig_pre_BH <- rbind(proc_genus_ancombc_PB, proc_asv_ancombc_PB)
df_fig_pre_BH$target_level <- factor(df_fig_pre_BH$target_level, levels = c("Genus", "ASV"))
as.data.frame(df_fig_pre_BH)

```

```{r ancombc_prev_filtering, include=FALSE}

ancombc_pr_bh_pvals <- as.data.frame(df_fig_pre_BH)$pval[as.data.frame(df_fig_pre_BH)$qval < 0.05]
# ancombc_pr_bh_pvals

ancomb_features_pr_filt_bh <- as.data.frame(df_fig_pre_BH)$taxon_id

ancomb_features_pr_filt_BH_tox <- as.data.frame(df_fig_pre_BH)[, c("taxon_id", "orientation", "qval")]
ancomb_features_pr_filt_BH_tox

```

#### ANCOM-BC Prevalence-BH Plot

```{r ancombc_visualization_filteringPrevalence, fig.height=10}

set.seed(123)


# Remove untrusted organisms
df_fig_pre_BH <- df_fig_pre_BH[!grepl("Incertae|uncultured", df_fig_pre_BH$taxon_id),]

# Plot
p <- NULL
p <- ggplot(data = subset(df_fig_pre_BH), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
  scale_alpha_manual(values=get_scale_alpha_values(df_fig_pre_BH$qval.txt)) +
  geom_bar(stat = "identity",
           position = position_dodge2(width = 0.9, preserve = "single")) +
  geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
                position = position_dodge2(width = 0.9, preserve = "single"),
                color = "gray36") +
  geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
            position = position_dodge2(width = 0.9, preserve = "single")) +
  # geom_vline(xintercept = (1:length(df_fig$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
  geom_hline(yintercept = 0, alpha=0.5) +
  facet_wrap(~target_level, scale="free_y", ncol=1) +
  labs(x = NULL, y = "Log fold change", title = "") +
  scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
  # scale_fill_discrete(name = NULL) +
  # scale_color_discrete(name = NULL) +
  # scale_x_discrete(limits = unique(df_fig$taxon_id)) +
  coord_flip() +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
    axis.text.y=element_text(size=10),
    axis.title.y=element_text(size=10, face = "italic"),
    legend.text=element_text(size=8)
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_blank(),
    # panel.border = element_blank(),
    # panel.background = element_blank(),
    # axis.ticks.x=element_blank()
    # axis.line = element_line(colour = "black")
  )
p
# ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)
```

```{r ancombc_prev_res_dfs_global}



res_ancom_prev_BH_df <- df_fig_pre_BH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level != "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "yes",
    BH           = "yes",
    herramienta  = "ANCOMBC"
  ) %>%
  filter(abs(logFC) > 1 & padj < 0.1) # 0.05


res_ancom_prev_BH_df


res_ancom_prev_ASV_BH_df <- df_fig_pre_BH %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::filter(target_level == "ASV")%>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "yes",
    BH           = "yes",
    herramienta  = "ANCOMBC"
  ) %>%
  filter(abs(logFC) > 1 & padj < 0.1) # 0.05


res_ancom_prev_ASV_BH_df



```

### ALDEx2 (Official Package)

ALDEx2 (ANOVA-Like Differential Expression) is a method designed to
identify differences in feature abundance between groups in
compositional data, such as those generated by microbiome sequencing
(e.g., 16S rRNA or metagenomics). It works by generating multiple Monte
Carlo instances from a Dirichlet distribution to account for technical
variability, then applying a centered log-ratio (CLR) transformation to
the data. Statistical tests (e.g., Welch’s t-test or Wilcoxon) are
performed on these transformed values to detect differential abundance.
ALDEx2 also estimates effect size (log-fold change) and includes
adjusted p-values (e.g., via Benjamini-Hochberg correction) for multiple
testing. Its main strength lies in properly addressing the compositional
nature of relative abundance data, reducing the risk of false positives
compared to traditional methods.

```{r aldex_prev,  message=FALSE, warning=FALSE}

set.seed(1934)

counts <- as(otu_table(physeq_filtered_genus), "matrix")
tox_conds <- as.character(sample_data(physeq_filtered_genus)$TOX_SEVERA)
names(tox_conds) <- colnames(t(counts))
identical(names(tox_conds), colnames(t(counts)))  # Debe dar TRUE

aldex_prev_r <- aldex.clr(t(counts), conds= tox_conds, denom="all") #, test="t", effect=TRUE, denom="all")
aldex_prev_result <- aldex.ttest(aldex_prev_r, paired.test = FALSE, verbose =TRUE)
aldex_prev_result_effect <- aldex.effect(aldex_prev_r, CI=TRUE,verbose = TRUE)
#print(aldex_result)

# As ALDEx2 return the raw pvalues and BH adjusted pvalues, we are checking:
print("Filter alpha 0.05")
table(
  uncorrected = aldex_prev_result$we.ep < 0.05,
  corrected = aldex_prev_result$we.eBH < 0.05
)

print("Filter alpha 0.1")
table(
  uncorrected = aldex_prev_result$we.ep < 0.1,
  corrected = aldex_prev_result$we.eBH < 0.1
)


```

#### ALDEx2 Plot

```{r aldex_prev_plot}


# transform to df and create feature column with rownames
df_clr <- as.data.frame(aldex_prev_result) %>% tibble::rownames_to_column("feature")
df_eff <- as.data.frame(aldex_prev_result_effect) %>% tibble::rownames_to_column("feature")

# columns join
aldex_prev_final <- full_join(df_clr, df_eff, by = "feature")

# rename the rownames with the features
rownames(aldex_prev_final) <- aldex_prev_final$feature
aldex_prev_final$feature <- NULL


# Creating plot df
df_plot <- aldex_prev_final %>%
  dplyr::mutate(
    taxon_id = rownames(.),
    lfc = diff.btw,
    pval = we.ep,
    qval = we.eBH,
    pval_sig = pval < 0.05,
    qval_sig = qval < 0.05,
    qval.txt = ifelse(qval < 0.05, "*", ""),  # O 
    direction = ifelse(lfc > 0, "Sev", "Low"),
    orientation = ifelse(lfc > 0, 1, -1),
    se = 0  # ALDEx2 doesn't give this value, it can be set to 0 or calculate externally
  )


tax_df <- as.data.frame(tax_table(physeq_filtered))
tax_df$taxon_id <- rownames(tax_df)

df_plot <- dplyr::left_join(df_plot, tax_df, by = "taxon_id")

# Usign Genus to face_wrap
df_plot$target_level <- df_plot$Genus


df_plot$qval.txt <- cut(df_plot$qval,
                        breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                        labels = c("***", "**", "*", "-"))

# Transform to factor
df_plot$qval.txt <- factor(df_plot$qval.txt, levels = c("***", "**", "*", "-"))


get_scale_alpha_values <- function(qval_vector) {
  # This scale can be personalized
  alphas <- ifelse(qval_vector < 0.05, 1, 0.3)
  names(alphas) <- ifelse(qval_vector < 0.05, "*", "")
  return(alphas)
}

df_pval_only <- df_plot %>% filter(pval_sig)
df_qval <- df_plot %>% filter(pval_sig & qval_sig)


plot_aldex_barplot(df_pval_only)  # Show candidates with p < 0.05
if (nrow(df_qval) > 0) {
  plot_aldex_barplot(df_qval)
} else {
  message("⚠️ No features with p < 0.05 y q < 0.05. So, no plot would be generated.")
}       # Candidates with p < 0.05 and  q < 0.05


```


```{r aldex_prev_df, message=FALSE, warning=FALSE}

# Genus vector to create bacteria_names
bacteria_names <- tax_table(physeq_filtered)[rownames(aldex_prev_final), "Genus"]

# Transform to vector, checking NAs and replacing with ASVs IDS
bacteria_names <- as.character(bacteria_names)
bacteria_names[is.na(bacteria_names)] <- rownames(aldex_prev_final)[is.na(bacteria_names)]

# Final df
df_aldex <- aldex_prev_final %>%
  as.data.frame() %>%
  rownames_to_column("feature") %>%
  dplyr::rename(
    logFC = diff.btw,
    pval = we.ep,
    qval = we.eBH
  )

# Adding bacteria column to df
df_aldex$bacteria <- bacteria_names

# Adding extra columns for visualization purpose
res_aldex2_prev_noBH_df <- df_aldex %>%
  # left_join(tax_df, by = "feature") %>%
  dplyr::mutate(
    bacteria = bacteria,  # shortname
    enrich_group = ifelse(logFC < 0, "0", "1"),
    direction = ifelse(enrich_group == "1", "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == "1", 1, -1),
    qval.txt = cut(qval, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",
    herramienta = "ALDEX2"
  ) %>%
  filter(pval < 0.05) 
  # %>%
  # filter(qval < 0.1)


head(res_aldex2_prev_noBH_df)



```

#### **ASV ALDEx2**

```{r aldex_prev_ASV,  message=FALSE, warning=FALSE}

set.seed(1934)

counts <- as(otu_table(physeq_filtered), "matrix")
tox_conds <- as.character(sample_data(physeq_filtered)$TOX_SEVERA)
names(tox_conds) <- colnames(t(counts))
identical(names(tox_conds), colnames(t(counts)))  # Debe dar TRUE

aldex_prev_ASV_r <- aldex.clr(t(counts), conds= tox_conds, denom="all") #, test="t", effect=TRUE, denom="all")
aldex_prev_ASV_result <- aldex.ttest(aldex_prev_ASV_r, paired.test = FALSE, verbose =TRUE)
aldex_prev_ASV_result_effect <- aldex.effect(aldex_prev_ASV_r, CI=TRUE,verbose = TRUE)
#print(aldex_result)

# As ALDEx2 return the raw pvalues and BH adjusted pvalues, we are checking:
print("Filter alpha 0.05")
table(
  uncorrected = aldex_prev_ASV_result$we.ep < 0.05,
  corrected = aldex_prev_ASV_result$we.eBH < 0.05
)

print("Filter alpha 0.1")
table(
  uncorrected = aldex_prev_ASV_result$we.ep < 0.1,
  corrected = aldex_prev_ASV_result$we.eBH < 0.1
)


```

#### ALDEx2 Plot

```{r aldex_prev_ASV_plot}


# transform to df and create feature column with rownames
df_clr <- as.data.frame(aldex_prev_ASV_result) %>% tibble::rownames_to_column("feature")
df_eff <- as.data.frame(aldex_prev_ASV_result_effect) %>% tibble::rownames_to_column("feature")

# columns join
aldex_prev_ASV_final <- full_join(df_clr, df_eff, by = "feature")

# rename the rownames with the features
rownames(aldex_prev_ASV_final) <- aldex_prev_ASV_final$feature
aldex_prev_ASV_final$feature <- NULL


# Creating plot df
df_plot <- aldex_prev_ASV_final %>%
  dplyr::mutate(
    taxon_id = rownames(.),
    lfc = diff.btw,
    pval = we.ep,
    qval = we.eBH,
    pval_sig = pval < 0.05,
    qval_sig = qval < 0.05,
    qval.txt = ifelse(qval < 0.05, "*", ""),  # O 
    direction = ifelse(lfc > 0, "Sev", "Low"),
    orientation = ifelse(lfc > 0, 1, -1),
    se = 0  # ALDEx2 doesn't give this value, it can be set to 0 or calculate externally
  )


tax_df <- as.data.frame(tax_table(physeq_filtered))
tax_df$taxon_id <- rownames(tax_df)

df_plot <- dplyr::left_join(df_plot, tax_df, by = "taxon_id")

# Usign Genus to face_wrap
df_plot$target_level <- df_plot$Genus


df_plot$qval.txt <- cut(df_plot$qval,
                        breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                        labels = c("***", "**", "*", "-"))

# Transform to factor
df_plot$qval.txt <- factor(df_plot$qval.txt, levels = c("***", "**", "*", "-"))

# TODO: move to function script
get_scale_alpha_values <- function(qval_vector) {
  # This scale can be personalized
  alphas <- ifelse(qval_vector < 0.05, 1, 0.3)
  names(alphas) <- ifelse(qval_vector < 0.05, "*", "")
  return(alphas)
}

df_pval_only <- df_plot %>% filter(pval_sig)
df_qval <- df_plot %>% filter(pval_sig & qval_sig)

plot_aldex_barplot(df_pval_only)  # Show candidates with p < 0.05
if (nrow(df_qval) > 0) {
  plot_aldex_barplot(df_qval)
} else {
  message("⚠️ No features with p < 0.05 y q < 0.05. So, no plot would be generated.")
}       # Candidates with p < 0.05 nnd  q < 0.05


```

```{r aldex_prev_ASV_df, message=FALSE, warning=FALSE}

# Genus vector to create bacteria_names
bacteria_names <- tax_table(physeq_filtered)[rownames(aldex_prev_ASV_final), "Genus"]

# Transform to vector, checking NAs and replacing with ASVs IDS
bacteria_names <- as.character(bacteria_names)
bacteria_names[is.na(bacteria_names)] <- rownames(aldex_prev_ASV_final)[is.na(bacteria_names)]

# Final df
df_aldex <- aldex_prev_ASV_final %>%
  as.data.frame() %>%
  rownames_to_column("feature") %>%
  dplyr::rename(
    logFC = diff.btw,
    pval = we.ep,
    qval = we.eBH
  )

# Adding bacteria column to df
df_aldex$bacteria <- bacteria_names

# Adding extra columns for visualization purpose
res_aldex2_prev_ASV_noBH_df <- df_aldex %>%
  # left_join(tax_df, by = "feature") %>%
  dplyr::mutate(
    bacteria = bacteria,  # shortname
    enrich_group = ifelse(logFC < 0, "0", "1"),
    direction = ifelse(enrich_group == "1", "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == "1", 1, -1),
    qval.txt = cut(qval, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",
    herramienta = "ALDEX2"
  ) %>%
  filter(pval < 0.05)
    # filter(qval < 0.1)


head(res_aldex2_prev_ASV_noBH_df)



```

### DESeq2

As previously described in the analysis without prevalence filtering,
DESeq2 models were applied following the authors' recommendations for
pre-filtering low-count features, particularly in cases with small
sample sizes (i.e., ≤ 10 samples in the smallest group). This filtering
step reduces the size of the dataset, improves computational efficiency,
and enhances the clarity of downstream analyses such as PCA and
dispersion plots by removing features with minimal biological signal.

In the current approach, we additionally applied a prevalence filter to
retain only those features that are present in a minimum proportion of
samples across the dataset. This step aims to further reduce noise and
focus the analysis on features that are consistently detected, thereby
potentially improving the robustness and interpretability of
differential abundance results.

```{r deseq2_prev_genus, message=FALSE, warning=FALSE}

set.seed(1234)

# DESeq2 pipeline
dds <- phyloseq_to_deseq2(physeq_filtered_genus, ~ TOX_SEVERA)

lowtox_group <- min(table(colData(dds)$TOX_SEVERA))
keep <- rowSums(counts(dds) >= 10) >= lowtox_group
diagdds <- dds[keep, ]

diagdds <- estimateSizeFactors(diagdds, type = "poscounts")
diagdds <- DESeq(diagdds, test = "Wald", fitType = "parametric")

res <- results(diagdds, cooksCutoff = TRUE)
res_df <- as.data.frame(res)

# raw p-values vs adjusted p-values (by BH)
# status labels
res_df <- res_df %>%
  dplyr::mutate(
    status = case_when(
      is.na(pvalue) & is.na(padj) ~ "outlier/zero counts",
      !is.na(pvalue) & is.na(padj) ~ "filtered (low count)",
      padj < 0.05 ~ "significant",
      TRUE ~ "non-significant"
    )
  )

table(res_df$status)

# Taxonomy table — include the columns you plan to use in plots
tax_tbl <- tax_table(physeq_filtered_genus) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::select(taxon_id, Phylum, Genus)


res_deseq2_df <- as.data.frame(res_df) %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    bacteria = dplyr::if_else(!is.na(Genus) & Genus != "", Genus, taxon_id)
  )

# Significant features — filter from the JOINED data (this was the bug)
alpha = 0.05
# sigtab = res[which(res$padj < alpha), ]
# sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq_filtered_genus)[rownames(sigtab), ], "matrix"))
sigtab <- subset(res_df, padj < alpha)
head(sigtab)

# # Phylum
# ordP <- sort(tapply(sigtab$log2FoldChange, sigtab[, "Phylum"], max, na.rm = TRUE), TRUE)
# sigtab$Phylum <- factor(sigtab[, "Phylum"], levels = names(ordP))
# # Genus
# ordG <- sort(tapply(sigtab$log2FoldChange, sigtab[, "Genus"], max, na.rm = TRUE), TRUE)
# sigtab$Genus <- factor(sigtab[, "Genus"], levels = names(ordG))

# theme_set(theme_bw())
# ggplot(sigtab, aes(x = Genus, y = log2FoldChange, color = Phylum)) +
#   geom_point(size = 3) +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
# Volcano plot
plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")
# 

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2 <- res_deseq2_df %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::filter(padj < 0.05) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.1, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
# Order Genus by current order for plotting
df_fig_deseq2$Genus  <- factor(df_fig_deseq2$Genus, levels = df_fig_deseq2$Genus)
df_fig_deseq2$direct <- factor(df_fig_deseq2$direct, levels = c("Positive LFC", "Negative LFC"))

# Plot — map fill to 'direct'; optionally map alpha to significance
fig_deseq2 <- ggplot(df_fig_deseq2, aes(x = Genus, y = log2FoldChange, fill = direct)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE),
                width = 0.2, color = "black") +
  # Optional: encode padj<0.01 with alpha instead of trying to color axis labels
  # scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = 0.6)) +
  labs(x = NULL, y = "Log fold change",
       title = "Log fold changes for Genus in DESeq2 analysis") +
  # scale_fill_discrete(name = NULL) +
  scale_fill_manual(values = c("Negative LFC" = "#22A884FF", "Positive LFC" = "#440154FF")) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1)
  )


print(fig_deseq2)



```

Filtering data by pvalue (0.05) conditions
```{r deseq2_prev_filtering_data_genus}
# res_filtered <- res[which(res$log2FoldChange > 20), ]
# res_filtered <- res[which(res$pvalue < 0.05), ]

res_df <- as.data.frame(res)
res_filtered <- subset(res_df, pvalue < 0.05)

# Taxonomy
taxa <- as.data.frame(tax_table(physeq_filtered_genus))
taxa_filtered <- taxa[rownames(res_filtered), , drop = FALSE]
# LFC
taxa_filtered$log2FoldChange <- res_filtered$log2FoldChange

taxa_summary <- taxa_filtered %>%
  dplyr::group_by(Genus) %>%
  dplyr::summarise(max_lfc = max(log2FoldChange, na.rm = TRUE), n = dplyr::n()) %>%
  dplyr::arrange(dplyr::desc(max_lfc))
print(head(taxa_summary, 20))

## Abundances
otu <- as.data.frame(otu_table(physeq_filtered_genus))
group <- sample_data(physeq_filtered_genus)$TOX_SEVERA
valid_taxa <- intersect(rownames(res_filtered), taxa_names(physeq_filtered_genus))
res_filtered_valid <- res_filtered[valid_taxa, , drop = FALSE]
otu_filtered <- otu[valid_taxa, , drop = FALSE]

otu_filtered$Genus <- tax_table(physeq_filtered_genus)[valid_taxa, "Genus"]

otu_grouped <- otu_filtered %>%
  dplyr::rename_with(~ make.names(.), .cols = where(is.numeric)) %>%
  dplyr::mutate(mean_all = rowMeans(dplyr::across(where(is.numeric)), na.rm = TRUE)) %>%
  dplyr::arrange(dplyr::desc(mean_all))

res_filtered_df <- as.data.frame(res_filtered)
res_filtered_df$Genus <- tax_table(physeq_filtered_genus)[rownames(res_filtered_df), "Genus"]
print(head(res_filtered_df))

```

Final DESeq2 results: 
```{r deseq2_prev_genus_res_df}

# without BH and pvalue (raw) < 0.05
res_deseq2_prev_noBH_df <- as.data.frame(res_filtered) %>%
  rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = as.character(tax_table(physeq_filtered_genus)[rownames(res_filtered), "Genus"]),
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,          # usamos pval como qval porque NO aplicamos BH
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",              # aquí marcamos que no se usó BH
    herramienta = "DESeq2"
  ) %>%
  #reordering
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  # filter(pval < 0.05)
    filter(qval < 0.1)



# with BH correction

res_deseq2_prev_BH_df <- as.data.frame(res_filtered) %>%
 rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = tax_table(physeq_filtered_genus)[rownames(res_filtered), "Genus"],
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "yes",             # aquí marcamos que sí se usó BH
    herramienta = "DESeq2"
  )  %>%
  #reordering
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  # filter(qval < 0.05)
    filter(qval < 0.1)


# Head
head(res_deseq2_prev_noBH_df)
head(res_deseq2_prev_BH_df)




```

#### **ASV**

```{r deseq2_prev_ASV,  message=FALSE, warning=FALSE}

set.seed(1234)

# DESeq2 pipeline
dds_ASV <- phyloseq_to_deseq2(physeq_filtered, ~ TOX_SEVERA)

lowtox_group <- min(table(colData(dds_ASV)$TOX_SEVERA))
keep <- rowSums(counts(dds_ASV) >= 10) >= lowtox_group
diagdds_ASV <- dds_ASV[keep, ]

diagdds_ASV <- estimateSizeFactors(diagdds_ASV, type = "poscounts")
diagdds_ASV <- DESeq(diagdds_ASV, test = "Wald", fitType = "local")

res <- results(diagdds_ASV, cooksCutoff = TRUE)
res_df <- as.data.frame(res)

# raw p-values vs adjusted p-values (by BH)
# status labels
res_df <- res_df %>%
  dplyr::mutate(
    status = case_when(
      is.na(pvalue) & is.na(padj) ~ "outlier/zero counts",
      !is.na(pvalue) & is.na(padj) ~ "filtered (low count)",
      padj < 0.05 ~ "significant",
      TRUE ~ "non-significant"
    )
  )

table(res_df$status)

# Taxonomy table — include the columns you plan to use in plots
tax_tbl <- tax_table(physeq_filtered) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::select(taxon_id, Phylum, Genus)


res_deseq2_df <- as.data.frame(res_df) %>%
  tibble::rownames_to_column("taxon_id") %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    bacteria = dplyr::if_else(!is.na(Genus) & Genus != "", Genus, taxon_id)
  )

# Significant features — filter from the JOINED data (this was the bug)
alpha = 0.05
# sigtab = res[which(res$padj < alpha), ]
# sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq_filtered_genus)[rownames(sigtab), ], "matrix"))
sigtab <- subset(res_df, padj < alpha)
head(sigtab)

# # Phylum
# ordP <- sort(tapply(sigtab$log2FoldChange, sigtab[, "Phylum"], max, na.rm = TRUE), TRUE)
# sigtab$Phylum <- factor(sigtab[, "Phylum"], levels = names(ordP))
# # Genus
# ordG <- sort(tapply(sigtab$log2FoldChange, sigtab[, "Genus"], max, na.rm = TRUE), TRUE)
# sigtab$Genus <- factor(sigtab[, "Genus"], levels = names(ordG))

# theme_set(theme_bw())
# ggplot(sigtab, aes(x = Genus, y = log2FoldChange, color = Phylum)) +
#   geom_point(size = 3) +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
# Volcano plot
plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")
# 

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2 <- res_deseq2_df %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::filter(padj < 0.05) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.1, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
# Order Genus by current order for plotting
df_fig_deseq2$Genus  <- factor(df_fig_deseq2$Genus, levels = df_fig_deseq2$Genus)
df_fig_deseq2$direct <- factor(df_fig_deseq2$direct, levels = c("Positive LFC", "Negative LFC"))

# Plot — map fill to 'direct'; optionally map alpha to significance
fig_deseq2 <- ggplot(df_fig_deseq2, aes(x = Genus, y = log2FoldChange, fill = direct)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE),
                width = 0.2, color = "black") +
  # Optional: encode padj<0.01 with alpha instead of trying to color axis labels
  # scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = 0.6)) +
  labs(x = NULL, y = "Log fold change",
       title = "Log fold changes for Genus in DESeq2 analysis") +
  # scale_fill_discrete(name = NULL) +
  scale_fill_manual(values = c("Negative LFC" = "#22A884FF", "Positive LFC" = "#440154FF")) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1)
  )


print(fig_deseq2)



```

```{r deseq2_prev_res_taxa}

res_df <- as.data.frame(res)
res_filtered <- subset(res_df, pvalue < 0.05)


taxa <- as.data.frame(tax_table(physeq_filtered)) # Taxa from taxonomy table
taxa_filtered <- taxa[rownames(res_filtered), , drop = FALSE] # Check rownames
taxa_filtered$log2FoldChange <- res_filtered$log2FoldChange # Log2FoldChange

## genus summarize
taxa_summary <- taxa_filtered %>%
  dplyr::group_by(Genus) %>%
  dplyr::summarise(max_lfc = max(log2FoldChange, na.rm = TRUE), n = dplyr::n()) %>%
  dplyr::arrange(dplyr::desc(max_lfc))
print(head(taxa_summary, 20))

## Abundances
otu <- as.data.frame(otu_table(physeq_filtered_genus))
group <- sample_data(physeq_filtered_genus)$TOX_SEVERA

## Validation
valid_taxa <- intersect(rownames(res_filtered), taxa_names(physeq_filtered_genus))
res_filtered_valid <- res_filtered[valid_taxa, , drop = FALSE]
otu_filtered <- otu[valid_taxa, , drop = FALSE]
otu_filtered$Genus <- tax_table(physeq_filtered_genus)[valid_taxa, "Genus"] # Genus validated

## Cleaning names 
otu_grouped <- otu_filtered %>%
  dplyr::rename_with(~ make.names(.), .cols = where(is.numeric)) %>%
  dplyr::mutate(mean_all = rowMeans(dplyr::across(where(is.numeric)), na.rm = TRUE)) %>%
  dplyr::arrange(dplyr::desc(mean_all))

## Savings as DFs
res_filtered_valid_df <- as.data.frame(res_filtered_valid)
res_filtered_valid_df$Genus <- as.character(tax_table(physeq_filtered_genus)[valid_taxa, "Genus", drop = FALSE][,1])
print(head(res_filtered_valid_df))




```


Final DESeq2 results: 

```{r DESeq2_prev_ASV_res_df}

# without BH and pvalue (raw) < 0.05
res_deseq2_prev_ASV_noBH_df <- as.data.frame(res_filtered) %>%
  rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = as.character(tax_table(physeq_filtered)[rownames(res_filtered), "Genus"]),
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,          # using pval as qval because noBH mode is evaluated
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "no",              # aquí marcamos que no se usó BH
    herramienta = "DESeq2"
  ) %>%
  #reordering
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  # filter(pval < 0.05)
    filter(qval < 0.1)



# with BH correction

res_deseq2_prev_ASV_BH_df <- as.data.frame(res_filtered) %>%
 rownames_to_column("feature") %>% 
  dplyr::mutate(
    Genus = tax_table(physeq_filtered)[rownames(res_filtered), "Genus"],
    bacteria = Genus,
    logFC = log2FoldChange,
    pval = pvalue,
    qval = padj,
    enrich_group = ifelse(logFC > 0, 1, 0),
    direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
    orientation = ifelse(enrich_group == 1,  1, -1),
    qval.txt = cut(qval,
                   breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                   labels = c("***", "**", "*", "-")),
    prev = "no",
    BH = "yes",             # aquí marcamos que sí se usó BH
    herramienta = "DESeq2"
  )  %>%
  #reordering
  dplyr::select(
    feature,
    baseMean, log2FoldChange, lfcSE, stat, pvalue, padj,
    Genus, bacteria,
    logFC, pval, qval, enrich_group, direction, orientation, qval.txt,
    prev, BH, herramienta
  ) %>%
  # filter(qval < 0.05)
    filter(qval < 0.1)


# Head
head(res_deseq2_prev_noBH_df)
head(res_deseq2_prev_BH_df)




```

### LEfSe

This analysis follows the same statistical approach as the previous
LEfSe section, but includes an additional **prevalence filtering step**,
retaining only features present in a minimum proportion of samples. This
aims to reduce the influence of rare, low-information features and
improve robustness in identifying biologically meaningful differences
between groups.

As before, both CPM and relative abundance transformations were used,
and **BH-adjusted *p*-values** were manually calculated to enable direct
comparison with other methods that apply multiple testing correction.

#### (CPM) LEfSe groups previous sum of 1e-06

NOTE: To ensure numerical stability during the LEfSe analysis, a small
pseudocount (1e-06) was added to all abundance values prior to
normalization. This step is essential because LEfSe applies logarithmic
transformations during its processing pipeline (e.g., after CPM or
relative abundance normalization), and zero values can lead to undefined
or unstable results when log-transformed. The pseudocount is small
enough to have negligible impact on relative differences but prevents
errors and maintains consistency across features during differential
abundance testing and LDA effect size estimation.

```{r lefse_cpm_prev,  message=FALSE, warning=FALSE, fig.height=10}
set.seed(391)

physeq_filtered_lefse <- physeq_filtered # renaming phyloseq object to include the pseudocount in lefse for reproducibility
colnames(tax_table(physeq_filtered_lefse))[1] = "Kingdom" # required by the tool

# Add pseudo-count  1e-06 in abundances  to avoid zeros

otu_table(physeq_filtered_lefse) <- otu_table(physeq_filtered_lefse) + 1e-06


tryCatch({
  
  # CPM
  mm_lefse_cpm_filt <- run_lefse(
    physeq_filtered_lefse,
    taxa_rank = "Genus",
    norm = "CPM",
    group = "TOX_SEVERA",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )
  
  if (!is.null(mm_lefse_cpm_filt@marker_table) &&
      nrow(mm_lefse_cpm_filt@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_cpm_filt@marker_table)) {
    
    head(marker_table(mm_lefse_cpm_filt))
    
    if (length(marker_table(mm_lefse_cpm_filt)$feature) > 0) {
      
      # Abundance plot
      p_abd <- plot_abundance(mm_lefse_cpm_filt, group = "TOX_SEVERA") +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(p_abd)
      
      # LDA BarPlot 
      plot_error_bar <- plot_ef_bar(mm_lefse_cpm_filt) +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(plot_error_bar)
      
      # BH adjustment
      lefse_cpm_filt_features_prev_BH <- mm_lefse_cpm_filt@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_cpm_filt_features_prev_BH[["padj"]] <- p.adjust(lefse_cpm_filt_features_prev_BH[["pvalue"]], method = "BH", n = 1045)
      lefse_cpm_filt_features_prev_BH
      
      # NoBH correction DF
      res_lefse_cpm_prev_noBH_df <- lefse_cpm_filt_features_prev_BH %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          prev = "yes",
          BH = "no",
          herramienta = "LEfSe"
        )
      
      # BH correction DF
      res_lefse_cpm_prev_BH_df <- lefse_cpm_filt_features_prev_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
          prev = "yes",
          BH = "yes",
          herramienta = "LEfSe"
        ) %>%
        dplyr::filter(qval < 0.1)
      
      ## Plotting after BH correction
      # Abundance plot
      p_abd <- plot_abundance(lefse_cpm_filt_features_prev_BH, group = "TOX_SEVERA") +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(p_abd)
      
      # LDA Bar-Plot
      plot_error_bar <- plot_ef_bar(lefse_cpm_filt_features_prev_BH) +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(plot_error_bar)

    } else {
      message("⚠️ No feature detection in LEfSe with CPM normalization.")
      lefse_cpm_filt_features_prev_ASV_BH <- NULL
    }

  } else {
    message(" Empty LEfSe or no feature detection")
    lefse_cpm_filt_features_prev_ASV_BH <- NULL
  }

}, error = function(e) {
  message("❌Error while running LEfSe with CPM normalization", conditionMessage(e))
  lefse_cpm_filt_features_prev_ASV_BH <- NULL
})



```


##### **ASV Level**

```{r lefse_cpm_ASV_prev, message=FALSE, warning=FALSE, fig.height=10}

set.seed(391)

physeq_filtered_lefse <- physeq_filtered
colnames(tax_table(physeq_filtered_lefse))[1] = "Kingdom"
# Add pseudo-count  1e-06 in abundances
otu_table(physeq_filtered_lefse) <- otu_table(physeq_filtered_lefse) + 1e-06


tryCatch({

  # CPM normalization
  mm_lefse_cpm_filt_ASV <- run_lefse(
    physeq_filtered_lefse,
    taxa_rank = "none",
    norm = "CPM",
    group = "TOX_SEVERA",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse_cpm_filt_ASV@marker_table) &&
      nrow(mm_lefse_cpm_filt_ASV@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_cpm_filt_ASV@marker_table)) {

    head(marker_table(mm_lefse_cpm_filt_ASV))

    if (length(marker_table(mm_lefse_cpm_filt_ASV)$feature) > 0) {


      # Mapping from original ps (no renaming)
      tax_tbl <- tax_table(physeq_filtered) %>% as.data.frame() %>% 
        rownames_to_column("ASV") %>%
        dplyr::mutate(pretty = dplyr::case_when(
          !is.na(Species) & Species != "" ~ paste(Genus, Species),
          !is.na(Genus)   & Genus   != "" ~ Genus,
          # !is.na(Family)  & Family  != "" ~ Family,
          TRUE ~ ASV
        )) %>%
        dplyr::mutate(pretty = make.unique(pretty, sep = "_"))
      
      # Relabel the marker table
      lab_map <- setNames(tax_tbl$pretty, tax_tbl$ASV)
      
      # Plots
      p_abd <- plot_abundance(mm_lefse_cpm_filt_ASV, group = "TOX_SEVERA") +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      # rename feature labels to genus names
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(p_abd)

      plot_error_bar <- plot_ef_bar(mm_lefse_cpm_filt_ASV) +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(plot_error_bar)

      # BH correction
      lefse_cpm_filt_features_prev_ASV_BH <- mm_lefse_cpm_filt_ASV@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_cpm_filt_features_prev_ASV_BH[["padj"]] <- p.adjust(lefse_cpm_filt_features_prev_ASV_BH[["pvalue"]], method = "BH", n = 1045)
      lefse_cpm_filt_features_prev_ASV_BH

      # NoBh
      res_lefse_cpm_prev_ASV_noBH_df <- lefse_cpm_filt_features_prev_ASV_BH %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA ~~~ logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature final = (ASV/taxon)
          bacteria  = genus,                # <- bacteria = clean genus           
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          prev = "yes",
          BH = "no",
          herramienta = "LEfSe"
        )
      
      res_lefse_cpm_prev_ASV_BH_df <- lefse_cpm_filt_features_prev_ASV_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA ~~~ logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature final = (ASV/taxon)
          bacteria  = genus,                # <- bacteria = clean genus           
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "yes",
         BH = "yes",
          herramienta = "LEfSe"
      )  %>%
        dplyr::filter(qval < 0.1)

    } else {
      message("⚠️ No feature detection in LEfSe with CPM normalization.")
      lefse_cpm_filt_features_prev_ASV_BH <- NULL
    }

  } else {
    message(" Empty LEfSe or no feature detection")
    lefse_cpm_filt_features_prev_ASV_BH <- NULL
  }

}, error = function(e) {
  message("❌Error while running LEfSe with CPM normalization", conditionMessage(e))
  lefse_cpm_filt_features_prev_ASV_BH <- NULL
})





```

#### (RELAB) LEfSe groups previous sum of 1e-06

NOTE: To ensure numerical stability during the LEfSe analysis, a small
pseudocount (1e-06) was added to all abundance values prior to
normalization. This step is essential because LEfSe applies logarithmic
transformations during its processing pipeline (e.g., after CPM or
relative abundance normalization), and zero values can lead to undefined
or unstable results when log-transformed. The pseudocount is small
enough to have negligible impact on relative differences but prevents
errors and maintains consistency across features during differential
abundance testing and LDA effect size estimation.

```{r lefse_relab_prev,  message=FALSE, warning=FALSE, fig.height=10}

set.seed(853)

physeq_filtered_lefse <- physeq_filtered_genus
colnames(tax_table(physeq_filtered_lefse))[1] = "Kingdom"

# summing 1e-06 in abundances
otu_table(physeq_filtered_lefse) <- otu_table(physeq_filtered_lefse) + 1e-06


tryCatch({

  mm_lefse_filt <- run_lefse(
    physeq_filtered_lefse,
    taxa_rank = "Genus",
    norm = "TSS",
    group = "TOX_SEVERA",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse_filt@marker_table) &&
      nrow(mm_lefse_filt@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_filt@marker_table)) {

    head(marker_table(mm_lefse_filt))

    if (length(marker_table(mm_lefse_filt)$feature) > 0) {

      p_abd <- plot_abundance(mm_lefse_filt, group = "TOX_SEVERA") +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(p_abd)

      plot_error_bar <- plot_ef_bar(mm_lefse_filt) +
        scale_fill_manual(
          values = c("0" = "#22A884FF", "1" = "#440154FF"),
          labels = c("Low_tox", "Severe_tox")
        )
      print(plot_error_bar)

      print("BH correction  processing...")

      lefse_ra_filt_features_prev_BH <- mm_lefse_filt@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_ra_filt_features_prev_BH[["padj"]] <- p.adjust(mm_lefse_filt@marker_table[["pvalue"]], method = "BH", n = 1045)
      # lefse_ra_filt_features_prev_BH
      res_lefse_ra_prev_noBH_df <-lefse_ra_filt_features_prev_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          prev = "yes",
          BH = "no",
          herramienta = "LEfSe"
        )
      
      # With BH correction
      res_lefse_ra_prev_BH_df <- lefse_ra_filt_features_prev_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "yes",
         BH = "yes",
          herramienta = "LEfSe"
        )  %>%
        dplyr::filter(qval < 0.1)
      
      # only getting bacteria with padj < 0.05
      # res_lefse_ra_prev_BH_df <- res_lefse_ra_prev_BH_df %>%
      #   dplyr::filter(qval < 0.1)
      head(res_lefse_ra_prev_BH_df)

    }

  } else {
    message("⚠️ No differential markers found or marker_table is not valid.")
    lefse_ra_filt_features_prev_BH <- NULL
  }

}, error = function(e) {
  message("❌ Error running LEfSe with TSS normalization: ", conditionMessage(e))
  lefse_ra_filt_features_prev_BH <- NULL
})




```

##### **ASV LEVEL**

```{r lefse_relab_ASV_prev,  message=FALSE, warning=FALSE, fig.height=10}

set.seed(853)

physeq_filtered_lefse <- physeq_filtered_genus
colnames(tax_table(physeq_filtered_lefse))[1] = "Kingdom"

# summing 1e-06 in abundances
otu_table(physeq_filtered_lefse) <- otu_table(physeq_filtered_lefse) + 1e-06

tryCatch({

  mm_lefse_filt_ra <- run_lefse(
    physeq_filtered_lefse,
    taxa_rank = "none",
    norm = "TSS",
    group = "TOX_SEVERA",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    multigrp_strat = TRUE,
    lda_cutoff = 0
  )

  if (!is.null(mm_lefse_filt_ra@marker_table) &&
      nrow(mm_lefse_filt_ra@marker_table) > 0 &&
      "feature" %in% colnames(mm_lefse_filt_ra@marker_table)) {

    head(marker_table(mm_lefse_filt_ra))

    if (length(marker_table(mm_lefse_filt_ra)$feature) > 0) {

      # Mapping from original ps (no renaming)
      tax_tbl <- tax_table(physeq_filtered) %>% as.data.frame() %>% 
        rownames_to_column("ASV") %>%
        dplyr::mutate(pretty = dplyr::case_when(
          !is.na(Species) & Species != "" ~ paste(Genus, Species),
          !is.na(Genus)   & Genus   != "" ~ Genus,
          # !is.na(Family)  & Family  != "" ~ Family,
          TRUE ~ ASV
        )) %>%
        dplyr::mutate(pretty = make.unique(pretty, sep = "_"))
      
      # Relabel the marker table

      lab_map <- setNames(tax_tbl$pretty, tax_tbl$ASV)
      
      # Plots
      p_abd <- plot_abundance(mm_lefse_filt_ra, group = "TOX_SEVERA") +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      # rename features
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(p_abd)

      plot_error_bar <- plot_ef_bar(mm_lefse_filt_ra) +
      ggplot2::scale_fill_manual(
        values = c("0" = "#22A884FF", "1" = "#440154FF"),
        labels = c("Low_tox","Severe_tox")
      ) +
      ggplot2::scale_y_discrete(labels = function(x) ifelse(x %in% names(lab_map), lab_map[x], x)) +
      ggplot2::guides(fill = ggplot2::guide_legend(title = "Grupo"))
    
      print(plot_error_bar)



      print("BH correction  processing...")

      lefse_ra_filt_features_prev_BH <- mm_lefse_filt_ra@marker_table[, c("feature", "enrich_group", "ef_lda", "pvalue")]
      lefse_ra_filt_features_prev_BH[["padj"]] <- p.adjust(mm_lefse_filt_ra@marker_table[["pvalue"]], method = "BH", n = 1045)
      # lefse_ra_filt_features_prev_BH
      res_lefse_ra_ASV_prev_noBH_df <-lefse_ra_filt_features_prev_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature final = (ASV/taxon)
          bacteria  = genus,                # <- bacteria = clean genus           
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          prev = "yes",
          BH = "no",
          herramienta = "LEfSe"
        )
      
      # With BH correction
      res_lefse_ra_ASV_prev_BH_df <- lefse_ra_filt_features_prev_BH  %>%
        as.tibble() %>%
        dplyr::rename(
          bacteria = feature,
          logFC = ef_lda,  # LDA como proxy de logFC
          pval = pvalue,
          qval = padj
        ) %>%
        dplyr::mutate(
          original_feature = bacteria,
          genus_raw = unname(as.character(lab_map[original_feature])),
          genus     = clean_tax_label(genus_raw),
          feature   = original_feature,     # <- feature final = (ASV/taxon)
          bacteria  = genus,                # <- bacteria = clean genus           
          direction = ifelse(enrich_group == 1, "Positive LFC", "Negative LFC"),
          orientation = ifelse(enrich_group == 1, 1, -1),
          qval.txt = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", "-")),
          # significativo = ifelse(padj < 0.05, TRUE, FALSE),
         prev = "yes",
         BH = "yes",
          herramienta = "LEfSe"
        )  %>%
        dplyr::filter(qval < 0.1)
      

      head(res_lefse_ra_prev_BH_df)

    }

  } else {
    message("⚠️ No differential markers found or marker_table is not valid.")
    lefse_ra_filt_features_prev_BH <- NULL
  }

}, error = function(e) {
  message("❌ Error running LEfSe with TSS normalization: ", conditionMessage(e))
  lefse_ra_filt_features_prev_BH <- NULL
})




```

### LinDA (TOX_SEVERA with Prevalence Filtering)

As described in the previous section, LinDA applies a linear modeling
approach to compositional microbiome data using CLR transformation and
permutation-based inference. In this analysis, we additionally applied a
**prevalence filter** prior to modeling, retaining only features present
in a minimum proportion of samples. This step aims to reduce noise from
rare features and focus the differential abundance analysis on more
consistently detected taxa.

As before, both raw and Benjamini–Hochberg (BH) adjusted *p*-values were
calculated to assess the effect of multiple testing correction on
feature selection.

```{r linda_prev,  message=FALSE, warning=FALSE}

set.seed(1274)

otu.tab.filt <- as.data.frame(t(otu_table(physeq_filtered_genus)))#[, ind])
meta.filt <- cbind.data.frame(tox = factor(sample_data(physeq_filtered_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered_genus)$sex),
                         Site = factor(sample_data(physeq_filtered_genus)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         tnm = factor(sample_data(physeq_filtered_genus)$tnm), 
                         age_group = factor(sample_data(physeq_filtered_genus)$age_group) 
                         )

# ind1 <- which(meta.filt$tox == 'low')
# res.low.filt <- linda(otu.tab.filt[, ind1], meta.filt[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta.filt$tox == 'sev')
# res.sev.filt <- linda(otu.tab.filt[, ind2], meta.filt[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low.filt$output[[1]])[which(res.low.filt$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev.filt$output[[1]])[which(res.sev.filt$output[[1]]$reject)]
linda.obj.tox.filt <- linda(otu.tab.filt, meta.filt, formula = '~tox', alpha = 0.05,
prev.cut = 0, lib.cut = 1000, winsor.quan = 0.97)
# linda.obj.tox.sex <- linda(otu.tab, meta, formula = '~tox+Sex', alpha = 0.1,
#                    prev.cut = 0.1, lib.cut = 1000, winsor.quan = 0.97)
linda.plot(linda.obj.tox.filt, c('toxsev', 'Sexmale'), 
           titles = c('tox: low v.s. sev and female vs male'), alpha = 0.1, lfc.cut = 1,
           legend = TRUE, directory = NULL, width = 11, height = 8)

# taxa
# See which terms you tested:
term.names.tox.filt <- names(linda.obj.tox.filt$output)
# print(term.names.tox.filt)
# e.g.: [1] "SiteRight" "Sexmale"

# For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.filt <- lapply(term.names.tox.filt, function(tnm) {
  df <- linda.obj.tox.filt$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.filt) <- term.names.tox.filt

# Look at them
# sig.list.tox.filt
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# get **all** unique taxa that show up anywhere
all.sig.taxa.tox.filt <- unique( unlist(sig.list.tox.filt) )
# all.sig.taxa.tox.filt

# taxa names
matched.tox.filt <- match(all.sig.taxa.tox.filt, rownames(tax_table(physeq_filtered_genus)))
sig_tax_df.tox.filt <- tax_table(physeq_filtered_genus)[matched.tox.filt, ]
# sig_tax_df.tox.filt # "s__Bacteroides_vulgatus" en ambos asvs

# Debugging: 
# tax_table(physeq_filtered_genus)[match("9df251784dde31e05f02b2ee1029d71c", tax_table(physeq_filtered_genus)), ]

# All linda obj sub dfs into one
linda_df_tox.filt <- imap_dfr(linda.obj.tox.filt$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Colnames: estimate, std.error, p.value, p.adj, reject, taxa, term
head(linda_df_tox.filt)


```

Without BH correction

```{r linda_prev_genus_plot_noBH}

# Data preparation
df_noBH <- linda.obj.tox.filt$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val 
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(physeq_filtered_genus) %>%           # tax table
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH <- df_fig_noBH %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    # symbol † to  p-only
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )

# Plot of LinDA without BH correction
linda_plot_genus_prev_noBH <- linda_plot(df_fig_noBH)
linda_plot_genus_prev_noBH


```

With BH correction As LinDA shows a strict criteria, we are showing and
retaining the features that shows at least qval \< 0.1.

```{r linda_prev_genus_plot_BH}

df_fig <- linda.obj.tox.filt$output$toxsev %>%        # data.frame 
  tibble::rownames_to_column("taxon_id") %>% # ASV to column
  filter(reject) %>%   
  transmute(
    taxon_id,
    logFC        = log2FoldChange,   # log2FoldChange
    se         = lfcSE,      # standar error
    qval       = padj,      # q‑value (padj)
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    qval_txt   = ifelse(qval < 0.001, "***",
                     ifelse(qval < 0.01, "**",
                     ifelse(qval < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(abs(logFC) > 1 | qval < 0.1) %>%        # free adjust
  # optional: 
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%  # TODO: remove it
  arrange(logFC)

# alpha scale
df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("Inf", "0.01", "0.05")))

# Adding Genus to identify the feature
tax_tbl <- tax_table(physeq_filtered_genus) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig <- df_fig %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))


## Plotting
# Plot of LinDA with BH correction
linda_plot_genus_prev_BH <- linda_plot(df_fig)
linda_plot_genus_prev_BH


```

```{r}


# Without BH

res_linda_prev_noBH_df <- linda.obj.tox.filt$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>% # 
  # dplyr::filter(reject) %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::transmute(
    feature = taxon_id, 
    bacteria = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    logFC        = log2FoldChange,   # log2FoldChange
    pvalue = pvalue, 
    padj = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                     ifelse(padj < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "Genus",
        prev = "yes",
         BH = "no",
         herramienta = "LINDA"
  ) %>%
  # optional: filters
  # filter(abs(logFC) > 1 | pvalue < 0.1) %>%        # 0.05 dplyr::filter(abs(logFC) > 1 & padj < 0.1) %>%
  # optional: 
  dplyr::filter(abs(logFC) > 1 & pvalue < 0.05) %>%
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC)

res_linda_prev_noBH_df

# With BH

res_linda_prev_BH_df <- linda.obj.tox.filt$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>% # 
  # dplyr::filter(reject) %>% #  default=0.05 LinDA
  # dplyr::left_join(tax_tbl, by = "ASV") %>%
  dplyr::left_join(tax_tbl, by = "taxon_id")  %>%
  dplyr::transmute(
    feature = taxon_id, 
    bacteria = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    logFC        = log2FoldChange,   # log2FoldChange
    pvalue = pvalue, 
    padj = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                     ifelse(padj < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "Genus",
        prev = "yes",
         BH = "yes",
         herramienta = "LINDA"
  ) %>%
  dplyr::filter(abs(logFC) > 1 & padj < 0.1) %>% 
  # optional: 
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC)
  
res_linda_prev_BH_df

```

#### ASV LEVEL

```{r linda_prev_ASV,  message=FALSE, warning=FALSE}

set.seed(1274)

otu.tab.filt <- as.data.frame(t(otu_table(physeq_filtered)))#[, ind])
meta.filt <- cbind.data.frame(tox = factor(sample_data(physeq_filtered)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered)$sex),
                         Site = factor(sample_data(physeq_filtered)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         tnm = factor(sample_data(physeq_filtered)$tnm), 
                         age_group = factor(sample_data(physeq_filtered)$age_group) 
                         )

# ind1 <- which(meta.filt$tox == 'low')
# res.low.filt <- linda(otu.tab.filt[, ind1], meta.filt[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta.filt$tox == 'sev')
# res.sev.filt <- linda(otu.tab.filt[, ind2], meta.filt[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low.filt$output[[1]])[which(res.low.filt$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev.filt$output[[1]])[which(res.sev.filt$output[[1]]$reject)]
linda.obj.tox.filt.ASV <- linda(otu.tab.filt, meta.filt, formula = '~tox', alpha = 0.05,
                   prev.cut = 0, lib.cut = 1000, winsor.quan = 0.97)
# linda.obj.tox.sex <- linda(otu.tab, meta, formula = '~tox+Sex', alpha = 0.1,
#                    prev.cut = 0.1, lib.cut = 1000, winsor.quan = 0.97)
linda.plot(linda.obj.tox.filt.ASV, c('toxsev', 'Sexmale'), 
           titles = c('tox: low v.s. sev and female vs male'), alpha = 0.1, lfc.cut = 1,
           legend = TRUE, directory = NULL, width = 11, height = 8)

# taxa
#  See which terms you tested:
term.names.tox.filt <- names(linda.obj.tox.filt.ASV$output)
# print(term.names.tox.filt)
# e.g.: [1] "SiteRight" "Sexmale"

#  For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.filt <- lapply(term.names.tox.filt, function(tnm) {
  df <- linda.obj.tox.filt$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.filt) <- term.names.tox.filt

# Look at them
# sig.list.tox.filt
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# (Optional) get **all** unique taxa that show up anywhere
all.sig.taxa.tox.filt <- unique( unlist(sig.list.tox.filt) )
# all.sig.taxa.tox.filt

# taxa names
matched.tox.filt <- match(all.sig.taxa.tox.filt, rownames(tax_table(physeq_filtered)))
sig_tax_df.tox.filt <- tax_table(physeq_filtered)[matched.tox.filt, ]
# sig_tax_df.tox.filt # "s__Bacteroides_vulgatus" en ambos asvs

# tax_table(physeq_filtered_genus)[match("9df251784dde31e05f02b2ee1029d71c", tax_table(physeq_filtered_genus)), ]


linda_df_tox.filt.ASV <- imap_dfr(linda.obj.tox.filt.ASV$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    
             term  = .y)              
)

head(linda_df_tox.filt.ASV)


```

Without BH correction

```{r linda_prev_plot_noBH}

# Data preparation
df_noBH_ASV <- linda.obj.tox.filt.ASV$output$toxsev %>%
   tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val 
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH_ASV <- df_noBH_ASV %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH_ASV <- df_fig_noBH_ASV %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(physeq_filtered) %>%          
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH_ASV_2 <- df_fig_noBH_ASV %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH_ASV_2 <- df_fig_noBH_ASV_2 %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†",""))) # symbol † to  p-only
  )

# Plot of LinDA with BH correction
linda_plot_ASV_prev_noBH <- linda_plot(df_fig_noBH_ASV_2)
linda_plot_ASV_prev_noBH


```

With BH correction As LinDA shows a strict criteria, we are showing and
retaining the features that shows at least qval \< 0.1.

```{r linda_prev_plot_BH}

## EXTRACTING AND PREPARING THE DATA
df_fig_ASV <- linda.obj.tox.filt.ASV$output$toxsev %>%       
  tibble::rownames_to_column("taxon_id") %>% # 
  filter(reject) %>%   
  transmute(
    taxon_id,
    logFC        = log2FoldChange,   # log2FoldChange
    se         = lfcSE,      # standar error
    qval       = padj,      # q‑value (padj)
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    qval_txt   = ifelse(qval < 0.001, "***",
                     ifelse(qval < 0.01, "**",
                     ifelse(qval < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "tox (sev vs low)"
  ) %>%
  filter(abs(logFC) > 1 | qval < 0.1) %>%        
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>% 
  arrange(logFC)

## scaling (alpha) 
df_fig_ASV <- df_fig_ASV %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("Inf", "0.01", "0.05")))

# Extract taxonomy table + attach rownames as "ASV"
tax_tbl <- tax_table(physeq_filtered) %>%          
  as.data.frame() %>%
  tibble::rownames_to_column("taxon_id") %>%  
  # tibble::rownames_to_column("ASV") %>% # <--- here, ASV = rownames of phyloseq
  dplyr::select(taxon_id, Genus)

# Join your LinDA results with taxonomy
df_fig_ASV <- df_fig_ASV %>%
  # dplyr::rename(ASV = ASV) %>%              # match key
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(
    label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id) # prefer genus name
  )

# Plot of LinDA with BH correction
linda_plot_ASV_prev_BH <- linda_plot(df_fig_ASV)
linda_plot_ASV_prev_BH

```

```{r linda_filt_res_df}


# Without BH

res_linda_prev_ASV_noBH_df <- linda.obj.tox.filt.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>% # 
  # dplyr::filter(reject) %>%
  # dplyr::left_join(tax_tbl, by = c("ASV" = "ASV")) %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::transmute(
    feature = taxon_id, 
    bacteria = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    logFC        = log2FoldChange,   # log2FoldChange
    pvalue = pvalue, 
    padj = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                     ifelse(padj < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "Genus",
        prev = "yes",
         BH = "no",
         herramienta = "LINDA"
  ) %>%
  dplyr::filter(abs(logFC) > 1 & pvalue < 0.05) %>%
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC)

res_linda_prev_ASV_noBH_df

# With BH

res_linda_prev_ASV_BH_df <- linda.obj.tox.filt.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>% # 
  # dplyr::filter(reject) %>%  # 
  # dplyr::left_join(tax_tbl, by = c("ASV" = "ASV")) %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::transmute(
    feature = taxon_id, 
    bacteria = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id),
    logFC        = log2FoldChange,   # log2FoldChange
    pvalue = pvalue, 
    padj = padj,
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                     ifelse(padj < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "Genus",
        prev = "yes",
         BH = "yes",
         herramienta = "LINDA"
  ) %>%
  dplyr::filter(abs(logFC) > 1 & padj < 0.1) %>% 
  dplyr::filter(!grepl("Incertae|uncultured", bacteria, ignore.case = TRUE)) %>%
  dplyr::arrange(logFC)
  
res_linda_prev_ASV_BH_df

```

### ZicoSeq

As previously described, ZicoSeq is a linear model– and
permutation-based method designed for zero-inflated compositional data.
In this section, we applied an additional **prevalence filtering** step
prior to analysis, retaining only features detected in a minimum
proportion of samples. This filtering helps reduce the influence of rare
features and improves the stability of the reference-based normalization
and permutation testing procedures.

Raw and permutation-adjusted *p*-values (FDR) were again used to
evaluate the impact of multiple testing correction on the detection of
differentially abundant features.

```{r zicoseq_prev,  message=FALSE, warning=FALSE}

set.seed(5234)


otu_tab_ZS <- as(otu_table(physeq_filtered_genus), "matrix") # otu_table(tox_ps_final)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1
# metadata
# features as columns and samples as rows.

metadata_ZS <- cbind.data.frame(sampleid = (sample_data(physeq_filtered_genus)$biosample_name),
                         tox = factor(sample_data(physeq_filtered_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered_genus)$sex),
                         Age = factor(sample_data(physeq_filtered_genus)$age_group),
                         Site = factor(sample_data(physeq_filtered_genus)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         metastasis = factor(sample_data(physeq_filtered_genus)$has_metastasis),
                         row.names = rownames(sample_data(physeq_filtered_genus)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox',feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) #,  adj.name = 'Sex', 
                    # # Winsorization to replace outliers
                    # is.winsor = TRUE, outlier.pct = 0.03, winsor.end = 'top',
                    # # Posterior sampling 
                    # is.post.sample = FALSE, post.sample.no = 25, 
                    # # Use the square-root transformation
                    # link.func = list(function (x) x^0.5), stats.combine.func = max,
                    # # Permutation-based multiple testing correction
                    # perm.no = 99,  strata = NULL, 
                    # # Reference-based multiple stage normalization
                    # ref.pct = 0.5, stage.no = 6, excl.pct = 0.2,
                    # # Family-wise error rate control
                     # is.fwer = TRUE, verbose = TRUE, return.feature.dat = TRUE)


ZicoSeq.plot(ZicoSeq.obj, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r unfilt_tox_extracting_zicoseq_taxa}

#  Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj$coef.list[[1]])), 
]

# Extract raw and adjusted p-values
pvals <- ZicoSeq.obj$p.raw
names(pvals) <- rownames(ZicoSeq.obj$R2)

qvals <- ZicoSeq.obj$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj$R2)

#  Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(tox_ps_final))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_prev_NoBH <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "no",
    method       = "ZicoSeq"
  ) %>%
filter(abs(logFC) > 1 & qval < 0.1)

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_prev_BH <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "yes",
    method       = "ZicoSeq"
  )  %>%
filter(abs(logFC) > 1 | qval < 0.1)

### -------- Combine both results -------- ###
# res_zicoseq_prev <- bind_rows(res_zicoseq_prev_NoBH, res_zicoseq_prev_BH)

```

#### ZicoSeq Plot

```{r zicoseq_unf_plot_genus, fig.height=10}

#  Plot 1: Without BH correction
p1_prenobh <- plot_logFC_bar(res_zicoseq_prev_NoBH, "ZicoSeq (Prevalence No BH correction)")
p1_prenobh
#  Plot 2: With BH correction
p2_prebh <- plot_logFC_bar(res_zicoseq_prev_BH, "ZicoSeq (Prevalence With BH correction)")
p2_prebh

```

#### **ASV**

```{r zicoseq_prev_ASV,  message=FALSE, warning=FALSE}

set.seed(5234)


otu_tab_ZS <- as(otu_table(physeq_filtered), "matrix") # otu_table(tox_ps_final)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1
# metadata
# features as columns and samples as rows.
metadata_ZS <- cbind.data.frame(sampleid = (sample_data(physeq_filtered)$biosample_name),
                         tox = factor(sample_data(physeq_filtered)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered)$sex),
                         Age = factor(sample_data(physeq_filtered)$age_group),
                         Site = factor(sample_data(physeq_filtered)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         metastasis = factor(sample_data(physeq_filtered)$has_metastasis),
                         row.names = rownames(sample_data(physeq_filtered)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj.ASV <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox',feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) #,  adj.name = 'Sex', 
                    # # Winsorization to replace outliers
                    # is.winsor = TRUE, outlier.pct = 0.03, winsor.end = 'top',
                    # # Posterior sampling 
                    # is.post.sample = FALSE, post.sample.no = 25, 
                    # # Use the square-root transformation
                    # link.func = list(function (x) x^0.5), stats.combine.func = max,
                    # # Permutation-based multiple testing correction
                    # perm.no = 99,  strata = NULL, 
                    # # Reference-based multiple stage normalization
                    # ref.pct = 0.5, stage.no = 6, excl.pct = 0.2,
                    # # Family-wise error rate control
                     # is.fwer = TRUE, verbose = TRUE, return.feature.dat = TRUE)


ZicoSeq.plot(ZicoSeq.obj.ASV, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r unfilt_tox_extracting_zicoseq_taxa_ASV}

#  Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj.ASV$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj$coef.list[[1]])), 
]

#  Extract raw and adjusted p-values
pvals <- ZicoSeq.obj.ASV$p.raw
names(pvals) <- rownames(ZicoSeq.obj.ASV$R2)

qvals <- ZicoSeq.obj.ASV$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj.ASV$R2)

#  Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(physeq_filtered))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_prev_ASV_NoBH <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "no",
    method       = "ZicoSeq"
  ) %>%
filter(abs(logFC) > 1) #& qval < 0.1)

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_prev_ASV_BH <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "yes",
    method       = "ZicoSeq"
  )  %>%
filter(abs(logFC) > 1 | qval < 0.1)

### -------- Combine both results -------- ###
# res_zicoseq_prev <- bind_rows(res_zicoseq_prev_NoBH, res_zicoseq_prev_BH)

```

#### ZicoSeq Plot

```{r zicoseq_unf_plot, fig.height=10}

#  Plot 1: Without BH correction
p1_prenobh <- plot_logFC_bar(res_zicoseq_prev_ASV_NoBH, "ZicoSeq (Prevalence No BH correction) in ASV")

#  Plot 2: With BH correction

print(p1_prenobh)

if(length(res_zicoseq_prev_ASV_BH) == 0){
  print("No significant ASV features were found on Zicoseq while evaluating prevalence filter.")
} else{
  p2_prebh <- plot_logFC_bar(res_zicoseq_prev_ASV_BH, "ZicoSeq (Prevalence With BH correction) in ASV")
  print(p2_prebh)
}



```


# Evaluating common and uncommon bacteria
In this section we are detecting and visualizing the bacteria that are common between some (or all) the methods, as well as the unique biomarker detected by each method + approach. 

```{r res_dfs, include=FALSE,  echo=FALSE, message=FALSE}
# Retaining only result dfs (starting by res)
res_dfs_names <- ls(pattern = "^res_")
res_dfs_names <- res_dfs_names[!grepl("^res_filtered", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("^res_filtered_df", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("^res_filtered_valid_df", res_dfs_names)]# res_filtered_valid_df
res_dfs_names <- res_dfs_names[!grepl("^res_dfs", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("^res_df", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("^res_shr", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("^res_deseq2_df", res_dfs_names)]
# res_dfs_names <- res_dfs_names[!grepl("^res_zicoseq_prev", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("^res_mat", res_dfs_names)]
res_dfs_names <- res_dfs_names[!grepl("cov", res_dfs_names)]



# dfs list
res_dfs <- mget(res_dfs_names)
# head(res_dfs)


```

<!-- NOTE: Uncomment these two chunks below in case you want to check bacteria per df and common and uncommon bacteria -->

<!-- ```{r format_bacteria_names, echo=FALSE, message=FALSE} -->

<!-- res_dfs_v1 <- lapply(res_dfs, function(df) { -->
<!--   if (is.data.frame(df) && "bacteria" %in% colnames(df)) { -->
<!--     df$bacteria <- as.character(df$bacteria) -->
<!--     df$bacteria <- extracting_genus(df$bacteria) -->
<!--   } -->
<!--   return(df) -->
<!-- }) -->

<!-- res_dfs_v1 <- map(res_dfs_v1, ~ -->
<!--   .x %>% -->
<!--     transmute(bacteria = bacteria %>% -->
<!--                 sub(".*\\|", "", .) %>% -->
<!--                 str_remove("^[A-Za-z]+__") %>% -->
<!--                 str_remove("_[A-Za-z]+__$")) %>% -->
<!--     distinct(bacteria) -->
<!-- ) -->
<!-- res_dfs_v1 -->

<!-- bacterias_por_df <- lapply(res_dfs_v1, function(df) { -->
<!--   if (is.data.frame(df) && "bacteria" %in% colnames(df)) { -->
<!--     return(unique(df$bacteria)) -->
<!--   } else { -->
<!--     return(character(0))  # si no es válido, devuelve un vector vacío -->
<!--   } -->
<!-- }) -->


<!-- print("Unique DF of Bacterias from all res dfs") -->
<!-- head(bacterias_por_df) -->

<!-- # length(unique(df$bacteria)) # Before -->
<!-- # length(unique(extracting_genus(df$bacteria))) # After -->



<!-- ``` -->



<!-- ```{r bact_common_uncommon,  echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- # Common bacteria -->
<!-- bacterias_comunes <- Reduce(intersect, bacterias_por_df) -->

<!-- print("common bacteria") -->
<!-- bacterias_comunes -->

<!-- # almost common bacteria -->
<!-- n_listas <- length(bacterias_por_df) -->
<!-- tabla <- table(unlist(lapply(bacterias_por_df, unique))) -->
<!-- comunes_5 <- names(tabla[tabla >= 5]) -->
<!-- comunes_5 -->

<!-- print("########") -->
<!-- print("--------") -->
<!-- print("########") -->


<!-- # No-common bacteria -->
<!-- bacterias_union <- Reduce(union, bacterias_por_df) -->
<!-- bacterias_no_comunes <- setdiff(bacterias_union, bacterias_comunes) -->
<!-- print("Uncommon bacteria") -->
<!-- bacterias_no_comunes -->

<!-- ``` -->

<!-- NOTE: Uncomment these two chunks above in case you want to check bacteria per df and common and uncommon bacteria -->


# Paper Plots

```{r creating_df_presence_prev_noprev, echo=FALSE, warning=FALSE}

#  Name list
stopifnot(length(res_dfs) == length(res_dfs_names))
names(res_dfs) <- res_dfs_names

# Full sanitized copy (keep ALL columns for orientation)
res_dfs_full <- lapply(res_dfs, function(df) {
  if (!is.data.frame(df)) return(df)
  if (!"bacteria" %in% names(df)) df <- tibble::rownames_to_column(df, "bacteria")
  df$bacteria <- sanitize_bacteria(df$bacteria)
  df <- df[!is.na(df$bacteria), , drop = FALSE]
  df
})

#  Presence-only copy (distinct bacteria)
res_dfs_presence <- map(res_dfs_full, ~
  .x %>%
    transmute(
      bacteria = bacteria %>%
        sub(".*\\|", "", .) %>%
        str_remove("^[A-Za-z]+__") %>%
        str_remove("_[A-Za-z]+__$")
    ) %>%
    distinct(bacteria) %>%
    filter(!is.na(bacteria), bacteria != "")
)

#  Split groups
noprev_names <- res_dfs_names[grepl("noprev", res_dfs_names)]
prev_names   <- setdiff(res_dfs_names[grepl("prev",  res_dfs_names)], noprev_names)

res_dfs_noprev_presence <- res_dfs_presence[noprev_names]
res_dfs_prev_presence   <- res_dfs_presence[prev_names]

res_dfs_noprev_full <- res_dfs_full[noprev_names]
res_dfs_prev_full   <- res_dfs_full[prev_names]

#  Build presence matrices
bacterias_noprev <- unique(unlist(lapply(res_dfs_noprev_presence, `[[`, "bacteria")))
bacterias_prev   <- unique(unlist(lapply(res_dfs_prev_presence,   `[[`, "bacteria")))

df_presence_noprev <- data.frame(bacteria = bacterias_noprev, stringsAsFactors = FALSE)
df_presence_prev   <- data.frame(bacteria = bacterias_prev,   stringsAsFactors = FALSE)

df_presence_noprev <- fill_presence(df_presence_noprev, res_dfs_noprev_presence)
df_presence_prev   <- fill_presence(df_presence_prev,   res_dfs_prev_presence)

df_presence_noprev <- drop_incertae(df_presence_noprev)
df_presence_prev   <- drop_incertae(df_presence_prev)

assert_no_na(df_presence_noprev, "df_presence_noprev")
assert_no_na(df_presence_prev,   "df_presence_prev")

#  Orientation builder (uses effect columns or enrich_group fallback)


orient_prev_long   <- build_orientation_long(res_dfs_prev_full)
orient_noprev_long <- build_orientation_long(res_dfs_noprev_full)

#  Long presence frames for joining
presence_prev_long <- df_presence_prev %>%
  dplyr::select(bacteria, all_of(names(res_dfs_prev_presence))) %>%
  pivot_longer(-bacteria, names_to = "metodo", values_to = "presence")

presence_noprev_long <- df_presence_noprev %>%
  dplyr::select(bacteria, all_of(names(res_dfs_noprev_presence))) %>%
  pivot_longer(-bacteria, names_to = "metodo", values_to = "presence")

#  Aggregate per-bacteria orientation + diagnostics
summarise_orient <- function(pres_long, orient_long) {
  pres_long %>%
    left_join(orient_long, by = c("bacteria","metodo")) %>%
    filter(presence == 1) %>%
    summarise(
      n_present = sum(presence == 1, na.rm = TRUE),
      n_pos     = sum(orientation ==  1, na.rm = TRUE),
      n_neg     = sum(orientation == -1, na.rm = TRUE),
      any_pos   = n_pos > 0,
      any_neg   = n_neg > 0,
      orientation_final = case_when(
        any_pos ~  1L,
        any_neg ~ -1L,
        TRUE    ~ NA_integer_
      ),
      discrepancy = any_pos & any_neg,
      .by = "bacteria"
    ) %>%
    dplyr::mutate(
      toxicity_final = case_when(
        orientation_final ==  1L ~ "severe",
        orientation_final == -1L ~ "low",
        TRUE ~ NA_character_
      )
    )
}

agg_prev   <- summarise_orient(presence_prev_long,   orient_prev_long)
agg_noprev <- summarise_orient(presence_noprev_long, orient_noprev_long)

#  Presence flags and FINAL annotation (this writes into df_presence_*)
has_prev2 <- presence_prev_long %>%
  summarise(has_presence = any(presence == 1, na.rm = TRUE), .by = "bacteria")

has_noprev2 <- presence_noprev_long %>%
  summarise(has_presence = any(presence == 1, na.rm = TRUE), .by = "bacteria")

df_presence_prev <- df_presence_prev %>%
  left_join(agg_prev,  by = "bacteria") %>%
  left_join(has_prev2, by = "bacteria") %>%
  dplyr::mutate(
    orientation = if_else(has_presence, orientation_final, NA_integer_),
    toxicity    = if_else(has_presence, toxicity_final,  NA_character_)
  ) %>%
  dplyr::select(-orientation_final, -toxicity_final)

df_presence_noprev <- df_presence_noprev %>%
  left_join(agg_noprev,  by = "bacteria") %>%
  left_join(has_noprev2, by = "bacteria") %>%
  dplyr::mutate(
    orientation = if_else(has_presence, orientation_final, NA_integer_),
    toxicity    = if_else(has_presence, toxicity_final,  NA_character_)
  ) %>%
  dplyr::select(-orientation_final, -toxicity_final)

# ========
#   Test
# ========

message("noprev: ", nrow(df_presence_noprev), " taxa; ",
        length(noprev_names), " methods; NA check passed.")
message("prev:   ", nrow(df_presence_prev), " taxa; ",
        length(prev_names), " methods; NA check passed.")

# # Are presence matrices strictly 0/1 (or logical) with no NAs?
# stopifnot(!anyNA(df_presence_prev),  !anyNA(df_presence_noprev))
#
# # Do all method columns exist and are named from the presence list?
# stopifnot(all(names(res_dfs_prev_presence)   %in% names(df_presence_prev)))
# stopifnot(all(names(res_dfs_noprev_presence) %in% names(df_presence_noprev)))
#
# # No duplicated bacteria
# stopifnot(anyDuplicated(df_presence_prev$bacteria)   == 0)
# stopifnot(anyDuplicated(df_presence_noprev$bacteria) == 0)



```


<!-- Results by Toxicity Classification -->
The figures presented in this paper focus exclusively on the prevalence-based approach, as this method provides the most accurate and interpretable representation of the results.

## Paper Figure 1: Cladogram
Figure 1 (main manuscript) displays a cladogram illustrating the top four unique bacterial taxa identified within each toxicity class. The visualization highlights differences in taxonomic composition across classes based on prevalence patterns. Only taxa identified through the prevalence-based analysis are included.


```{r cladogram_top4,  message=FALSE, warning=FALSE, fig.height=10}

num_cols <- names(df_presence_prev)[sapply(df_presence_prev, is.numeric)]
res_cols  <- intersect(num_cols, grep("^res", names(df_presence_prev), value = TRUE)) # only res dfs
res_cols_no0 <- res_cols[colSums(df_presence_prev[res_cols], na.rm = TRUE) != 0] # remove res dfs without any bacterial presence
res_cols_no0 <- setdiff(res_cols_no0, "orientation") 

# res_cols_no0
#  [1] "res_aldex2_prev_ASV_noBH_df"    "res_aldex2_prev_noBH_df"        "res_ancom_prev_ASV_BH_df"       "res_ancom_prev_ASV_noBH_df"     "res_ancom_prev_BH_df"          
#  [6] "res_ancom_prev_noBH_df"         "res_deseq2_prev_ASV_BH_df"      "res_deseq2_prev_ASV_noBH_df"    "res_deseq2_prev_BH_df"          "res_deseq2_prev_noBH_df"       
# [11] "res_lefse_cpm_prev_ASV_noBH_df" "res_lefse_cpm_prev_noBH_df"     "res_lefse_ra_ASV_prev_noBH_df"  "res_lefse_ra_prev_noBH_df"      "res_linda_prev_ASV_BH_df"      
# [16] "res_linda_prev_ASV_noBH_df"     "res_linda_prev_BH_df"           "res_linda_prev_noBH_df"         "res_zicoseq_prev_ASV_NoBH"      "res_zicoseq_prev_BH"           
# [21] "res_zicoseq_prev_NoBH"     


# common score
rank_df <- df_presence_prev %>%
  dplyr::mutate(preval_score = rowMeans(across(all_of(res_cols_no0)), na.rm = TRUE)) %>%
  dplyr::select(bacteria, toxicity, preval_score)

# top-4 by toxicity
top_low <- rank_df %>% filter(toxicity == "low")    %>% slice_max(preval_score, n = 4, with_ties = FALSE)
top_sev <- rank_df %>% filter(toxicity == "severe") %>% slice_max(preval_score, n = 4, with_ties = FALSE)
top_all <- bind_rows(top_low, top_sev) %>%
  dplyr::mutate(bacteria = factor(bacteria, levels = top_n <- unique(bacteria)))


dat <- top_all %>%
  as_tibble() %>%
  dplyr::rename(genus = bacteria, group = toxicity, score = preval_score) %>%
  dplyr::mutate(
    tip   = gsub("[^A-Za-z0-9]+", "_", genus),
    group = factor(group, levels = c("low","severe")),  # ensure consistent mapping
    genus = as.character(genus)                          # ensure character, not factor
  )

# -------- build simple 2-clade tree --------
tips_low    <- dat %>% filter(group == "low")    %>% pull(tip) %>% paste(collapse = ",")
tips_severe <- dat %>% filter(group == "severe") %>% pull(tip) %>% paste(collapse = ",")
tr <- ape::read.tree(text = paste0("((", tips_low, ")low,(", tips_severe, ")severe);"))

# Make tree tip labels = genus names (critical to show names, not numbers)
tr$tip.label <- setNames(dat$genus, dat$tip)[tr$tip.label]

# MRCA nodes using ape
node_low    <- ape::getMRCA(tr, dat %>% filter(group == "low")    %>% pull(genus))
node_severe <- ape::getMRCA(tr, dat %>% filter(group == "severe") %>% pull(genus))

# Metadata to attach (label must match tr$tip.label exactly)
meta <- dat %>% transmute(label = genus, group, score)

# Colors (green = low, purple = severe)
pal <- c(low = "#2ca25f", severe = "#6a51a3")

# -------- plot --------
p <- ggtree(tr, layout = "circular", branch.length = "none", size = 0.6) %<+%  meta +
  # highlight clades
  geom_hilight(node = node_low,    fill = pal["low"],    alpha = 0.15) +
  geom_hilight(node = node_severe, fill = pal["severe"], alpha = 0.18) +
  # tip points (only tips; use ggtree's data, not an external data=)
  geom_tippoint(aes(color = group, size = score, subset = isTip), stroke = 0, na.rm = TRUE) +
  # tip labels: show genus names from 'label' column
  geom_tiplab2(aes(label = label), size = 3, offset = 0.55, linesize = 0.25) +
  # external clade labels (optional)
  geom_cladelabel(node = node_low,    label = "low",    align = TRUE,
                  offset = 1.1, barsize = 0, fontsize = 4, color = pal["low"]) +
  geom_cladelabel(node = node_severe, label = "severe", align = TRUE,
                  offset = 1.1, barsize = 0, fontsize = 4, color = pal["severe"]) +
  scale_color_manual(values = pal, name = "Toxicity") +
  scale_size(range = c(2.2, 5), name = "Prevalence score") +
  theme_void() +
  theme(legend.position = "right")

# give labels breathing room (avoids clipping)
p <- p + xlim(NA, max(p$data$x, na.rm = TRUE) + 1.2)
p


# save
ggsave("cladogram_low_vs_severe.png", p, width = 8, height = 8, dpi = 300, bg = "white")
ggsave("cladogram_low_vs_severe.svg", p, width = 8, height = 8, dpi = 300, bg = "white")

```
This figure was revised and modified in the final version of the manuscript to improve clarity.

## Supplementary Figure 1: Top Four Bacterial Biomarkers by Toxicity Class

Supplementary Figure 1 presents a Venn diagram illustrating the top four unique bacterial taxa associated with each toxicity class. The comparison is based solely on the prevalence-based analysis.

```{r supp_mat_fig1,  message=FALSE, warning=FALSE, fig.height=10}
set.seed(945)

num_cols <- names(df_presence_prev)[sapply(df_presence_prev, is.numeric)]
res_cols  <- intersect(num_cols, grep("^res", names(df_presence_prev), value = TRUE)) # only res dfs
res_cols_no0 <- res_cols[colSums(df_presence_prev[res_cols], na.rm = TRUE) != 0] # remove res dfs without any bacterial presence
res_cols_no0 <- setdiff(res_cols_no0, "orientation")

# common score
rank_df <- df_presence_prev %>%
  dplyr::mutate(preval_score = rowMeans(across(all_of(res_cols_no0)), na.rm = TRUE)) %>%
  dplyr::select(bacteria, toxicity, preval_score)

# top-4 by toxicity
top_low <- rank_df %>% filter(toxicity == "low")    %>% slice_max(preval_score, n = 4, with_ties = FALSE)
top_sev <- rank_df %>% filter(toxicity == "severe") %>% slice_max(preval_score, n = 4, with_ties = FALSE)
top_all <- bind_rows(top_low, top_sev) %>%
  dplyr::mutate(bacteria = factor(bacteria, levels = top_n <- unique(bacteria)))


# ==== Venn Diagram ====

low_set <- unique(top_low$bacteria)
sev_set <- unique(top_sev$bacteria)

venn_list <- list(`Low` = low_set, `Severe` = sev_set)

top4_ggven <- ggvenn(
  list(`Low` = low_set, `Severe` = sev_set),
  show_elements = TRUE,              # <- label names
  label_sep       = "\n ",
  fill_color = c("#22A88455", "#44015455"),
  stroke_size = 0.8,
  set_name_size = 5,
  text_size = 3
)

top4_ggven


# ggsave(
#   filename = "top4_ggven.png",  
#   plot = top4_ggven,            
#   width = 8, height = 6,        
#   dpi = 600                     
# )

```

## Supplementary Figure 2: Toxicity Heatmap

Supplementary Figure 2 shows a heatmap generated using only the prevalence-derived outputs. The figure highlights distinct abundance and distribution patterns of bacterial taxa across the toxicity classes.


```{r supp_mat_fig2_heatmap_prev_bacteria,  message=FALSE, warning=FALSE, fig.height=10}

df_presence_prev$toxicity <- case_when(
  df_presence_prev$orientation == -1L ~ "low",
  df_presence_prev$orientation ==  1L ~ "severe",
  TRUE ~ NA_character_
)

# Excluding 'orientation'
num_cols <- names(df_presence_prev)[sapply(df_presence_prev, is.numeric)]
num_cols <- setdiff(num_cols, "orientation")  # <- clave para que no aparezca
df_heat <- as.matrix(df_presence_prev[, num_cols, drop = FALSE])
rownames(df_heat) <- df_presence_prev$bacteria

# Annotation outside matrix
annotation_row <- data.frame(
  toxicity = factor(df_presence_prev$toxicity, levels = c("low","severe")),
  row.names = df_presence_prev$bacteria
)

annotation_colors <- list(
  toxicity = c("low" = "#22A884FF", "severe" = "#440154FF")
)

# Ordering by toxicity
ord <- order(annotation_row$toxicity, rownames(annotation_row), na.last = TRUE)
df_heat        <- df_heat[ord, , drop = FALSE]
annotation_row <- annotation_row[ord, , drop = FALSE]

# Gaps calculation
tx_int <- as.integer(annotation_row$toxicity)
gap_position <- which(diff(replace(tx_int, is.na(tx_int), max(tx_int, na.rm = TRUE) + 1L)) != 0)

# Cleaning names
colnames(df_heat) <- gsub("^res_", "", colnames(df_heat))
colnames(df_heat) <- gsub("_df$", "", colnames(df_heat))

# Plotting
final_tox_heatmap <- pheatmap(
  df_heat,
  cluster_rows = FALSE,
  cluster_cols = if (ncol(df_heat) >= 2) TRUE else FALSE,
  annotation_row = annotation_row,
  annotation_colors = annotation_colors,
  show_rownames = TRUE,
  fontsize_row = 5.5,
  color = colorRampPalette(c("#FDB863", "white", "#3B4CC0"))(100),
  breaks = seq(0, 1, length.out = 100),
  gaps_row = gap_position,
  main = "Potential Biomarker Bacteria ordered by toxicity classes"
)

final_tox_heatmap

ggsave(
  filename = "final_tox_heatmap.png",
  plot = final_tox_heatmap,
  width = 16, height = 12,
  dpi = 600
)


```

## Supplementary Figure 3: Oral Genera Distribution (Alluvial Plot)

Supplementary Figure 3 provides an alluvial plot illustrating the distribution of oral bacterial genera across toxicity categories. This visualization emphasizes shifts in genus-level composition relative to toxicity status.
```{r supp_mat_fig3_oral_bacteria_discusion_alluvial}
# Filtering res_dfs list
res_dfs_df <- res_dfs[sapply(res_dfs, is.data.frame)]

res_dfs_clean <- res_dfs_df[sapply(res_dfs_df, function(df) {
  is.data.frame(df) &&
    nrow(df) > 0 &&                                    #  removing empty dfs (such as res_zicoseq_noprev_ASV_BH and res_zicoseq_prev_ASV_BH)
    "bacteria" %in% names(df) &&                       # 
    inherits(df$bacteria, "character")                 # 
})]

# Detecting bad elements
bad_elements <- names(res_dfs)[!names(res_dfs) %in% names(res_dfs_clean)]
if (length(bad_elements) > 0) {
  message("No valid elements detected: ", paste(bad_elements, collapse = ", "))
}

# Finding oral bacteria (function from DAA_functions)
oral_hits <- purrr::imap_dfr(res_dfs_clean, oral_bacteria_finding)



# Preparing data
oral_alluvial_2d <- oral_hits %>%
  dplyr::mutate(
    Genus = stringr::str_remove(bacteria, ".*g__"),
    enrich_group = as.character(enrich_group),
    comparison = as.character(comparison)
  ) %>%
  dplyr::count(Genus, enrich_group, comparison)

oral_alluvial_2d <- oral_alluvial_2d %>%
  dplyr::mutate(method_clean = comparison %>%
           str_replace_all("^(res_?)|(_?df)$", "") %>%
           str_replace_all("__+", "_") %>%
           str_replace_all("^_+|_+$", ""))

# Alluvial plot facet wrap by enrich_group
ggplot(oral_alluvial_2d,
       aes(axis1 = Genus, axis2 = method_clean, y = n)) +
  
  geom_alluvium(aes(fill = Genus), width = 1/12, alpha = 0.9) +
  geom_stratum(width = 1/12, color = "black", fill = "grey90") +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 3) +
  
  scale_x_discrete(
    limits = c("Genus", "Method_approach"),
    expand = c(.1, .1)
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  guides(fill = guide_legend(title = "Oral Bacteria Genera")) +
  
  labs(
    title = "Oral Genres Distribution: Comparison vs. Toxicity Group",
    x = NULL,
    y = "Frecuency"
  ) +
  
  facet_wrap(~ enrich_group, scales = "free_x") +
  
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1)
  )



```

## Supplementary Figure 4: Oral Bacteria Heatmap (Presence/Absence in NoPrevalence/Prevalence approaches)

Supplementary Figure 4 displays a presence/absence heatmap comparing oral bacterial taxa across the NoPrevalence and Prevalence groups. The figure highlights differences in bacterial occurrence patterns associated with the prevalence classification.


```{r supp_mat_fig4_heatmap_oral_hits, fig.height=10}

# Oral Bacteria Vector
oral_genus <- c("Actinomyces", "Aggregatibacter", "Alloprevotella",
                "Campylobacter", "Capnocytophaga", "Catonella",
                "Desulfobulbus", "Dialister", "Filifactor",
                "Fusobacterium", "Mogibacterium", "Parvimonas",
                "Peptococcus", "Peptostreptococcus",
                "Porphyromonas", "Prevotella", "Prevotella_7",
                "Pseudoramibacter", "Tannerella", "Treponema", "Veillonella")


# Extracting Genus names
oral_hits_clean <- oral_hits %>%
  dplyr::mutate(Genus = stringr::str_remove(bacteria, ".*g__")) %>%
  dplyr::distinct(Genus, comparison) %>%
  dplyr::mutate(present = 1)

# Presence/Absence Matrix
oral_matrix <- oral_hits_clean %>%
  tidyr::pivot_wider(names_from = comparison, values_from = present, values_fill = 0)

# Genus assignation to Matrix rows
mat <- as.matrix(oral_matrix[,-1])  # quitar columna Genus
rownames(mat) <- oral_matrix$Genus

clean_colnames <- function(x) {
  x <- gsub("^(res_?)|(_?df)$", "", x)
  x <- gsub("\\bres\\b|\\bdf\\b", "", x)  # optional: removes inner whole-word tokens
  x <- gsub("__+", "_", x)
  x <- gsub("^_+|_+$", "", x)
  x
}

colnames(mat) <- clean_colnames(colnames(mat))

# Heatmap plot
pheatmap(mat,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         color        = viridis(256, option = "cividis"), 
         main = "Oral Bacteria detected by DAA tools (including ASVs and Genus)",
         fontsize_row = 8,
         fontsize_col = 8,
         border_color = "white")#,
         # cellheight = 7)





```



# *Covariates (cofounders evaluation) + Plots*

## ALDEx2 (ASV) 
In here we increased the threshold until 0.25, but no feature was retained. Same happened with the Genus approach.

```{r aldex_prev_ASV_cov,  message=FALSE, warning=FALSE}

set.seed(1934)

counts <- as(otu_table(physeq_filtered), "matrix")
if (!taxa_are_rows(physeq_filtered)) counts <- t(counts)        # filas = features, cols = samples
counts <- counts[rowSums(counts) > 0, , drop = FALSE]

meta <- data.frame(sample_data(physeq_filtered))
stopifnot(!is.null(rownames(meta)))

samps <- intersect(colnames(counts), rownames(meta))
counts <- counts[, samps, drop = FALSE]
meta   <- meta[samps, , drop = FALSE]

vars <- c("TOX_SEVERA","Patients_age","sex","has_metastasis")
meta$TOX_SEVERA     <- factor(meta$TOX_SEVERA, levels = c(0,1))   
meta$sex            <- factor(meta$sex)
meta$has_metastasis <- factor(meta$has_metastasis, levels = c(0,1))
meta$Patients_age   <- as.numeric(meta$Patients_age)

keep <- stats::complete.cases(meta[, vars])
counts <- counts[, keep, drop = FALSE]
meta   <- meta[keep, , drop = FALSE]

stopifnot(!any(duplicated(colnames(counts))))
stopifnot(!any(duplicated(rownames(meta))))

mm <- model.matrix(~ TOX_SEVERA + Patients_age + sex + has_metastasis, data = meta)

stopifnot(ncol(counts) == nrow(mm))
stopifnot(identical(colnames(counts), rownames(mm)))

## 5) ALDEx2 (GLM) + BH = 0.10
set.seed(1)
x <- aldex.clr(counts, conds = mm, mc.samples = 128, denom = "all")
glm_out <- aldex.glm(x, fdr.method = "BH")

#print(aldex_result)

# As ALDEx2 return the raw pvalues and BH adjusted pvalues, we are checking:
table(
  uncorrected = glm_out$we.ep < 0.25,
  corrected = glm_out$we.eBH < 0.25
)



```



## ANCOM-BC

### Unfiltered prevalence

#### No BH Correction

```{r ancombc_unfilt_NoBH_cov, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}


set.seed(123)

# proc_family_ancombc <- NULL
proc_genus_ancombc <- NULL
proc_asv_ancombc <- NULL

# proc_family_ancombc <- run_ancombc_1vs1(tox_ps_final, "Family", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3
proc_genus_ancombc <- run_ancombc_nPnB(tox_ps_final, "Genus", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0)
proc_asv_ancombc <- run_ancombc_nPnB(tox_ps_final, "ASV", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3

# function
# Return e.g. "f__Desulfovibrionaceae_NA" or "o__Rhodospirillales_NA"
# last_informative_rank <- function(x,
#                                   uninf = c("uncultured","unidentified","unclassified",
#                                             "unassigned","unknown","norank","na")) {
#   pick_one <- function(s) {
#     if (is.na(s) || s == "") return(s)                       # keep as is
#     if (!startsWith(s, "d__Bacteria")) return(s)             # only act on the long form
#     m <- str_match_all(s, "_?([dpcfosg])__(.*?)(?=(?:_[dpcfosg]__|$))")[[1]]
#     if (nrow(m) <= 1) return(s)                              # only one rank -> leave as is
# 
#     ranks <- m[, 2]
#     names <- m[, 3]
# 
#     # Walk from deepest to shallowest; skip uninformative names
#     for (i in seq.int(length(names), 1)) {
#       nm  <- names[i]
#       nm2 <- tolower(nm)
#       bad <- nm2 == "" ||
#              nm2 %in% uninf ||
#              startsWith(nm2, "uncultured_")                  # e.g. "uncultured_bacterium"
#       if (!bad) return(paste0(ranks[i], "__", nm, "_NA"))
#     }
#     NA_character_                                           # all were uninformative
#   }
# 
#   vapply(x, pick_one, FUN.VALUE = character(1))
# }
# formating names
proc_genus_ancombc <- proc_genus_ancombc %>%
  dplyr::mutate(bacteria = last_informative_rank(taxon_id))

proc_asv_ancombc <- proc_asv_ancombc %>%
  dplyr::mutate(bacteria = last_informative_rank(taxon_id))

df_fig_nopre_noBH_cov <- rbind(proc_genus_ancombc, proc_asv_ancombc)

```

<!-- # ---- Uncomment if you want to check Genus and ASV individual plots -->

<!-- #### Genus -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # genus -->

<!-- df_proc_genus_ancombc <- as.data.frame(proc_genus_ancombc) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   dplyr::mutate(target_level = factor("Genus", levels = "Genus")) -->


<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_genus_ancombc, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_genus_ancombc$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p -->


<!-- ``` -->

<!-- #### ASV -->

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # asv -->

<!-- df_proc_asv_ancombc <- as.data.frame(proc_asv_ancombc) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("ASV", levels = "ASV")) -->

<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_asv_ancombc, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_asv_ancombc$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p  -->
<!-- ``` -->

```{r}

res_ancom_noprev_noBH_cov_df <- df_fig_nopre_noBH_cov %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "no",
    BH           = "no",
    herramienta  = "ANCOMBC"
)

# res_ancom_noprev_noBH_cov_df
```


```{r heatmap_ancombc_noprev_confounders, echo=FALSE, fig.height=10}


taxa_var_matrix <- as.data.frame(proc_genus_ancombc)  %>%
  dplyr::filter(diff_abn==TRUE,                 # en vez de diff_abn == TRUE
    # qval < 0.05,
    # qval.text %in% c("***", "**")
    qval.txt == "***"
  ) %>%
  dplyr::select(bacteria, var) %>%  # <-- Asegúrate de incluir la columna del nombre del género
  dplyr::distinct() %>%
  dplyr::mutate(present = 1) %>%
  tidyr::pivot_wider(names_from = var, values_from = present, values_fill = 0)


# taxa_var_matrix

# genera affect for more than one variable
taxa_var_matrix %>%
  dplyr::mutate(n_vars = rowSums(across(where(is.numeric)))) %>%
  dplyr::filter(n_vars > 1) %>%
  dplyr::arrange(desc(n_vars))


mat <- as.matrix(taxa_var_matrix[,-1])
rownames(mat) <- taxa_var_matrix$bacteria

pheatmap::pheatmap(mat, cluster_rows = TRUE, 
         cluster_cols = TRUE, 
         main = "Taxa affected by variables",
        fontsize_row = 6,
        fontsize_col = 8,
        border_color = "white",
        cellheight = 7
)

```

#### With BH Correction

```{r ancombc_unfilt_BH_cov, message=FALSE, warning=FALSE}


set.seed(123)

# proc_family_ancombc <- NULL
proc_genus_ancombc_unfBH <- NULL
proc_asv_ancombc_unfBH <- NULL

# proc_family_ancombc <- run_ancombc_1vs1(tox_ps_final, "Family", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3
proc_genus_ancombc_unfBH <- run_ancombc_nPB(tox_ps_final, "Genus", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0)
proc_asv_ancombc_unfBH <- run_ancombc_nPB(tox_ps_final, "ASV", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3


```

```{r}

# proc_genus_ancombc_unfBH
# proc_asv_ancombc_unfBH 


df_fig_nopre_BH_cov <- rbind(proc_genus_ancombc_unfBH, proc_asv_ancombc_unfBH)
df_fig_nopre_BH_cov$target_level <- factor(df_fig_nopre_BH_cov$target_level, levels = c("Genus","ASV"))
as.data.frame(df_fig_nopre_noBH_cov)
ancombc_bh_pvals_nopr_BH_cov <-  as.data.frame(df_fig_nopre_BH_cov)$pval[as.data.frame(df_fig_nopre_BH_cov)$qval < 0.05]
# ancombc_bh_pvals_nopr_BH_cov


ancomb_nopr_BH_cov_features <- as.data.frame(df_fig_nopre_BH_cov)$taxon_id
ancomb_nopr_BH_cov_features_tox <- as.data.frame(df_fig_nopre_BH_cov)[, c("taxon_id", "orientation", "qval")]

# Remove untrusted organisms
df_fig_nopre_BH_cov <- df_fig_nopre_BH_cov[!grepl("Incertae|uncultured", df_fig_nopre_BH_cov$taxon_id),]

# Plot
# p <- NULL
# p <- ggplot(data = subset(df_fig_nopre_BH_cov, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
#   scale_alpha_manual(values=get_scale_alpha_values(df_fig_nopre_BH_cov$qval.txt)) +
#   geom_bar(stat = "identity",
#            position = position_dodge2(width = 0.9, preserve = "single")) +
#   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
#                 position = position_dodge2(width = 0.9, preserve = "single"),
#                 color = "gray36") +
#   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
#             position = position_dodge2(width = 0.9, preserve = "single")) +
#   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
#   geom_hline(yintercept = 0, alpha=0.5) +
#   facet_wrap(~target_level, scale="free_y", ncol=1) +
#   labs(x = NULL, y = "Log fold change", title = "") +
#   scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
#   # scale_fill_discrete(name = NULL) +
#   # scale_color_discrete(name = NULL) +
#   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) +
#   coord_flip() +
#   theme_bw() +
#   theme(
#     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
#     axis.text.y=element_text(size=10),
#     axis.title.y=element_text(size=10, face = "italic"),
#     legend.text=element_text(size=8)
#     # panel.grid.major = element_blank(),
#     # panel.grid.minor = element_blank(),
#     # panel.border = element_blank(),
#     # panel.background = element_blank(),
#     # axis.ticks.x=element_blank()
#     # axis.line = element_line(colour = "black")
#   )
# p
# ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)

res_ancom_noprev_BH_cov_df <- df_fig_nopre_BH_cov %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "no",
    BH           = "yes",
    herramienta  = "ANCOMBC"
)

# res_ancom_noprev_BH_cov_df

```
<!-- # ---- Uncomment if you want to check Genus and ASV individual plots -->

<!-- #### Genus -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # genus -->
<!-- df_proc_genus_ancombc_unfBH <- as.data.frame(proc_genus_ancombc_unfBH) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("Genus", levels = "Genus")) -->

<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_genus_ancombc_unfBH, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_genus_ancombc_unfBH$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p -->


<!-- ``` -->

<!-- #### ASV -->

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # asv -->
<!-- df_proc_asv_ancombc_unfBH <- as.data.frame(proc_asv_ancombc_unfBH) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("ASV", levels = "ASV")) -->

<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_asv_ancombc_unfBH, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_asv_ancombc_unfBH$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p  -->
<!-- ``` -->


```{r heatmap_ancombc_noprev_BH_confounders, fig.height=10}

taxa_var_matrix <- as.data.frame(proc_genus_ancombc_unfBH)  %>%
  dplyr::filter(diff_abn==TRUE,                 # en vez de diff_abn == TRUE
    # qval < 0.05,
    # qval.text %in% c("***", "**")
    qval.txt == "***"
  ) %>%
  dplyr::mutate(bacteria = taxon_id) %>%
  dplyr::select(bacteria, var) %>%  # <-- Asegúrate de incluir la columna del nombre del género
  dplyr::distinct() %>%
  dplyr::mutate(present = 1) %>%
  tidyr::pivot_wider(names_from = var, values_from = present, values_fill = 0)


# taxa_var_matrix

# genera affect for more than one variable
taxa_var_matrix %>%
  dplyr::mutate(n_vars = rowSums(across(where(is.numeric)))) %>%
  dplyr::filter(n_vars > 1) %>%
  dplyr::arrange(desc(n_vars))


mat <- as.matrix(taxa_var_matrix[,-1])
rownames(mat) <- taxa_var_matrix$bacteria

pheatmap::pheatmap(mat, cluster_rows = TRUE, 
         cluster_cols = TRUE, 
         main = "Taxa affected by variables",
        fontsize_row = 6,
        fontsize_col = 8,
        border_color = "white",
        cellheight = 7
)

```

### Prevalence filtering

#### No BH Correction

```{r ancombc_filt_noBH_cov, message=FALSE, warning=FALSE}

set.seed(123)

# proc_family_ancombc <- NULL
proc_genus_ancombc_filt <- NULL
proc_asv_ancombc_filt <- NULL

# proc_family_ancombc <- run_ancombc_1vs1(physeq_filtered, "Family", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3
proc_genus_ancombc_filt <- run_ancombc_nPnB(physeq_filtered, "Genus", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0)
proc_asv_ancombc_filt <- run_ancombc_nPnB(physeq_filtered, "ASV", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3

# formating names
proc_genus_ancombc_filt <- proc_genus_ancombc_filt %>%
  dplyr::mutate(bacteria = last_informative_rank(taxon_id))

proc_asv_ancombc_filt <- proc_asv_ancombc_filt %>%
  dplyr::mutate(bacteria = last_informative_rank(taxon_id))




df_fig_pre_noBH_cov <- rbind(proc_genus_ancombc_filt, proc_asv_ancombc_filt)
df_fig_pre_noBH_cov$target_level <- factor(df_fig_pre_noBH_cov$target_level, levels = c("Genus","Species"))
as.data.frame(df_fig_pre_noBH_cov)
ancombc_bh_pvals_pr_noBH_cov <-  as.data.frame(df_fig_pre_noBH_cov)$pval[as.data.frame(df_fig_pre_noBH_cov)$qval < 0.05]
# ancombc_bh_pvals_pr_noBH_cov


ancomb_pr_noBH_cov_features <- as.data.frame(df_fig_pre_noBH_cov)$taxon_id
ancomb_pr_noBH_cov_features_tox <- as.data.frame(df_fig_pre_noBH_cov)[, c("taxon_id", "orientation", "qval")]

# Remove untrusted organisms
df_fig_pre_noBH_cov <- df_fig_pre_noBH_cov[!grepl("Incertae|uncultured", df_fig_pre_noBH_cov$taxon_id),]

# # Plot
# p <- NULL
# p <- ggplot(data = subset(df_fig_pre_noBH_cov, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
#   scale_alpha_manual(values=get_scale_alpha_values(df_fig_pre_noBH_cov$qval.txt)) +
#   geom_bar(stat = "identity",
#            position = position_dodge2(width = 0.9, preserve = "single")) +
#   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
#                 position = position_dodge2(width = 0.9, preserve = "single"),
#                 color = "gray36") +
#   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
#             position = position_dodge2(width = 0.9, preserve = "single")) +
#   # geom_vline(xintercept = (1:length(df_fig_nopre_BH_cov$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
#   geom_hline(yintercept = 0, alpha=0.5) +
#   facet_wrap(~target_level, scale="free_y", ncol=1) +
#   labs(x = NULL, y = "Log fold change", title = "") +
#   scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
#   # scale_fill_discrete(name = NULL) +
#   # scale_color_discrete(name = NULL) +
#   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) +
#   coord_flip() +
#   theme_bw() +
#   theme(
#     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
#     axis.text.y=element_text(size=10),
#     axis.title.y=element_text(size=10, face = "italic"),
#     legend.text=element_text(size=8)
#     # panel.grid.major = element_blank(),
#     # panel.grid.minor = element_blank(),
#     # panel.border = element_blank(),
#     # panel.background = element_blank(),
#     # axis.ticks.x=element_blank()
#     # axis.line = element_line(colour = "black")
#   )
# p
# ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)

res_ancom_prev_noBH_cov_df <- df_fig_pre_noBH_cov %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "yes",
    BH           = "no",
    herramienta  = "ANCOMBC"
)

# res_ancom_prev_noBH_cov_df

```
<!-- # ---- Uncomment if you want to check Genus and ASV individual plots -->

<!-- #### Genus -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # genus -->
<!-- df_proc_genus_ancombc_filt <-as.data.frame(proc_genus_ancombc_filt) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("Genus", levels = "Genus")) -->

<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_genus_ancombc_filt, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_genus_ancombc_filt$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p -->


<!-- ``` -->

<!-- #### ASV -->

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # asv -->

<!-- df_proc_asv_ancombc_filt <- as.data.frame(proc_asv_ancombc_filt) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("ASV", levels = "ASV")) -->


<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_asv_ancombc_filt, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_asv_ancombc_filt$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p  -->
<!-- ``` -->


```{r heatmap_ancombc_prev_noBH_confounders, fig.height=10}


taxa_var_matrix <- as.data.frame(proc_genus_ancombc_filt)  %>%
  dplyr::filter(diff_abn==TRUE,            
    qval.txt == "***"
  ) %>%
  dplyr::mutate(bacteria = taxon_id)  %>%
  dplyr::select(bacteria, var) %>%  # <-- Asegúrate de incluir la columna del nombre del género
  dplyr::distinct() %>%
  dplyr::mutate(present = 1) %>%
  tidyr::pivot_wider(names_from = var, values_from = present, values_fill = 0)


# taxa_var_matrix

# genera affect for more than one variable
taxa_var_matrix %>%
  dplyr::mutate(n_vars = rowSums(across(where(is.numeric)))) %>%
  dplyr::filter(n_vars > 1) %>%
  dplyr::arrange(desc(n_vars))


mat <- as.matrix(taxa_var_matrix[,-1])
rownames(mat) <- taxa_var_matrix$bacteria

pheatmap::pheatmap(mat, cluster_rows = TRUE, 
         cluster_cols = TRUE, 
         main = "Taxa affected by variables",
        fontsize_row = 6,
        fontsize_col = 8,
        border_color = "white",
        cellheight = 7
)
```

#### With BH Correction

```{r ancombc_filt_BH_cov, message=FALSE, warning=FALSE}

set.seed(123)

# proc_family_ancombc <- NULL
proc_genus_ancombc_filt_BH <- NULL
proc_asv_ancombc_filt_BH <- NULL

# proc_family_ancombc <- run_ancombc_1vs1(physeq_filtered, "Family", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3
proc_genus_ancombc_filt_BH <- run_ancombc_PB(physeq_filtered, "Genus", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0)
proc_asv_ancombc_filt_BH <- run_ancombc_PB(physeq_filtered, "ASV", c("TOX_SEVERA","sex","simplified_location","age_group"), prv_cut=0) #0.3

# formating names
proc_genus_ancombc_filt_BH <- proc_genus_ancombc_filt_BH %>%
  dplyr::mutate(bacteria = last_informative_rank(taxon_id))

proc_asv_ancombc_filt_BH <- proc_asv_ancombc_filt_BH %>%
  dplyr::mutate(bacteria = last_informative_rank(taxon_id))



```

```{r echo=FALSE, fig.height=10}

df_fig_pre_BH_cov <- rbind(proc_genus_ancombc_filt_BH, proc_asv_ancombc_filt_BH)
df_fig_pre_BH_cov$target_level <- factor(df_fig_pre_BH_cov$target_level, levels = c("Genus","ASV"))
as.data.frame(df_fig_pre_BH_cov)
ancombc_bh_pvals_pr_BH_cov <-  as.data.frame(df_fig_pre_BH_cov)$pval[as.data.frame(df_fig_pre_BH_cov)$qval < 0.05]
# ancombc_bh_pvals_pr_BH_cov


ancomb_pr_BH_cov_features <- as.data.frame(df_fig_pre_BH_cov)$taxon_id
ancomb_pr_BH_cov_features_tox <- as.data.frame(df_fig_pre_BH_cov)[, c("taxon_id", "orientation", "qval")]

# Remove untrusted organisms
df_fig_pre_BH_cov <- df_fig_pre_BH_cov[!grepl("Incertae|uncultured", df_fig_pre_BH_cov$taxon_id),]

# # Plot
# p <- NULL
# p <- ggplot(data = subset(df_fig_pre_BH_cov, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) +
#   scale_alpha_manual(values=get_scale_alpha_values(df_fig_pre_BH_cov$qval.txt)) +
#   geom_bar(stat = "identity",
#            position = position_dodge2(width = 0.9, preserve = "single")) +
#   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5,
#                 position = position_dodge2(width = 0.9, preserve = "single"),
#                 color = "gray36") +
#   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36",
#             position = position_dodge2(width = 0.9, preserve = "single")) +
#   # geom_vline(xintercept = (1:length(df_fig_nopre_BH_cov$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") +
#   geom_hline(yintercept = 0, alpha=0.5) +
#   facet_wrap(~target_level, scale="free_y", ncol=1) +
#   labs(x = NULL, y = "Log fold change", title = "") +
#   scale_fill_manual(values = c("#440154FF", "#22A884FF")) +
#   # scale_fill_discrete(name = NULL) +
#   # scale_color_discrete(name = NULL) +
#   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) +
#   coord_flip() +
#   theme_bw() +
#   theme(
#     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10),
#     axis.text.y=element_text(size=10),
#     axis.title.y=element_text(size=10, face = "italic"),
#     legend.text=element_text(size=8)
#     # panel.grid.major = element_blank(),
#     # panel.grid.minor = element_blank(),
#     # panel.border = element_blank(),
#     # panel.background = element_blank(),
#     # axis.ticks.x=element_blank()
#     # axis.line = element_line(colour = "black")
#   )
# p
# # ggsave(glue("{output_folder}/ancombc.png"),
#        dpi="retina", unit="px", height=4000, width=4000)

res_ancom_prev_BH_cov_df <- df_fig_pre_BH_cov %>%
  dplyr::select(bacteria = taxon_id, lfc, pval, qval, direction, orientation, target_level) %>%
  dplyr::mutate(
    logFC  = lfc,
    pvalue = pval,
    padj   = qval
  ) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    prev         = "yes",
    BH           = "yes",
    herramienta  = "ANCOMBC"
)

# res_ancom_prev_BH_cov_df
```

<!-- # ---- Uncomment if you want to check Genus and ASV individual plots -->


<!-- #### Genus -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # genus -->
<!-- df_proc_genus_ancombc_filt_BH <- as.data.frame(proc_genus_ancombc_filt_BH) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("Genus", levels = "Genus")) -->


<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_genus_ancombc_filt_BH, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_genus_ancombc_filt_BH$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p -->


<!-- ``` -->

<!-- #### ASV -->

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10} -->
<!-- # asv proc_asv_ancombc_filt_BH -->

<!-- df_proc_asv_ancombc_filt_BH <- as.data.frame(proc_asv_ancombc_filt_BH) %>% -->
<!--   filter(qval < 0.05) %>% -->
<!--   mutate(target_level = factor("ASV", levels = "ASV")) -->


<!-- p <- NULL -->
<!-- p <- ggplot(data = subset(df_proc_asv_ancombc_filt_BH, qval.txt %in% c("**", "***")), aes(x = taxon_id, y = lfc, fill=direction, alpha=qval.txt)) + -->
<!--   scale_alpha_manual(values=get_scale_alpha_values(df_proc_asv_ancombc_filt_BH$qval.txt)) + -->
<!--   geom_bar(stat = "identity", -->
<!--            position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), width=0.5, -->
<!--                 position = position_dodge2(width = 0.9, preserve = "single"), -->
<!--                 color = "gray36") + -->
<!--   geom_text(aes(label = qval.txt, y=lfc+orientation*(se+0.22)), vjust = 0.7, color = "gray36", -->
<!--             position = position_dodge2(width = 0.9, preserve = "single")) + -->
<!--   # geom_vline(xintercept = (1:length(df_fig_nopre_BH$taxon_id)-1)+0.5, alpha=0.5, linetype="dotted") + -->
<!--   geom_hline(yintercept = 0, alpha=0.5) + -->
<!--   facet_wrap(~target_level, scale="free_y", ncol=1) + -->
<!--   labs(x = NULL, y = "Log fold change", title = "") + -->
<!--   scale_fill_manual(values = c("#440154FF", "#22A884FF")) + -->
<!--   # scale_fill_discrete(name = NULL) + -->
<!--   # scale_color_discrete(name = NULL) + -->
<!--   # scale_x_discrete(limits = unique(df_fig_nopre_BH$taxon_id)) + -->
<!--   coord_flip() + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     axis.text.x=element_text(angle = 0, hjust=0.95, vjust=0.95, size=10), -->
<!--     axis.text.y=element_text(size=10), -->
<!--     axis.title.y=element_text(size=10, face = "italic"), -->
<!--     legend.text=element_text(size=8) -->
<!--     # panel.grid.major = element_blank(), -->
<!--     # panel.grid.minor = element_blank(), -->
<!--     # panel.border = element_blank(), -->
<!--     # panel.background = element_blank(), -->
<!--     # axis.ticks.x=element_blank() -->
<!--     # axis.line = element_line(colour = "black") -->
<!--   ) -->
<!-- p  -->
<!-- ``` -->


```{r heatmap_ancombc_prev_BH_confounders, fig.height=10}


taxa_var_matrix <- as.data.frame(proc_genus_ancombc_filt_BH)  %>%
  dplyr::filter(diff_abn==TRUE,            
    qval.txt == "***"
  ) %>%
  dplyr::mutate(bacteria = taxon_id) %>%
  dplyr::select(bacteria, var) %>%  # <-- Asegúrate de incluir la columna del nombre del género
  dplyr::distinct() %>%
  dplyr::mutate(present = 1) %>%
  tidyr::pivot_wider(names_from = var, values_from = present, values_fill = 0)


# taxa_var_matrix

# genera affect for more than one variable
taxa_var_matrix %>%
  dplyr::mutate(n_vars = rowSums(across(where(is.numeric)))) %>%
  dplyr::filter(n_vars > 1) %>%
  dplyr::arrange(desc(n_vars))

mat <- as.matrix(taxa_var_matrix[,-1])
rownames(mat) <- taxa_var_matrix$bacteria

pheatmap::pheatmap(mat, cluster_rows = TRUE, 
         cluster_cols = TRUE, 
         main = "Taxa affected by variables",
        fontsize_row = 6,
        fontsize_col = 8,
        border_color = "white",
        cellheight = 7
)


```

## DESeq2

### Unfiltered prevalence
#### Genus

```{r , echo=FALSE,  warning=FALSE,  message=FALSE, fig.height=10}

# c("TOX_SEVERA","sex","simplified_location","age_group")

diagdds = phyloseq_to_deseq2(tox_ps_final_genus, ~ TOX_SEVERA+sex+simplified_location+age_group)
# manual filtering of no essential features
lowtox_group <- min(table(colData(dds)$TOX_SEVERA))
keep <- rowSums(counts(dds) >= 10) >= lowtox_group
diagdds <- dds[keep,]
diagdds <- estimateSizeFactors(diagdds, type = "poscounts") # to avoid zero log error
diagdds = DESeq(diagdds, test="Wald", fitType="parametric")

res = results(diagdds, cooksCutoff = TRUE)
# raw p-values vs adjusted p-values (by BH)

res_df <- as.data.frame(res) %>%
  dplyr::mutate(
    status = case_when(
      is.na(pvalue) & is.na(padj) ~ "outlier/zero counts",
      !is.na(pvalue) & is.na(padj) ~ "filtered (low count)",
      padj <  0.05               ~ "significant",
      TRUE                       ~ "non-significant"
    )
  )

table(res_df$status)

#lfcShrink
res.ape <- lfcShrink(dds=diagdds, coef=2, type="apeglm")

# significant features
alpha = 0.05
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(tox_ps_final_genus)[rownames(sigtab), ], "matrix"))
head(sigtab)

theme_set(theme_bw())
scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
# Phylum order
# x = tapply(sigtab$log2FoldChange, sigtab$Phylum, function(x) max(x))
# x = sort(x, TRUE)
# sigtab$Phylum = factor(as.character(sigtab$Phylum), levels=names(x))
# Genus order
x = tapply(sigtab$log2FoldChange, sigtab$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtab$Genus = factor(as.character(sigtab$Genus), levels=names(x))
# ggplot(sigtab, aes(x=Genus, y=log2FoldChange, color=Genus)) + geom_point(size=6) + 
#   theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
# 
# # Volcano plot
# plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2_unfilt <- sigtab %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.01, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
df_fig_deseq2_unfilt$Genus <- factor(df_fig_deseq2_unfilt$Genus, levels = df_fig_deseq2_unfilt$Genus)
df_fig_deseq2_unfilt$direct <- factor(df_fig_deseq2_unfilt$direct, levels = c("Positive LFC", "Negative LFC"))

# Create the plot --> TODO: transform to a function
fig_deseq2_unfilt <- df_fig_deseq2_unfilt %>%
  ggplot(aes(x = Genus, y = log2FoldChange, fill = direct)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for Genus in DESeq2 analysis") + 
  scale_fill_discrete(name = NULL) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, color = df_fig_deseq2_unfilt$color)
  )

fig_deseq2_unfilt

# Print the plot
print(fig_deseq2_unfilt)



```


#### ASV
```{r , echo=FALSE, warning=FALSE, message=FALSE, fig.height=10}

# c("TOX_SEVERA","sex","simplified_location","age_group")

diagdds = phyloseq_to_deseq2(tox_ps_final, ~ TOX_SEVERA+sex+simplified_location+age_group)
# manual filtering of no essential features
lowtox_group <- min(table(colData(dds)$TOX_SEVERA))
keep <- rowSums(counts(dds) >= 10) >= lowtox_group
diagdds <- dds[keep,]
diagdds <- estimateSizeFactors(diagdds, type = "poscounts") # to avoid zero log error
diagdds = DESeq(diagdds, test="Wald", fitType="parametric")

res = results(diagdds, cooksCutoff = TRUE)
# raw p-values vs adjusted p-values (by BH)

res_df <- as.data.frame(res) %>%
  dplyr::mutate(
    status = case_when(
      is.na(pvalue) & is.na(padj) ~ "outlier/zero counts",
      !is.na(pvalue) & is.na(padj) ~ "filtered (low count)",
      padj <  0.05               ~ "significant",
      TRUE                       ~ "non-significant"
    )
  )

table(res_df$status)

#lfcShrink
res.ape <- lfcShrink(dds=diagdds, coef=2, type="apeglm")

# significant features
alpha = 0.05
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(tox_ps_final)[rownames(sigtab), ], "matrix"))
head(sigtab)

library("ggplot2")
theme_set(theme_bw())
scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
# Phylum order
# x = tapply(sigtab$log2FoldChange, sigtab$Phylum, function(x) max(x))
# x = sort(x, TRUE)
# sigtab$Phylum = factor(as.character(sigtab$Phylum), levels=names(x))
# Genus order
x = tapply(sigtab$log2FoldChange, sigtab$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtab$Genus = factor(as.character(sigtab$Genus), levels=names(x))
# ggplot(sigtab, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
#   theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))

# # Volcano plot
# plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")

# Filter and arrange data for plotting (similar to df_fig_deseq2)
fig_deseq2_unfilt_ASV <- sigtab %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.01, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
fig_deseq2_unfilt_ASV$Genus <- factor(fig_deseq2_unfilt_ASV$Genus, levels = fig_deseq2_unfilt_ASV$Genus)
fig_deseq2_unfilt_ASV$direct <- factor(fig_deseq2_unfilt_ASV$direct, levels = c("Positive LFC", "Negative LFC"))

# Create the plot
fig_deseq2_unfilt_ASV <- fig_deseq2_unfilt_ASV %>%
  ggplot(aes(x = Genus, y = log2FoldChange, fill = direct)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for Genus in DESeq2 analysis") + 
  scale_fill_discrete(name = NULL) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, color = fig_deseq2_unfilt_ASV$color)
  )


fig_deseq2_unfilt_ASV

# Print the plot
print(fig_deseq2_unfilt_ASV)



```




### Prevalence filtering
#### Genus
```{r , echo=FALSE,  warning=FALSE,  message=FALSE, fig.height=10}

diagdds = phyloseq_to_deseq2(physeq_filtered_genus, ~ TOX_SEVERA+sex+simplified_location+age_group)
# manual filtering of no essential features
lowtox_group <- min(table(colData(dds)$TOX_SEVERA))
keep <- rowSums(counts(dds) >= 10) >= lowtox_group
diagdds <- dds[keep,]
diagdds <- estimateSizeFactors(diagdds, type = "poscounts") # to avoid zero log error
diagdds = DESeq(diagdds, test="Wald", fitType="parametric")

res = results(diagdds, cooksCutoff = TRUE)
# raw p-values vs adjusted p-values (by BH)

res_df <- as.data.frame(res) %>%
  dplyr::mutate(
    status = case_when(
      is.na(pvalue) & is.na(padj) ~ "outlier/zero counts",
      !is.na(pvalue) & is.na(padj) ~ "filtered (low count)",
      padj <  0.05               ~ "significant",
      TRUE                       ~ "non-significant"
    )
  )

table(res_df$status)

#lfcShrink
res.ape <- lfcShrink(dds=diagdds, coef=2, type="apeglm")

# significant features
alpha = 0.05
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq_filtered_genus)[rownames(sigtab), ], "matrix"))
head(sigtab)

theme_set(theme_bw())
scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
# Phylum order
# x = tapply(sigtab$log2FoldChange, sigtab$Phylum, function(x) max(x))
# x = sort(x, TRUE)
# sigtab$Phylum = factor(as.character(sigtab$Phylum), levels=names(x))
# Genus order
x = tapply(sigtab$log2FoldChange, sigtab$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtab$Genus = factor(as.character(sigtab$Genus), levels=names(x))

# ggplot(sigtab, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
#   theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
# 
# # Volcano plot
# plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2_filt_Genus <- sigtab %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.01, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
df_fig_deseq2_filt_Genus$Genus <- factor(df_fig_deseq2_filt_Genus$Genus, levels = df_fig_deseq2_filt_Genus$Genus)
df_fig_deseq2_filt_Genus$direct <- factor(df_fig_deseq2_filt_Genus$direct, levels = c("Positive LFC", "Negative LFC"))

# Create the plot
fig_deseq2_filt_Genus <- df_fig_deseq2_filt_Genus %>%
  ggplot(aes(x = Genus, y = log2FoldChange, fill = direct)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for Genus in DESeq2 analysis") + 
  scale_fill_discrete(name = NULL) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, color = df_fig_deseq2_filt_Genus$color)
  )

fig_deseq2_filt_Genus

# Print the plot
print(fig_deseq2_filt_Genus)



```

#### ASV
```{r , echo=FALSE,  warning=FALSE,  message=FALSE, fig.height=10}

diagdds = phyloseq_to_deseq2(physeq_filtered, ~ TOX_SEVERA+sex+simplified_location+age_group)
# manual filtering of no essential features
lowtox_group <- min(table(colData(dds)$TOX_SEVERA))
keep <- rowSums(counts(dds) >= 10) >= lowtox_group
diagdds <- dds[keep,]
diagdds <- estimateSizeFactors(diagdds, type = "poscounts") # to avoid zero log error
diagdds = DESeq(diagdds, test="Wald", fitType="parametric")

res = results(diagdds, cooksCutoff = TRUE)
# raw p-values vs adjusted p-values (by BH)

res_df.ASV <- as.data.frame(res) %>%
  dplyr::mutate(
    status = case_when(
      is.na(pvalue) & is.na(padj) ~ "outlier/zero counts",
      !is.na(pvalue) & is.na(padj) ~ "filtered (low count)",
      padj <  0.05               ~ "significant",
      TRUE                       ~ "non-significant"
    )
  )

table(res_df.ASV$status)

#lfcShrink
res.ape <- lfcShrink(dds=diagdds, coef=2, type="apeglm")

# significant features
alpha = 0.05
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq_filtered)[rownames(sigtab), ], "matrix"))
head(sigtab)

theme_set(theme_bw())
scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
# Phylum order
# x = tapply(sigtab$log2FoldChange, sigtab$Phylum, function(x) max(x))
# x = sort(x, TRUE)
# sigtab$Phylum = factor(as.character(sigtab$Phylum), levels=names(x))
# Genus order
x = tapply(sigtab$log2FoldChange, sigtab$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtab$Genus = factor(as.character(sigtab$Genus), levels=names(x))
# ggplot(sigtab, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
#   theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
# 
# # Volcano plot
# plotMA(res, ylim=c(-2,2), main="Volcano plot DESeq2")

# Filter and arrange data for plotting (similar to df_fig_deseq2)
df_fig_deseq2_ASV <- sigtab %>%
  dplyr::arrange(desc(log2FoldChange)) %>%
  dplyr::mutate(
    direct = ifelse(log2FoldChange > 0, "Positive LFC", "Negative LFC"),
    color = ifelse(padj < 0.01, "aquamarine3", "black")  # Color based on significance
  )

# Ensure 'Genus' is a factor with levels ordered by 'log2FoldChange'
df_fig_deseq2_ASV$Genus <- factor(df_fig_deseq2_ASV$Genus, levels = df_fig_deseq2_ASV$Genus)
df_fig_deseq2_ASV$direct <- factor(df_fig_deseq2_ASV$direct, levels = c("Positive LFC", "Negative LFC"))

# Create the plot
fig_deseq2_ASV <- df_fig_deseq2_ASV %>%
  ggplot(aes(x = Genus, y = log2FoldChange, fill = direct)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black", 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = log2FoldChange - lfcSE, ymax = log2FoldChange + lfcSE), 
                width = 0.2, position = position_dodge(0.05), color = "black") + 
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for Genus in DESeq2 analysis") + 
  scale_fill_discrete(name = NULL) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, color = df_fig_deseq2$color)
  )

fig_deseq2_ASV

# Print the plot
print(fig_deseq2_ASV)



```

## LinDA

### Unfiltered prevalence
#### Genus
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10}
set.seed(9316)
# eval=FALSE,

# TOX_SEVERA+sex+simplified_location+age_group
otu.tab.filt <- as.data.frame(t(otu_table(tox_ps_final_genus)))#[, ind])
meta.filt <- cbind.data.frame(tox = factor(sample_data(tox_ps_final_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final_genus)$sex),
                         Site = factor(sample_data(tox_ps_final_genus)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         tnm = factor(sample_data(tox_ps_final_genus)$tnm), 
                         age_group = factor(sample_data(tox_ps_final_genus)$age_group) 
                         )
# testing by toxicity
# ind1 <- which(meta.filt$tox == 'low')
# res.low.filt <- linda(otu.tab.filt[, ind1], meta.filt[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta.filt$tox == 'sev')
# res.sev.filt <- linda(otu.tab.filt[, ind2], meta.filt[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low.filt$output[[1]])[which(res.low.filt$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev.filt$output[[1]])[which(res.sev.filt$output[[1]]$reject)]
# linda.obj.tox.filt <- linda(otu.tab.filt, meta.filt, formula = '~tox+Sex+Site+tnm+age_group', alpha = 0.05,
                   # prev.cut = 0.03, lib.cut = 1000, winsor.quan = 0.97)
# global linda object
linda.obj.tox.unfilt <- linda(otu.tab.filt, meta.filt, formula = '~tox+Sex+Site+age_group', alpha = 0.05,
                   prev.cut = 0.00, lib.cut = 1000, winsor.quan = 0.97)
# linda.obj.tox.sex <- linda(otu.tab, meta, formula = '~tox+Sex', alpha = 0.1,
#                    prev.cut = 0.1, lib.cut = 1000, winsor.quan = 0.97)
# linda.plot(linda.obj.tox.unfilt, c('toxsev', 'Sexmale'), 
#            titles = c('tox: low v.s. sev and female vs male'), alpha = 0.1, lfc.cut = 1,
#            legend = TRUE, directory = NULL, width = 11, height = 8)

# taxa
# 1. See which terms you tested:
term.names.tox.unfilt <- names(linda.obj.tox.unfilt$output)
# print(term.names.tox.unfilt)
# e.g.: [1] "SiteRight" "Sexmale"

# 2. For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.unfilt <- lapply(term.names.tox.unfilt, function(tnm) {
  df <- linda.obj.tox.unfilt$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.unfilt) <- term.names.tox.unfilt

# 3. Look at them
# sig.list.tox.unfilt
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# 4.All taxa unique name filtering
all.sig.taxa.tox.unfilt <- unique( unlist(sig.list.tox.unfilt) )
# all.sig.taxa.tox.unfilt
matched.tox.unfilt <- match(all.sig.taxa.tox.unfilt, rownames(tax_table(tox_ps_final_genus)))
sig_tax_df.tox.unfilt <- tax_table(tox_ps_final)[matched.tox.unfilt, ]
# sig_tax_df.tox.unfilt # "s__Bacteroides_vulgatus" en ambos asvs

#tax_table(physeq_filtered_lefse)[match("9df251784dde31e05f02b2ee1029d71c", tax_table(physeq_filtered_lefse)), ]

# 1. Aplana todos los data.frames de linda.obj$output en uno solo
linda_df_tox.unfilt <- imap_dfr(linda.obj.tox.unfilt$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Columns: estimate, std.error, p.value, p.adj, reject, taxa, term
# head(linda_df_tox.unfilt)




```

```{r linda_cov_genus_plot_noprev_noBH,  message=FALSE, warning=FALSE, fig.height=10}
# eval=FALSE, 
# Data preparation
df_noBH <- linda.obj.tox.unfilt$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val 
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(tox_ps_final_genus) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH <- df_fig_noBH %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    # symbol † to  p-only
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )

# print(df_fig_noBH)

# Plot of LinDA with BH correction
linda_plot_cov_genus_noprev_noBH <- linda_plot(df_fig_noBH)
linda_plot_cov_genus_noprev_noBH
 

```

As LinDA shows a strict criteria, we are showing and retaining the
features that shows at least qval \< 0.1.

```{r linda_cov_genus_plot_noprev_BH,  message=FALSE, warning=FALSE, fig.height=10}
#eval=FALSE, 
# Data preparation
df_fig <- linda.obj.tox.unfilt$output$toxsev %>%        # data.frame
  tibble::rownames_to_column("taxon_id") %>%     # 
  filter(reject) %>%
  transmute(
    taxon_id = as.character(taxon_id),
    logFC        = log2FoldChange,
    se           = lfcSE,
    qval         = as.numeric(padj),
    direction    = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt     = dplyr::case_when(
      qval < 0.001 ~ "***",
      qval < 0.01  ~ "**",
      qval < 0.05  ~ "*",
      qval < 0.1   ~ "-",
      TRUE         ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  filter(abs(logFC) > 1 | qval < 0.1) %>%
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC)



# Defining Alpha breaks
df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))
# Genus as tag
tax_tbl <- tax_table(tox_ps_final_genus) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)
df_fig <- df_fig %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

print(df_fig)

# Plot of LinDA with BH correction
linda_plot_cov_genus_noprev_BH <- linda_plot(df_fig)
linda_plot_cov_genus_noprev_BH


```


#### ASV
```{r , echo=FALSE, message=FALSE, warning=FALSE, fig.height=10}
set.seed(9316)


# TOX_SEVERA+sex+simplified_location+age_group
otu.tab.filt.ASV <- as.data.frame(t(otu_table(tox_ps_final)))#[, ind])
meta.filt <- cbind.data.frame(tox = factor(sample_data(tox_ps_final)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final)$sex),
                         Site = factor(sample_data(tox_ps_final)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         tnm = factor(sample_data(tox_ps_final)$tnm), 
                         age_group = factor(sample_data(tox_ps_final)$age_group) 
                         )
# testing by toxicity
# ind1 <- which(meta.filt$tox == 'low')
# res.low.filt <- linda(otu.tab.filt.ASV[, ind1], meta.filt[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta.filt$tox == 'sev')
# res.sev.filt <- linda(otu.tab.filt.ASV[, ind2], meta.filt[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low.filt$output[[1]])[which(res.low.filt$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev.filt$output[[1]])[which(res.sev.filt$output[[1]]$reject)]
# linda.obj.tox.filt <- linda(otu.tab.filt, meta.filt, formula = '~tox+Sex+Site+tnm+age_group', alpha = 0.05,
                   # prev.cut = 0.03, lib.cut = 1000, winsor.quan = 0.97)
# global linda object
linda.obj.tox.unfilt.ASV <- linda(otu.tab.filt.ASV, meta.filt, formula = '~tox+Sex+Site+age_group', alpha = 0.05,
                   prev.cut = 0, lib.cut = 1000, winsor.quan = 0.97)
# linda.obj.tox.sex <- linda(otu.tab, meta, formula = '~tox+Sex', alpha = 0.1,
#                    prev.cut = 0.1, lib.cut = 1000, winsor.quan = 0.97)
# linda.plot(linda.obj.tox.unfilt.ASV, c('toxsev', 'Sexmale'), 
#            titles = c('tox: low v.s. sev and female vs male'), alpha = 0.1, lfc.cut = 1,
#            legend = TRUE, directory = NULL, width = 11, height = 8)

# taxa
# See which terms you tested:
term.names.tox.unfilt <- names(linda.obj.tox.unfilt.ASV$output)
# print(term.names.tox.unfilt)
# e.g.: [1] "SiteRight" "Sexmale"

#  For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.unfilt <- lapply(term.names.tox.unfilt, function(tnm) {
  df <- linda.obj.tox.unfilt.ASV$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.unfilt) <- term.names.tox.unfilt

#  Look at them
sig.list.tox.unfilt
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# All taxa unique name filtering
all.sig.taxa.tox.unfilt <- unique( unlist(sig.list.tox.unfilt) )
all.sig.taxa.tox.unfilt
matched.tox.unfilt <- match(all.sig.taxa.tox.unfilt, rownames(tax_table(tox_ps_final)))
sig_tax_df.tox.unfilt <- tax_table(tox_ps_final)[matched.tox.unfilt, ]
sig_tax_df.tox.unfilt # "s__Bacteroides_vulgatus" en ambos asvs

#tax_table(physeq_filtered_lefse)[match("9df251784dde31e05f02b2ee1029d71c", tax_table(physeq_filtered_lefse)), ]

# join all linda dfs into one
linda_df_tox.unfilt.ASV <- imap_dfr(linda.obj.tox.unfilt.ASV$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Columns: estimate, std.error, p.value, p.adj, reject, taxa, term
# head(linda_df_tox.unfilt.ASV)




```

```{r}

# Data preparation
df_noBH <- linda.obj.tox.unfilt.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(tox_ps_final_genus) %>%          
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH <- df_fig_noBH %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    # symbol † to  p-only
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )


# print(df_fig_noBH)

# Plot of LinDA with BH correction

linda_plot_cov_ASV_noprev_noBH <- linda_plot(df_fig_noBH)
linda_plot_cov_ASV_noprev_noBH


```

As LinDA shows a strict criteria, we are showing and retaining the
features that shows at least qval \< 0.1.

```{r}


# Data preparation
df_fig <- linda.obj.tox.unfilt.ASV$output$toxsev %>%        # data.frame
  tibble::rownames_to_column("taxon_id") %>%     # 
  filter(reject) %>%
  transmute(
    taxon_id = as.character(taxon_id),
    logFC        = log2FoldChange,
    se           = lfcSE,
    qval         = as.numeric(padj),
    direction    = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt     = dplyr::case_when(
      qval < 0.001 ~ "***",
      qval < 0.01  ~ "**",
      qval < 0.05  ~ "*",
      qval < 0.1   ~ "-",
      TRUE         ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  filter(abs(logFC) > 1 | qval < 0.1) %>%
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC)



# Defining Alpha breaks
df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))
# Genus as tag
tax_tbl <- tax_table(tox_ps_final_genus) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)
df_fig <- df_fig %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

print(df_fig)
print("No feature was found significantly different.")
# Plot of LinDA with BH correction
# linda_plot_cov_ASV_noprev_BH_01 <- linda_plot(df_fig)
# linda_plot_cov_ASV_noprev_BH_01


```

### Prevalence filtering
#### Genus
```{r , echo=FALSE, message=FALSE, warning=FALSE, fig.height=10}
set.seed(9316)

otu.tab.filt <- as.data.frame(t(otu_table(physeq_filtered_genus)))#[, ind])
meta.filt <- cbind.data.frame(tox = factor(sample_data(physeq_filtered_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered_genus)$sex),
                         Site = factor(sample_data(physeq_filtered_genus)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         tnm = factor(sample_data(physeq_filtered_genus)$tnm), 
                         age_group = factor(sample_data(physeq_filtered_genus)$age_group) 
                         )

# testing by toxicity
# ind1 <- which(meta.filt$tox == 'low')
# res.low.filt <- linda(otu.tab.filt[, ind1], meta.filt[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta.filt$tox == 'sev')
# res.sev.filt <- linda(otu.tab.filt[, ind2], meta.filt[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low.filt$output[[1]])[which(res.low.filt$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev.filt$output[[1]])[which(res.sev.filt$output[[1]]$reject)]

# linda.obj.tox.filt <- linda(otu.tab.filt, meta.filt, formula = '~tox+Sex+Site+tnm+age_group', alpha = 0.05,
#                    prev.cut = 0.03, lib.cut = 1000, winsor.quan = 0.97)
# global linda
linda.obj.tox.filt <- linda(otu.tab.filt, meta.filt, formula = '~tox+Sex+Site+age_group', alpha = 0.05,
                   prev.cut = 0, lib.cut = 1000, winsor.quan = 0.97)
# linda.obj.tox.sex <- linda(otu.tab, meta, formula = '~tox+Sex', alpha = 0.1,
#                    prev.cut = 0.1, lib.cut = 1000, winsor.quan = 0.97)
# linda.plot(linda.obj.tox.filt, c('toxsev', 'Sexmale'), 
#            titles = c('tox: low v.s. sev and female vs male'), alpha = 0.1, lfc.cut = 1,
#            legend = TRUE, directory = NULL, width = 11, height = 8)

# See which terms you tested:
term.names.tox.filt <- names(linda.obj.tox.filt$output)
# print(term.names.tox.filt)
# e.g.: [1] "SiteRight" "Sexmale"

# For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.filt <- lapply(term.names.tox.filt, function(tnm) {
  df <- linda.obj.tox.filt$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.filt) <- term.names.tox.filt

# Look at them
# sig.list.tox.filt
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

# Unique taxa 
all.sig.taxa.tox.filt <- unique( unlist(sig.list.tox.filt) )
# all.sig.taxa.tox.filt

# taxa names
matched.tox.filt <- match(all.sig.taxa.tox.filt, rownames(tax_table(physeq_filtered_genus)))
sig_tax_df.tox.filt <- tax_table(physeq_filtered)[matched.tox.filt, ]
# sig_tax_df.tox.filt # "s__Bacteroides_vulgatus" en ambos asvs

# tax_table(physeq_filtered)[match("9df251784dde31e05f02b2ee1029d71c", tax_table(physeq_filtered)), ]


# join all linda dfs into the same
linda_df_tox.filt <- imap_dfr(linda.obj.tox.filt$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Columns: estimate, std.error, p.value, p.adj, reject, taxa, term
# head(linda_df_tox.filt)



```

```{r linda_cov_genus_plot_prev_noBH, message=FALSE, warning=FALSE, fig.height=10}


# Data preparation
df_noBH <- linda.obj.tox.filt$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val 
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filters
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(physeq_filtered_genus) %>%          
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH <- df_fig_noBH %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    #symbol † to  p-only
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )

# print(df_fig_noBH)

# Plot of LinDA with BH correction
linda_plot_cov_genus_prev_noBH_01 <- linda_plot(df_fig_noBH)
linda_plot_cov_genus_prev_noBH_01



```

As LinDA shows a strict criteria, we are showing and retaining the
features that shows at least qval \< 0.1.

```{r linda_cov_genus_plot_prev_BH, message=FALSE, warning=FALSE, fig.height=10}

df_fig <- linda.obj.tox.filt$output$toxsev %>%        # data.frame
  tibble::rownames_to_column("taxon_id") %>% # 
  filter(reject) %>%   
  transmute(
    taxon_id,
    logFC        = log2FoldChange,   # log2FoldChange
    se         = lfcSE,      # standar error
    qval       = padj,      # q‑value (padj)
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    qval_txt   = ifelse(qval < 0.001, "***",
                     ifelse(qval < 0.01, "**",
                     ifelse(qval < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "tox (sev vs low)"
  ) %>%
  # optional: filtering
  filter(abs(logFC) > 1 | qval < 0.1) %>%        
  # optional: 
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%  # optional: change it
  arrange(logFC)

df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("Inf", "0.01", "0.05")))

tax_tbl <- tax_table(physeq_filtered_genus) %>%         
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig <- df_fig %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

# print(df_fig)

linda_plot_cov_genus_prev_BH_01 <- linda_plot(df_fig)
linda_plot_cov_genus_prev_BH_01


```


#### ASV

```{r , echo=FALSE, message=FALSE, warning=FALSE, fig.height=10}
set.seed(9316)

otu.tab.filt.ASV <- as.data.frame(t(otu_table(physeq_filtered)))#[, ind])
meta.filt <- cbind.data.frame(tox = factor(sample_data(physeq_filtered)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered)$sex),
                         Site = factor(sample_data(physeq_filtered)$simplified_location),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         tnm = factor(sample_data(physeq_filtered)$tnm), 
                         age_group = factor(sample_data(physeq_filtered)$age_group) 
                         )

# # testing by toxicity
# ind1 <- which(meta.filt$tox == 'low')
# res.low.filt <- linda(otu.tab.filt.ASV[, ind1], meta.filt[ind1, ], formula = '~Sex', alpha = 0.05,
#                   prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# ind2 <- which(meta.filt$tox == 'sev')
# res.sev.filt <- linda(otu.tab.filt.ASV[, ind2], meta.filt[ind2, ], formula = '~Sex', alpha = 0.05,
#                    prev.cut = 0.01, lib.cut = 1000, winsor.quan = 0.97)
# print("low tox linda")
# rownames(res.low.filt$output[[1]])[which(res.low.filt$output[[1]]$reject)]
# print("sev tox linda")
# rownames(res.sev.filt$output[[1]])[which(res.sev.filt$output[[1]]$reject)]

# linda.obj.tox.filt <- linda(otu.tab.filt, meta.filt, formula = '~tox+Sex+Site+tnm+age_group', alpha = 0.05,
#                    prev.cut = 0.03, lib.cut = 1000, winsor.quan = 0.97)
# global linda
linda.obj.tox.filt.ASV <- linda(otu.tab.filt.ASV, meta.filt, formula = '~tox+Sex+Site+age_group', alpha = 0.05,
                   prev.cut = 0.00, lib.cut = 1000, winsor.quan = 0.97)
# linda.obj.tox.sex <- linda(otu.tab, meta, formula = '~tox+Sex', alpha = 0.1,
#                    prev.cut = 0.1, lib.cut = 1000, winsor.quan = 0.97)
# linda.plot(linda.obj.tox.filt.ASV, c('toxsev', 'Sexmale'), 
#            titles = c('tox: low v.s. sev and female vs male'), alpha = 0.1, lfc.cut = 1,
#            legend = TRUE, directory = NULL, width = 11, height = 8)

# taxa
# See which terms you tested:
term.names.tox.filt <- names(linda.obj.tox.filt.ASV$output)
# print(term.names.tox.filt)
# e.g.: [1] "SiteRight" "Sexmale"

#  For each term, get the taxa that reject H0 at alpha=0.1
sig.list.tox.filt <- lapply(term.names.tox.filt, function(tnm) {
  df <- linda.obj.tox.filt.ASV$output[[tnm]]
  rownames(df)[ df$reject ]
})
names(sig.list.tox.filt) <- term.names.tox.filt

# Look at them
# sig.list.tox.filt
# e.g.: $SiteRight
#       [1] "Taxon_5" "Taxon_12"
#      $Sexmale
#       [1] "Taxon_3"

#  Unique taxa 
all.sig.taxa.tox.filt <- unique( unlist(sig.list.tox.filt) )
# all.sig.taxa.tox.filt

# taxa names
matched.tox.filt <- match(all.sig.taxa.tox.filt, rownames(tax_table(physeq_filtered)))
sig_tax_df.tox.filt <- tax_table(physeq_filtered)[matched.tox.filt, ]
# sig_tax_df.tox.filt # "s__Bacteroides_vulgatus" en ambos asvs

# tax_table(physeq_filtered)[match("9df251784dde31e05f02b2ee1029d71c", tax_table(physeq_filtered)), ]



# Join all linda dfs into one
linda_df_tox.filt.ASV <- imap_dfr(linda.obj.tox.filt.ASV$output, 
  ~ .x %>% 
      dplyr::mutate(taxa  = rownames(.x),    # saca el nombre de la fila
             term  = .y)              # el nombre del término (p.ej. "SmokeY")
)

# Columns: estimate, std.error, p.value, p.adj, reject, taxa, term
# head(linda_df_tox.filt.ASV)



```

```{r}

# Data preparation
df_noBH <- linda.obj.tox.filt.ASV$output$toxsev %>%
  tibble::rownames_to_column("taxon_id") %>%
  transmute(
    taxon_id,
    logFC = log2FoldChange,
    se    = lfcSE,
    pval  = pvalue,          # raw p-val 
    qval  = padj,            # q-val (BH)
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    qval_txt   = dplyr::case_when(
      !is.na(qval) & qval < 0.001 ~ "***",
      !is.na(qval) & qval < 0.01  ~ "**",
      !is.na(qval) & qval < 0.05  ~ "*",
      !is.na(qval) & qval < 0.1   ~ "-",
      TRUE                        ~ ""
    ),
    orientation  = ifelse(logFC > 0, 1, -1),
    target_level = "tox (sev vs low)"
  ) %>%
  # optional: filter
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%
  arrange(logFC) %>%
  dplyr::mutate(
    p_sig = !is.na(pval) & pval < 0.05,
    q_sig = !is.na(qval) & qval < 0.05,
    sig   = case_when(
      q_sig ~ "BH<0.05",
      p_sig ~ "p<0.05 (solo)",
      TRUE  ~ "ns"
    )
  )

df_fig_noBH <- df_noBH %>%
  filter(abs(logFC) > 1 | p_sig | (!is.na(qval) & qval < 0.1))
# Defining Alpha breaks
df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("1", "0.6", "0.3")))

# Genus as tag
tax_tbl <- tax_table(physeq_filtered) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)

df_fig_noBH <- df_fig_noBH %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

df_fig_noBH <- df_fig_noBH %>%
  dplyr::mutate(
    p_sig  = !is.na(pval) & pval < 0.05,
    q_sig  = !is.na(qval) & qval < 0.05,
    p_only = p_sig & !q_sig,
    # alpha associated to qval
    sig_q  = case_when(
      !is.na(qval) & qval < 0.01 ~ "q<0.01",
      !is.na(qval) & qval < 0.05 ~ "q<0.05",
      !is.na(qval) & qval < 0.10 ~ "q<0.10",
      TRUE                       ~ "ns"
    ),
    sig_q  = factor(sig_q, levels = c("q<0.01","q<0.05","q<0.10","ns")),
    # if p_only, adding † 
    qval_txt = if_else(p_only & qval_txt == "", "†", paste0(qval_txt, if_else(p_only,"†","")))
  )


# print(df_fig_noBH)

# Plot of LinDA with BH correction
linda_plot_cov_ASV_prev_noBH <- linda_plot(df_fig_noBH)
linda_plot_cov_ASV_prev_noBH


```

As LinDA shows a strict criteria, we are showing and retaining the
features that shows at least qval \< 0.1.

```{r linda_prev_asv_confounders_res_dfs}

df_fig <- linda.obj.tox.filt.ASV$output$toxsev %>%        # data.frame 
  tibble::rownames_to_column("taxon_id") %>% # 
  filter(reject) %>%   
  transmute(
    taxon_id,
    logFC        = log2FoldChange,   # log2FoldChange
    se         = lfcSE,      # standar error
    qval       = padj,      # q‑value (padj)
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    direction  = ifelse(logFC > 0, "Sev", "Low"),
    enrich_group = ifelse(logFC > 0, 1L, 0L),
    qval_txt   = ifelse(qval < 0.001, "***",
                     ifelse(qval < 0.01, "**",
                     ifelse(qval < 0.05, "*", ""))),
        orientation = ifelse(logFC > 0, 1, -1),
        target_level = "tox (sev vs low)"
  ) %>%
  # optional:filtering
  filter(abs(logFC) > 1 | qval < 0.1) %>%        #
  # optional: 
  filter(!grepl("Incertae|uncultured", taxon_id, ignore.case = TRUE)) %>%  # optional: remove it
  arrange(logFC)

## scaling (alpha) 
df_fig <- df_fig %>%
  dplyr::mutate(alpha_grp = cut(qval,
                         breaks = c(-Inf, 0.01, 0.05, Inf),
                         labels = c("Inf", "0.01", "0.05")))

tax_tbl <- tax_table(physeq_filtered) %>%           
           as.data.frame() %>%
           tibble::rownames_to_column("taxon_id") %>%
           dplyr::select(taxon_id, Genus)
df_fig <- df_fig %>%
  dplyr::left_join(tax_tbl, by = "taxon_id") %>%
  dplyr::mutate(label = ifelse(!is.na(Genus) & Genus != "", Genus, taxon_id))

# print(df_fig)

linda_plot_cov_ASV_prev_noBH_01 <- linda_plot(df_fig)
linda_plot_cov_ASV_prev_noBH_01



```


## ZicoSeq

### Unfiltered prevalence
#### Genus
```{r  zicoseq_noprev_genus_cofounders, message=FALSE, warning=FALSE, fig.height=10}
set.seed(96754)

otu_tab_ZS <- as(otu_table(tox_ps_final_genus), "matrix") # otu_table(tox_ps_final)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1
# metadata
# features as columns and samples as rows.
metadata_ZS <- cbind.data.frame(sampleid = (sample_data(tox_ps_final_genus)$biosample_name),
                         tox = factor(sample_data(tox_ps_final_genus)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final_genus)$sex),
                         Age = factor(sample_data(tox_ps_final_genus)$age_group),
                         Site = factor(sample_data(tox_ps_final_genus)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         metastasis = factor(sample_data(tox_ps_final_genus)$has_metastasis),
                         row.names = rownames(sample_data(tox_ps_final_genus)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj.unfilt.genus <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox', adj.name =  c('Sex', 'Age', 'Site'), feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0, is.winsor = TRUE) #, 
                    # # Winsorization to replace outliers
                    # is.winsor = TRUE, outlier.pct = 0.03, winsor.end = 'top',
                    # # Posterior sampling 
                    # is.post.sample = FALSE, post.sample.no = 25, 
                    # # Use the square-root transformation
                    # link.func = list(function (x) x^0.5), stats.combine.func = max,
                    # # Permutation-based multiple testing correction
                    # perm.no = 99,  strata = NULL, 
                    # # Reference-based multiple stage normalization
                    # ref.pct = 0.5, stage.no = 6, excl.pct = 0.2,
                    # # Family-wise error rate control
                     # is.fwer = TRUE, verbose = TRUE, return.feature.dat = TRUE)


ZicoSeq.plot(ZicoSeq.obj.unfilt.genus, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r unfilt_extracting_zicoseq_taxa_genus_cofounder , fig.height=10}
set.seed(96754)

# Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj.unfilt.genus$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj$coef.list[[1]])), 
]

#  Extract raw and adjusted p-values
pvals <- ZicoSeq.obj.unfilt.genus$p.raw
names(pvals) <- rownames(ZicoSeq.obj.unfilt.genus$R2)

qvals <- ZicoSeq.obj.unfilt.genus$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj.unfilt.genus$R2)

#  Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(tox_ps_final_genus))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_prev_NoBH_cof <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "no",
    method       = "ZicoSeq"
  )

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_prev_BH_cof <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "yes",
    method       = "ZicoSeq"
  )

### -------- Combine both results -------- ###
res_zicoseq_prev_cof <- bind_rows(res_zicoseq_prev_NoBH_cof, res_zicoseq_prev_BH_cof)

```

```{r zicoseq_noprev_genus_cofounders_plot, fig.height=10}

# Plot 1: Without BH correction
p1_noprenobh <- plot_logFC_bar(res_zicoseq_prev_NoBH_cof, "ZicoSeq with cofounders (Prevalence No BH correction)")

# Plot 2: With BH correction
p2_noprebh <- plot_logFC_bar(res_zicoseq_prev_BH_cof, "ZicoSeq with cofounders (Prevalence With BH correction)")

# print(p1_prenobh)
# print(p2_prebh)

```

#### ASV
```{r  zicoseq_noprev_asv_cofounders, message=FALSE, warning=FALSE, fig.height=10}
set.seed(96754)

otu_tab_ZS <- as(otu_table(tox_ps_final), "matrix") # otu_table(tox_ps_final)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1
# metadata
metadata_ZS <- cbind.data.frame(sampleid = (sample_data(tox_ps_final)$biosample_name),
                         tox = factor(sample_data(tox_ps_final)$TOX_FACTOR),
                         Sex = factor(sample_data(tox_ps_final)$sex),
                         Age = factor(sample_data(tox_ps_final)$age_group),
                         Site = factor(sample_data(tox_ps_final)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         metastasis = factor(sample_data(tox_ps_final)$has_metastasis),
                         row.names = rownames(sample_data(tox_ps_final)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox', adj.name =  c('Sex', 'Age', 'Site'), feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) #, 
                    # # Winsorization to replace outliers
                    # is.winsor = TRUE, outlier.pct = 0.03, winsor.end = 'top',
                    # # Posterior sampling 
                    # is.post.sample = FALSE, post.sample.no = 25, 
                    # # Use the square-root transformation
                    # link.func = list(function (x) x^0.5), stats.combine.func = max,
                    # # Permutation-based multiple testing correction
                    # perm.no = 99,  strata = NULL, 
                    # # Reference-based multiple stage normalization
                    # ref.pct = 0.5, stage.no = 6, excl.pct = 0.2,
                    # # Family-wise error rate control
                     # is.fwer = TRUE, verbose = TRUE, return.feature.dat = TRUE)


ZicoSeq.plot(ZicoSeq.obj, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r unfilt_extracting_zicoseq_taxa_ASV , fig.height=10}
set.seed(96754)

#  Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj$coef.list[[1]])), 
]

#  Extract raw and adjusted p-values
pvals <- ZicoSeq.obj$p.raw
names(pvals) <- rownames(ZicoSeq.obj$R2)

qvals <- ZicoSeq.obj$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj$R2)

#  Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(tox_ps_final))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_noprev_NoBH_ASV_cof <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "no",
    BH           = "no",
    method       = "ZicoSeq"
  )

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_noprev_BH_ASV_cof <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "no",
    BH           = "yes",
    method       = "ZicoSeq"
  )

### -------- Combine both results -------- ###
res_zicoseq_noprev_ASV_cof <- bind_rows(res_zicoseq_noprev_NoBH_ASV_cof, res_zicoseq_noprev_BH_ASV_cof)

```

```{r zicoseq_plot_noprev_cov, fig.height=10}

#  Plot 1: Without BH correction
p1_noprenobh_ASV_cof <- plot_logFC_bar(res_zicoseq_noprev_NoBH_ASV_cof, "ZicoSeq (No Prevalence No BH correction)")

#  Plot 2: With BH correction
p2_noprebh_ASV_cof <- plot_logFC_bar(res_zicoseq_noprev_BH_ASV_cof, "ZicoSeq (No Prevalence With BH correction)")

# print(p1_prenobh)
# print(p2_prebh)

```

### Prevalence filtering
#### Genus

```{r zicoseq_prev_genus_cofounders, message=FALSE, warning=FALSE, fig.height=10}
set.seed(96754)

otu_tab_ZS <- as(otu_table(physeq_filtered), "matrix") # otu_table(tox_ps_final)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1
# metadata
# features as columns and samples as rows.

metadata_ZS <- cbind.data.frame(sampleid = (sample_data(physeq_filtered)$biosample_name),
                         tox = factor(sample_data(physeq_filtered)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered)$sex),
                         Age = factor(sample_data(physeq_filtered)$age_group),
                         Site = factor(sample_data(physeq_filtered)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         metastasis = factor(sample_data(physeq_filtered)$has_metastasis),
                         row.names = rownames(sample_data(physeq_filtered)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox', adj.name = c('Sex', 'Age', 'Site'), feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) #, 
                    # # Winsorization to replace outliers
                    # is.winsor = TRUE, outlier.pct = 0.03, winsor.end = 'top',
                    # # Posterior sampling 
                    # is.post.sample = FALSE, post.sample.no = 25, 
                    # # Use the square-root transformation
                    # link.func = list(function (x) x^0.5), stats.combine.func = max,
                    # # Permutation-based multiple testing correction
                    # perm.no = 99,  strata = NULL, 
                    # # Reference-based multiple stage normalization
                    # ref.pct = 0.5, stage.no = 6, excl.pct = 0.2,
                    # # Family-wise error rate control
                     # is.fwer = TRUE, verbose = TRUE, return.feature.dat = TRUE)


ZicoSeq.plot(ZicoSeq.obj, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r filt_extracting_zicoseq_taxa_genus }

# Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj$coef.list[[1]])), 
]

# Extract raw and adjusted p-values
pvals <- ZicoSeq.obj$p.raw
names(pvals) <- rownames(ZicoSeq.obj$R2)

qvals <- ZicoSeq.obj$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj$R2)

#  Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(physeq_filtered))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_prev_NoBH_cof <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "no",
    method       = "ZicoSeq"
  )

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_prev_BH_cof <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "yes",
    method       = "ZicoSeq"
  )

### -------- Combine both results -------- ###
res_zicoseq_prev_cof <- bind_rows(res_zicoseq_prev_NoBH_cof, res_zicoseq_prev_BH_cof)

```

```{r  zicoseq_prev_genus_cofounders_plot, fig.height=10}

# Plot 1: Without BH correction
p1_prenobh_cof <- plot_logFC_bar(res_zicoseq_prev_NoBH_cof, "ZicoSeq with cofounders (Prevalence No BH correction)")
p1_prenobh_cof
# Plot 2: With BH correction
p2_prebh_cof <- plot_logFC_bar(res_zicoseq_prev_BH_cof, "ZicoSeq with cofounders (Prevalence With BH correction)")
p2_prebh_cof

```


#### ASV
```{r  zicoseq_prev_asv_cofounders , message=FALSE, warning=FALSE, fig.height=10}
set.seed(96754)

otu_tab_ZS <- as(otu_table(physeq_filtered), "matrix") # otu_table(tox_ps_final)
otu_tab_ZS <- as.matrix(t(otu_tab_ZS))
class(otu_tab_ZS)
comm <- otu_tab_ZS
comm.0 <- comm[rowMeans(comm != 0) >= 0.2, ] + 1
# metadata
# features as columns and samples as rows.


metadata_ZS <- cbind.data.frame(sampleid = (sample_data(physeq_filtered)$biosample_name),
                         tox = factor(sample_data(physeq_filtered)$TOX_FACTOR),
                         Sex = factor(sample_data(physeq_filtered)$sex),
                         Age = factor(sample_data(physeq_filtered)$age_group),
                         Site = factor(sample_data(physeq_filtered)$localization),
                         # SubjectID = factor(sample_data(tox_ps_final_lefse)$sample.id)
                         metastasis = factor(sample_data(physeq_filtered)$has_metastasis),
                         row.names = rownames(sample_data(physeq_filtered)),
                         stringsAsFactors = FALSE
                         )

ZicoSeq.obj_ASV_cof <- ZicoSeq(meta.dat = metadata_ZS, feature.dat = comm.0, 
                    grp.name = 'tox', adj.name = c('Sex', 'Age', 'Site'), feature.dat.type = "other",
                    # Filter to remove rare taxa
                    prev.filter = 0, mean.abund.filter = 0,  
                    max.abund.filter = 0, min.prop = 0) #, 
                    # # Winsorization to replace outliers
                    # is.winsor = TRUE, outlier.pct = 0.03, winsor.end = 'top',
                    # # Posterior sampling 
                    # is.post.sample = FALSE, post.sample.no = 25, 
                    # # Use the square-root transformation
                    # link.func = list(function (x) x^0.5), stats.combine.func = max,
                    # # Permutation-based multiple testing correction
                    # perm.no = 99,  strata = NULL, 
                    # # Reference-based multiple stage normalization
                    # ref.pct = 0.5, stage.no = 6, excl.pct = 0.2,
                    # # Family-wise error rate control
                     # is.fwer = TRUE, verbose = TRUE, return.feature.dat = TRUE)


ZicoSeq.plot(ZicoSeq.obj_ASV_cof, pvalue.type = 'p.adj.fdr', cutoff = 0.1, text.size = 10,
             out.dir = NULL, width = 10, height = 6)



```

```{r filt_extracting_zicoseq_taxa_ASV }

# 1) Extract coefficient vector for your comparison
coef.vec <- ZicoSeq.obj_ASV_cof$coef.list[[1]][
  grep("^tox", rownames(ZicoSeq.obj_ASV_cof$coef.list[[1]])), 
]

# 2) Extract raw and adjusted p-values
pvals <- ZicoSeq.obj_ASV_cof$p.raw
names(pvals) <- rownames(ZicoSeq.obj_ASV_cof$R2)

qvals <- ZicoSeq.obj_ASV_cof$p.adj.fdr
names(qvals) <- rownames(ZicoSeq.obj_ASV_cof$R2)

# 3) Convert tax_table from phyloseq object to a data frame
tax.df <- as.data.frame(tax_table(physeq_filtered))

### -------- Without BH correction -------- ###
sig.nobh <- which(pvals <= 0.1)
sig.tax.nobh <- names(sig.nobh)
sig.coefs.nobh <- coef.vec[sig.tax.nobh]

res_zicoseq_prev_NoBH_ASV_cof <- data.frame(
  feature  = sig.tax.nobh,                                # Keep ASV / feature ID
  bacteria = tax.df[sig.tax.nobh, "Genus"],               # Show Genus as main name
  logFC    = sig.coefs.nobh,
  pval     = pvals[sig.tax.nobh],
  qval     = qvals[sig.tax.nobh],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),    
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "no",
    method       = "ZicoSeq"
  )

### -------- With BH correction -------- ###
sig <- which(qvals <= 0.1)
sig.tax <- names(sig)
sig.coefs <- coef.vec[sig.tax]

res_zicoseq_prev_BH_ASV_cof <- data.frame(
  feature  = sig.tax,
  bacteria = tax.df[sig.tax, "Genus"],
  logFC    = sig.coefs,
  pval     = pvals[sig.tax],
  qval     = qvals[sig.tax],
  row.names = NULL
) %>%
  dplyr::mutate(
    enrich_group = ifelse(logFC > 0, 1L, 0L),      
    direction    = ifelse(logFC > 0, "Positive LFC", "Negative LFC"),
    orientation  = ifelse(logFC > 0, 1, -1),
    qval.txt     = cut(qval, c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", "-")),
    target_level = "Genus",
    prevalence   = "yes",
    BH           = "yes",
    method       = "ZicoSeq"
  )

### -------- Combine both results -------- ###
res_zicoseq_prev_ASV_cof <- bind_rows(res_zicoseq_prev_NoBH_ASV_cof, res_zicoseq_prev_BH_ASV_cof)

```

```{r zicoseq_plot_prev_cov, fig.height=10}

#  Plot 1: Without BH correction
p1_prenobh_ASV_cof <- plot_logFC_bar(res_zicoseq_prev_NoBH_ASV_cof, "ZicoSeq with cofounders (Prevalence No BH correction)")
p1_prenobh_ASV_cof
#  Plot 2: With BH correction
p2_prebh_ASV_cof <- plot_logFC_bar(res_zicoseq_prev_BH_ASV_cof, "ZicoSeq with cofounders (Prevalence With BH correction)")
p2_prebh_ASV_cof

```

# Findings

This study integrates clinical stratification with microbiome profiling
to answer the research questions from section Research Questions. 



[R] Key Results 


These results suggest that two principal bacteria could be set as bacterial biomarkers: 
**Parvimonas** for *low* toxicity classification; and **Fusicatenibacter** for 
*severe* toxicity classification. 


Another bacterial genera could be useful to keep in future evaluations such as
- **Lachnospira** and **Lachnospiraceae NK4A136**
- **Family XIII AD3011 group**
- **Ruminococcus torques** and **Ruminococcus gnavus**
- **Eubacterium ventriosum** could be of interest in severe toxicity.
- **Eubacterium** genera members could help if the taxonomical level arrives to 
species or strain, in order to be splitted between the two toxicity levels evaluated. 
- This could help with **Oscillospirales** order members too.


Interestingly, **Blautia** species or strains could be relevant to separate between 
these two toxicities classes. That is one of the reasons why future work will be
focus on MiniON Oxford Nanopore sequencing. 


[M] Methodological Note

### Methods without features when applying BH correction

In the case of ALDEx2 and LEfSE, no features were retained when the BH correction 
was applied, independently that if this was of the unfiltered or filtered by 
prevalence. 
Additionally, ALDEx2 was one of the method that allowed the 
cofounders addition. Surprisedly, it didn't return results when
BH correction was applied. 


### Confounders analysis final thoughts

- ANCOM-BC reported the highest number of new biomarkers to be kept in mind for
future studies. Meanwhile, ALDEx2 still did not return any significant biomarkers. 


- LinDA returned some relevant bacterial biomarkers previously related with 
colorectal cancer prognosis such as **Bifidobacterium** or **Streptococcus**. 


- ZicoSeq and DESeq2 also kept similar results in number and in bacterial 
detection reported before the use of confounders. 

- LEfSe could not be used on this evaluation. 


When the initial analysis started with the difficulties this research 
faced (low dataset size), the use of confounders is a great strategy to get
meaningful outputs. So, the next step will also evaluated this subsection of 
the report in more detail.





# Conclusions
[\*] Conclusion 
  In conclusion, this study demonstrates the utility of integrating multiple 
  DAA methodologies and normalisation strategies to identify microbial 
  biomarkers associated with chemotherapy-related toxicity in colorectal cancer. 
  Of note, compositionally aware methods such as ANCOM-BC, LinDA, and ZicoSeq 
  proved most sensitive, detecting subtle microbial shifts in cohorts with
  minimal clinical divergence. DESeq2 reported a medium conservative and 
  sensitive results, although only one feature was retained in the filtered, 
  BH correction test. The more surprising tool was LEfSe, which reported no 
  features after BH correction in both filtered and unfiltered approaches 
  (even with two different normalizations: CPM vs TSS). Finally, ALDEx2 was
  the most conservative, reporting no features when FDR control was applied. 
  
  
  Despite differences in statistical assumptions and data transformations, 
  the consistent detection of \textit{Parvimonas} and \textit{Fusicatenibacter} 
  across analytical frameworks and filtering approaches underscores 
  their potential as key indicators of chemotherapy response. Also, 
  other bacteria, such as the \textit{Lachnospiraceae NK4A136 group}, 
  \textit{Lachnospira}, \textit{Ruminococcus}, and \textit{Eubacterium} 
  genera, could be considered for further study. Notably, the oral bacteria
  \textit{Parvimonas} could be a validated CRC-associated biomarker, 
  \textit{Fusicatenibacter} emerges as a promising new target for investigation. 


  However, future work should increase the sample size and explore other 
  sequencing technologies, such as Oxford Nanopore (ONT). Applying complementary
  DAA methodologies or machine learning frameworks to validate 
  these microbial signatures will also be essential to elucidate their roles.


 [!] Limitation
 
-   *Limitation*: Small sample size and unbalance dataset. 


A key limitation is the **small sample size**, which leads to sparse
cells for some locations and reduces power, precision and
generalisability. Accordingly, estimates should be interpreted
cautiously, with emphasis on effect sizes and uncertainty intervals
rather than sole reliance on p-values; results warrant external
validation and sensitivity analyses across DAA pipelines. We position
these findings within prior literature [@cite1; @cite2] and outline
implications for patient stratification and future study design.



[\>\>] Future Work


-   *Future work*: Replication in larger trials with Oxford Nanopore
    Sequencing approach to be able to get species and strains specialties. 
    A more balance dataset would be tried to be selected and controls will 
    be included as an additional class to see if there is any huge contrast 
    between each toxicity class and controls. 
    Additionally, previously described bacteria associated with CRC such as 
    **Parvimonas**, **Bacteroides** or **Fusicatenibacter** will be 
    search in more detail to see if there is a correlation 
    not observed in this study. 


# Paper Reference

This report is explained and discussed in the paper entitled: 
"Evaluating DAA methodologies to detect microbiome taxa associated 
with Chemotherapy toxicity in a CRC cohort". Currently under submission.



# NOTES
NOTE (1): The dataset evaluated in this research was a subset of the dataset 
analysed in previous paper such as the one mentioned in NOTE (2) (below).


NOTE (2): The ancombc global function code was adapted from the papers:

Conde-Pérez et al. The multispecies microbial cluster of
Fusobacterium, Parvimonas, Bacteroides and Faecalibacterium as a
precision biomarker for colorectal cancer diagnosis. (2024). Molecular
Oncology. 
DOI: <https://doi.org/10.1002/1878-0261.13604>.

Conde-Pérez, K., Buetas, E., Aja-Macaya, P., Martin-De Arribas, E., Iglesias-Corrás, 
I., Trigo-Tasende, N., Nasser-Ali, M., Estévez, L. S., Rumbo-Feal, S., Otero-Alén, 
B., Noguera, J. F., Concha, Á., Pardiñas-López, S., Carda-Diéguez, M., 
Gómez-Randulfe, I., Martínez-Lago, N., Ladra, S., Aparicio, L. A., Bou, G.,
. . . Poza, M. (2024). Parvimonas micra can translocate from the
subgingival sulcus of the human oral cavity to colorectal adenocarcinoma. 
Molecular Oncology, 18(5), 1143-1173. 
DOI: <https://doi.org/10.1002/1878-0261.13506>.


[^1]: **Legend:** [\*] Conclusion · [!] Limitation · [R] Key Result ·
    [M] Methodological Note · [\>\>] Future Work


# Session Info

```{r session_info}

sessionInfo()


```
